// ==========================================
// File: ./frontend/src/lib/utils.ts
// ==========================================
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}



// ==========================================
// File: ./frontend/src/lib/api-client.ts
// ==========================================
export interface RequestOptions extends RequestInit {
  retries?: number;
  backoff?: number;
}

export class APIError extends Error {
  constructor(
    public message: string,
    public status?: number,
    public statusText?: string,
    public body?: any
  ) {
    super(message);
    this.name = 'APIError';
  }
}

export async function fetchWithRetry(url: string, options: RequestOptions = {}): Promise<any> {
  const { retries = 3, backoff = 1000, ...fetchOptions } = options;
  
  let lastError: Error | null = null;
  
  for (let attempt = 0; attempt < retries; attempt++) {
    try {
      console.log(`[API] Fetching ${url} (Attempt ${attempt + 1}/${retries})`);
      
      const response = await fetch(url, fetchOptions);
      
      if (!response.ok) {
        let errorBody;
        try {
          errorBody = await response.json();
        } catch {
          errorBody = await response.text();
        }
        
        const error = new APIError(
          `Request failed with status ${response.status}`,
          response.status,
          response.statusText,
          errorBody
        );

        // Don't retry on 4xx errors (client errors)
        if (response.status >= 400 && response.status < 500) {
          throw error;
        }
        
        throw error;
      }
      
      return await response.json();
    } catch (err: any) {
      lastError = err;
      console.error(`[API] Attempt ${attempt + 1} failed:`, {
        message: err.message,
        status: err.status,
        body: err.body
      });
      
      if (attempt < retries - 1) {
        const delay = backoff * Math.pow(2, attempt);
        console.log(`[API] Retrying in ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  
  throw lastError;
}



// ==========================================
// File: ./frontend/src/lib/graph-parser.ts
// ==========================================
export function parseGraphData(text: string) {
  const match = text.match(/<graph_data>(.*?)<\/graph_data>/s);
  if (match) {
    try {
      return JSON.parse(match[1]);
    } catch (e) {
      console.error('Failed to parse graph data:', e);
    }
  }
  return null;
}



// ==========================================
// File: ./frontend/src/lib/config.ts
// ==========================================
const isBrowser = typeof window !== 'undefined';
const isElectron = isBrowser && /Electron/i.test(navigator.userAgent);

// In Electron with file://, window.location.hostname is empty. Default to localhost.
const host = (isBrowser && window.location.hostname && window.location.hostname !== '') 
  ? window.location.hostname 
  : 'localhost';

export const BASE_URL = isElectron ? `http://${host}:3001` : '';
export const API_BASE_URL = `${BASE_URL}/api/v1`;



// ==========================================
// File: ./frontend/src/index.css
// ==========================================
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    @apply bg-jb-dark text-jb-text font-sans antialiased overflow-hidden selection:bg-jb-accent/30 tracking-tight;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }
}

@layer components {
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-thin::-webkit-scrollbar { width: 3px; }
  .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
  .scrollbar-thin::-webkit-scrollbar-thumb { @apply bg-white/10 rounded-full hover:bg-white/20 transition-colors; }

  .text-vibrant {
    @apply bg-gradient-to-r from-jb-accent via-jb-purple to-jb-orange bg-clip-text text-transparent;
    filter: drop-shadow(0 0 15px rgba(157, 91, 210, 0.3));
  }

  .glass-panel {
    @apply bg-black/40 backdrop-blur-md border border-white/5 shadow-2xl relative overflow-hidden;
  }

  /* Add a rim-light effect to glass panels */
  .glass-panel::before {
    content: '';
    @apply absolute inset-0 pointer-events-none border border-white/5 rounded-[inherit];
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 40%, transparent 60%, rgba(255,255,255,0.02) 100%);
  }

  @keyframes border-flow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .vibrant-border {
    @apply relative;
  }

  .vibrant-border::after {
    content: "";
    position: absolute;
    inset: -1.5px;
    z-index: -1;
    background: linear-gradient(90deg, #3C71F7, #9D5BD2, #FB923C, #F43F5E, #3C71F7);
    background-size: 300% 100%;
    @apply rounded-[inherit] opacity-40;
    animation: border-flow 8s linear infinite;
    filter: blur(1px);
  }

  /* Chat bubble refinements - more translucent and glass-like */
  .chat-bubble-user {
    @apply bg-gradient-to-br from-jb-accent/90 via-jb-purple/90 to-jb-pink/90 backdrop-blur-xl text-white shadow-2xl shadow-jb-accent/20 border border-white/20;
  }

  .chat-bubble-ai {
    @apply bg-black/60 backdrop-blur-md border border-white/10 shadow-[0_20px_50_rgba(0,0,0,0.3)] text-[15.5px] leading-relaxed;
  }

  .chat-bubble-ai::before {
    content: '';
    @apply absolute inset-0 pointer-events-none rounded-[inherit];
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
  }

  /* Laboratory Report Fidelity: Code Blocks */
  .prose pre {
    @apply bg-[#050508]/80 border border-white/10 rounded-2xl p-0 overflow-hidden relative shadow-inner;
    background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 20px 20px;
  }

  .prose pre::before {
    content: "Source Analysis // Diagnostic Output";
    @apply block w-full bg-white/5 px-4 py-2 text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] border-b border-white/5;
  }

  .prose code {
    @apply font-mono text-jb-accent px-1 py-0.5 bg-white/5 rounded text-[14px];
  }

  .prose pre code {
    @apply block p-6 bg-transparent text-slate-300 leading-relaxed;
  }

  /* Laboratory Report Fidelity: Tables */
  .prose table {
    @apply w-full border-collapse my-8 rounded-xl overflow-hidden border border-white/5;
  }

  .prose thead {
    @apply bg-white/5;
  }

  .prose th {
    @apply px-4 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-white/10;
  }

  .prose td {
    @apply px-4 py-3 text-[13px] text-slate-300 border-b border-white/5;
  }

  .prose tr:last-child td {
    @apply border-b-0;
  }

  .prose tr:hover td {
    @apply bg-white/[0.02] text-white;
  }

  /* Liquid Intelligence Animations - Optimized to Static */
  .liquid-input {
    @apply bg-[#08080a]/90 backdrop-blur-md;
  }

  .neural-scan::after {
    display: none;
  }

  .hud-corner {
    @apply absolute w-4 h-4 border-slate-500/30 pointer-events-none z-50 opacity-40;
  }

  .hud-line {
    @apply absolute bg-slate-500/20 pointer-events-none z-50;
  }
}

/* Linux Compatibility: Disable backdrop filters when GPU is off to prevent black screens */
* {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}


// ==========================================
// File: ./frontend/src/hooks/useDevice.ts
// ==========================================
import { useState, useEffect, useMemo } from 'react';

interface WindowSize {
  width: number;
  height: number;
}

interface DeviceInfo {
  isMobile: boolean;
  isTablet: boolean;
  isDesktop: boolean;
  windowSize: WindowSize;
}

export function useDevice(): DeviceInfo {
  const [state, setState] = useState<DeviceInfo>({
    isMobile: false,
    isTablet: false,
    isDesktop: typeof window !== 'undefined' ? window.innerWidth >= 1024 : true,
    windowSize: {
      width: typeof window !== 'undefined' ? window.innerWidth : 0,
      height: typeof window !== 'undefined' ? window.innerHeight : 0,
    },
  });

  useEffect(() => {
    if (typeof window === 'undefined') return;

    function handleResize() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      
      const mobile = width < 768;
      const tablet = width >= 768 && width < 1024;
      const desktop = width >= 1024;

      setState({
        isMobile: mobile,
        isTablet: tablet,
        isDesktop: desktop,
        windowSize: { width, height }
      });
    }

    window.addEventListener('resize', handleResize);
    handleResize();

    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return useMemo(() => state, [state]);
}



// ==========================================
// File: ./frontend/src/hooks/useSpeechToText.ts
// ==========================================
import { useState, useEffect, useCallback, useRef } from 'react';

interface UseSpeechToTextReturn {
  isListening: boolean;
  transcript: string;
  startListening: () => void;
  stopListening: () => void;
  resetTranscript: () => void;
  browserSupportsSpeechRecognition: boolean;
}

export function useSpeechToText(): UseSpeechToTextReturn {
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState('');
  const recognitionRef = useRef<any>(null);

  const browserSupportsSpeechRecognition = typeof window !== 'undefined' && 
    (window.SpeechRecognition || window.webkitSpeechRecognition);

  useEffect(() => {
    if (!browserSupportsSpeechRecognition) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognitionRef.current = new SpeechRecognition();
    recognitionRef.current.continuous = true;
    recognitionRef.current.interimResults = true;
    recognitionRef.current.lang = 'en-US';

    recognitionRef.current.onresult = (event: any) => {
      let interimTranscript = '';
      let finalTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript;
        } else {
          interimTranscript += event.results[i][0].transcript;
        }
      }

      setTranscript(finalTranscript || interimTranscript);
    };

    recognitionRef.current.onerror = (event: any) => {
      console.error('Speech recognition error', event.error);
      setIsListening(false);
    };

    recognitionRef.current.onend = () => {
      setIsListening(false);
    };

    return () => {
      if (recognitionRef.current) {
        recognitionRef.current.stop();
      }
    };
  }, [browserSupportsSpeechRecognition]);

  const startListening = useCallback(() => {
    if (recognitionRef.current && !isListening) {
      setTranscript('');
      recognitionRef.current.start();
      setIsListening(true);
    }
  }, [isListening]);

  const stopListening = useCallback(() => {
    if (recognitionRef.current && isListening) {
      recognitionRef.current.stop();
      setIsListening(false);
    }
  }, [isListening]);

  const resetTranscript = useCallback(() => {
    setTranscript('');
  }, []);

  return {
    isListening,
    transcript,
    startListening,
    stopListening,
    resetTranscript,
    browserSupportsSpeechRecognition: !!browserSupportsSpeechRecognition,
  };
}

declare global {
  interface Window {
    SpeechRecognition: any;
    webkitSpeechRecognition: any;
  }
}



// ==========================================
// File: ./frontend/src/components/AuraBackground.tsx
// ==========================================
import React, { memo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useAppStore } from '../store/useAppStore';

const AuraBackground: React.FC<{ children: React.ReactNode }> = memo(({ children }) => {
  const { auraMode } = useAppStore();

  return (
    <div className="relative min-h-screen w-full bg-[#030305] overflow-hidden text-jb-text">
      <style>{`
        @keyframes breathe-massive {
          0%, 100% { opacity: 0.7; transform: scale(1) translateZ(0); }
          50% { opacity: 0.9; transform: scale(1.1) translateZ(0); }
        }
        @keyframes breathe-subtle {
          0%, 100% { opacity: 0.5; transform: scale(1.05) translateZ(0); }
          50% { opacity: 0.8; transform: scale(1) translateZ(0); }
        }
        .animate-breathe-massive { animation: breathe-massive 18s infinite ease-in-out; }
        .animate-breathe-subtle { animation: breathe-subtle 22s infinite ease-in-out; }
      `}</style>
      
      {/* ORGANIC AURA: Ultra High Vibrancy Adaptive Synthesis (V4+ Style) */}
      <AnimatePresence>
        {auraMode === 'organic' && (
          <motion.div 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 w-full h-full overflow-hidden pointer-events-none"
          >
            {/* Massive Primary Wash: Ultra Magenta/Pink (Left to Center) */}
            <div
              className="animate-breathe-massive absolute top-[-15%] left-[-25%] w-[130%] h-[130%] rounded-full mix-blend-screen blur-[120px] will-change-transform"
              style={{
                background: 'radial-gradient(circle at 35% 50%, rgba(157, 91, 210, 0.7) 0%, rgba(244, 63, 94, 0.55) 30%, transparent 70%)',
              }}
            />

            {/* Massive Secondary Wash: Electric Neon Blue (Right side) */}
            <div
              className="animate-breathe-subtle absolute top-[-10%] right-[-25%] w-[130%] h-[130%] rounded-full mix-blend-screen blur-[130px] will-change-transform"
              style={{
                background: 'radial-gradient(circle at 65% 50%, rgba(60, 113, 247, 0.7) 0%, rgba(6, 182, 212, 0.45) 40%, transparent 70%)',
              }}
            />

            {/* High-Intensity Core: Vibrant Orange Pop */}
            <div
              className="animate-breathe-massive absolute top-[10%] left-[10%] w-[100%] h-[100%] rounded-full mix-blend-screen blur-[140px] will-change-transform"
              style={{
                background: 'radial-gradient(circle at 40% 40%, rgba(251, 146, 60, 0.45) 0%, rgba(244, 63, 94, 0.25) 50%, transparent 70%)',
              }}
            />

            {/* Bottom-Center Warming: Deep Purple/Blue Base */}
            <div
              className="animate-breathe-subtle absolute bottom-[-20%] left-1/2 -translate-x-1/2 w-[100%] h-[80%] rounded-full mix-blend-screen blur-[120px] will-change-transform"
              style={{
                background: 'radial-gradient(circle at center, rgba(157, 91, 210, 0.4) 0%, rgba(60, 113, 247, 0.3) 60%, transparent 80%)',
              }}
            />

            {/* Global Noise Texture - Increased for V4 feel */}
            <div className="absolute inset-0 opacity-[0.08] pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay"></div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* STATIC AURA: Predictable, fixed resource allocation (Balanced High Vibrancy) */}
      <AnimatePresence>
        {auraMode === 'static' && (
          <motion.div 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 w-full h-full overflow-hidden pointer-events-none"
          >
            <div 
              className="absolute top-[-5%] left-[-5%] w-[70%] h-[70%] rounded-full opacity-40 blur-[120px]"
              style={{ background: 'radial-gradient(circle, #3C71F7 0%, transparent 70%)' }}
            />
            <div 
              className="absolute bottom-[-5%] right-[-5%] w-[70%] h-[70%] rounded-full opacity-40 blur-[120px]"
              style={{ background: 'radial-gradient(circle, #9D5BD2 0%, transparent 70%)' }}
            />
            <div 
              className="absolute top-[20%] right-[10%] w-[50%] h-[50%] rounded-full opacity-20 blur-[100px]"
              style={{ background: 'radial-gradient(circle, #FB923C 0%, transparent 70%)' }}
            />
          </motion.div>
        )}
      </AnimatePresence>

      {/* OFF MODE: Absolute minimum resource usage */}
      {auraMode === 'off' && (
        <div className="absolute inset-0 bg-[#020204]" />
      )}

      <div className="relative z-10 w-full h-[100dvh] flex flex-col">
        {children}
      </div>
    </div>
  );
});

export default AuraBackground;


// ==========================================
// File: ./frontend/src/components/CompareArea.tsx
// ==========================================
import React, { useState } from 'react';
import { useAppStore } from '../store/useAppStore';
import { API_BASE_URL } from '../lib/config';
import { GitCompare, Sparkles, RefreshCw, Bot, AlertCircle } from 'lucide-react';
import { parse } from 'marked';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '../lib/utils';

export const CompareArea = () => {
  const { deviceInfo } = useAppStore();
  const [isComparing, setIsComparing] = useState(false);
  const [results, setResults] = useState<{ gemini: string; ollama: string } | null>(null);
  const [prompt, setPrompt] = useState("");
  const [error, setError] = useState<string | null>(null);

  const handleCompare = async () => {
    if (!prompt.trim()) return;
    setIsComparing(true);
    setResults(null);
    setError(null);

    try {
      const response = await fetch(`${API_BASE_URL}/compare`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: [{ role: 'user', content: prompt }]
        })
      });
      
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Comparison failed.');
      setResults(data);
    } catch (e: any) {
      console.error(e);
      setError(e.message);
    } finally {
      setIsComparing(false);
    }
  };

  return (
    <div className={cn(
      "flex flex-col h-full bg-jb-dark/50 backdrop-blur-3xl border-white/5 overflow-y-auto shadow-2xl transition-all duration-500",
      deviceInfo.isMobile ? "p-4 pt-28 pb-32" : "rounded-tl-2xl border-l border-t p-8"
    )}>
      
      <div className={cn(
        "flex mb-10 gap-6",
        deviceInfo.isMobile ? "flex-col items-start" : "items-center justify-between"
      )}>
        <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-jb-accent/20 rounded-2xl flex items-center justify-center border border-jb-accent/30 shrink-0">
                <GitCompare className="text-jb-accent" size={24} />
            </div>
            <div>
                <h2 className="text-xl md:text-2xl font-black text-white tracking-tight">Model Comparison Lab</h2>
                <p className="text-[9px] md:text-[11px] text-slate-500 font-bold uppercase tracking-widest">Cross-benchmarking Intelligence</p>
            </div>
        </div>

        <div className={cn(
          "flex gap-3 w-full",
          deviceInfo.isMobile ? "flex-col" : "md:w-auto"
        )}>
            <input 
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleCompare()}
              className={cn(
                "bg-white/5 border border-white/10 rounded-xl px-6 py-3 text-sm outline-none focus:border-jb-accent transition-all text-white placeholder:text-slate-600 font-medium",
                deviceInfo.isMobile ? "w-full" : "w-[400px]"
              )}
              placeholder="Enter prompt for benchmarking..."
            />
            <button 
                onClick={handleCompare} 
                disabled={isComparing || !prompt.trim()}
                className="bg-white text-black hover:bg-jb-accent hover:text-white px-8 py-3 rounded-xl font-black text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-20 shadow-xl"
            >
                {isComparing ? <RefreshCw className="animate-spin" size={16}/> : <Sparkles size={16}/>}
                {isComparing ? 'Processing...' : 'Execute Test'}
            </button>
        </div>
      </div>

      {error && (
        <div className="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-sm flex items-center gap-3">
            <AlertCircle size={18} />
            <span className="font-bold">Error:</span> {error}
        </div>
      )}

      <div className={cn(
        "grid gap-8 pb-10",
        deviceInfo.isMobile ? "grid-cols-1" : "grid-cols-2"
      )}>
        
        {/* Gemini Pro Column */}
        <div className="flex flex-col gap-4 bg-white/2 border border-white/5 rounded-[32px] p-6 overflow-hidden min-h-[300px]">
            <div className="flex items-center justify-between border-b border-white/5 pb-4">
                <div className="flex items-center gap-3 text-jb-accent font-black text-xs uppercase tracking-widest">
                    <Bot size={18} /> Gemini 1.5 Pro
                </div>
                <span className="text-[10px] font-bold text-slate-600">CLOUD / GOOGLE</span>
            </div>
            <div className="flex-1 text-slate-300">
                {results ? (
                    <div className="prose prose-invert prose-sm max-w-none leading-relaxed" dangerouslySetInnerHTML={{ __html: parse(results.gemini || '') as string }} />
                ) : (
                    <div className="h-full flex items-center justify-center opacity-20 italic text-sm">Waiting for execution...</div>
                )}
            </div>
        </div>

        {/* Ollama Column */}
        <div className="flex flex-col gap-4 bg-white/2 border border-white/5 rounded-[32px] p-6 overflow-hidden min-h-[300px]">
            <div className="flex items-center justify-between border-b border-white/5 pb-4">
                <div className="flex items-center gap-3 text-jb-orange font-black text-xs uppercase tracking-widest">
                    <Bot size={18} /> Qwen 2.5 (Local)
                </div>
                <span className="text-[10px] font-bold text-slate-600">EDGE / PRIVATE</span>
            </div>
            <div className="flex-1 text-slate-300">
                {results ? (
                    <div className="prose prose-invert prose-sm max-w-none leading-relaxed" dangerouslySetInnerHTML={{ __html: parse(results.ollama || '') as string }} />
                ) : (
                    <div className="h-full flex items-center justify-center opacity-20 italic text-sm">Waiting for execution...</div>
                )}
            </div>
        </div>

      </div>
    </div>
  );
};


// ==========================================
// File: ./frontend/src/components/TitleBar.tsx
// ==========================================
import React, { useEffect, useState } from 'react';
import { Minus, Square, X, Hexagon } from 'lucide-react';
import { cn } from '../lib/utils';

export const TitleBar = () => {
  const [isElectron, setIsElectron] = useState(false);
  const [isMaximized, setIsMaximized] = useState(false);

  useEffect(() => {
    if (typeof window !== 'undefined' && window.electron) {
      setIsElectron(true);
    }
  }, []);

  if (!isElectron) return null;

  return (
    <div className="h-8 bg-black flex items-center justify-between select-none z-[9999] border-b border-white/5">
      {/* Draggable Region */}
      <div className="flex-1 h-full flex items-center pl-4 app-drag-region">
        <div className="flex items-center gap-2 opacity-50">
          <Hexagon size={12} className="text-jb-accent fill-jb-accent/20" />
          <span className="text-[10px] font-mono tracking-widest text-slate-400">SOLVENT AI SUITE</span>
        </div>
      </div>

      {/* Window Controls (No Drag) */}
      <div className="flex h-full app-no-drag">
        <button 
          onClick={() => window.electron?.minimize()}
          className="h-full w-10 flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition-colors"
        >
          <Minus size={14} />
        </button>
        
        <button 
          onClick={() => {
            window.electron?.maximize();
            setIsMaximized(!isMaximized);
          }}
          className="h-full w-10 flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition-colors"
        >
          <Square size={12} />
        </button>
        
        <button 
          onClick={() => window.electron?.close()}
          className="h-full w-10 flex items-center justify-center hover:bg-red-500/80 text-slate-400 hover:text-white transition-colors"
        >
          <X size={14} />
        </button>
      </div>

      <style>{`
        .app-drag-region {
          -webkit-app-region: drag;
        }
        .app-no-drag {
          -webkit-app-region: no-drag;
        }
      `}</style>
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/KnowledgeMap.tsx
// ==========================================
import React, { useEffect, useRef, useState } from 'react';
import * as d3 from 'd3';
import { useAppStore, GraphNode, GraphEdge } from '../store/useAppStore';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '../lib/utils';
import { X, Save } from 'lucide-react';

export const KnowledgeMap = () => {
  const svgRef = useRef<SVGSVGElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const { graphNodes, graphEdges, deviceInfo, setGraphData } = useAppStore();
  const [hoveredNode, setHoveredNode] = useState<GraphNode | null>(null);
  const [selectedEdge, setSelectedEdge] = useState<GraphEdge | null>(null);
  const [edgeData, setEdgeData] = useState("");
  const [dimensions, setDimensions] = useState({ width: 0, height: 0 });

  // Handle Resize for the Knowledge Map container
  useEffect(() => {
    if (!containerRef.current) return;
    
    const observer = new ResizeObserver((entries) => {
      for (let entry of entries) {
        setDimensions({
          width: entry.contentRect.width,
          height: entry.contentRect.height
        });
      }
    });
    
    observer.observe(containerRef.current);
    return () => observer.disconnect();
  }, []);

  useEffect(() => {
    if (!svgRef.current || dimensions.width === 0 || dimensions.height === 0) return;

    const { width, height } = dimensions;

    // Clear previous graph
    d3.select(svgRef.current).selectAll("*").remove();

    const svg = d3.select(svgRef.current)
      .attr("viewBox", [0, 0, width, height])
      .attr("preserveAspectRatio", "xMidYMid meet");

    // Container for zoomable content
    const g = svg.append("g");

    // Zoom behavior
    const zoom = d3.zoom()
      .scaleExtent([0.1, 8])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom as any);

    const simulation = d3.forceSimulation(graphNodes as any)
      .force("link", d3.forceLink(graphEdges).id((d: any) => d.id).distance(100))
      .force("charge", d3.forceManyBody().strength(-300))
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("x", d3.forceX(width / 2).strength(0.1))
      .force("y", d3.forceY(height / 2).strength(0.1));

    // Define arrow markers
    svg.append("defs").selectAll("marker")
      .data(["end"])
      .enter().append("marker")
      .attr("id", String)
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 18)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "rgba(157, 91, 210, 0.4)");

    const link = g.append("g")
      .attr("stroke", "rgba(157, 91, 210, 0.2)")
      .attr("stroke-width", 1.5)
      .selectAll("line")
      .data(graphEdges)
      .join("line")
      .attr("cursor", "pointer")
      .on("mouseover", function() { d3.select(this).attr("stroke", "#3C71F7").attr("stroke-width", 3); })
      .on("mouseout", function() { d3.select(this).attr("stroke", "rgba(157, 91, 210, 0.2)").attr("stroke-width", 1.5); })
      .on("click", (event, d) => {
        event.stopPropagation();
        setSelectedEdge(d);
        setEdgeData(d.data || JSON.stringify({ source: (d.source as any).id, target: (d.target as any).id, status: "pending" }, null, 2));
      });

    const node = g.append("g")
      .selectAll("g")
      .data(graphNodes)
      .join("g")
      .attr("cursor", "grab")
      .call(drag(simulation) as any)
      .on("mouseover", (event, d: any) => {
         d3.select(event.currentTarget).select("circle:nth-child(1)").attr("r", 10).attr("opacity", 0.8);
         setHoveredNode(d);
      })
      .on("mouseout", (event, d) => {
         d3.select(event.currentTarget).select("circle:nth-child(1)").attr("r", 6).attr("opacity", 0.6);
         setHoveredNode(null);
      });

    // Node Outer Glow
    node.append("circle")
      .attr("r", 6)
      .attr("fill", (d: any) => d.id.startsWith('node_') ? "#3C71F7" : "#9D5BD2")
      .attr("filter", "blur(2px)")
      .attr("opacity", 0.6)
      .style("transition", "all 0.3s ease");

    // Node Core
    node.append("circle")
      .attr("r", 4)
      .attr("fill", (d: any) => d.id.startsWith('node_') ? "#3C71F7" : "#9D5BD2")
      .attr("stroke", "white")
      .attr("stroke-width", 1);

    // Labels
    node.append("text")
      .text((d: any) => d.title)
      .attr("x", 10)
      .attr("y", 4)
      .style("font-size", "9px")
      .style("font-weight", "900")
      .style("text-transform", "uppercase")
      .style("letter-spacing", "0.1em")
      .style("fill", "rgba(255, 255, 255, 0.6)")
      .style("pointer-events", "none")
      .style("font-family", "'JetBrains Mono', monospace");

    simulation.on("tick", () => {
      link
        .attr("x1", (d: any) => d.source.x)
        .attr("y1", (d: any) => d.source.y)
        .attr("x2", (d: any) => d.target.x)
        .attr("y2", (d: any) => d.target.y);

      node.attr("transform", (d: any) => `translate(${d.x},${d.y})`);
    });

    function drag(simulation: any) {
      function dragstarted(event: any) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
        d3.select(event.sourceEvent.currentTarget).attr("cursor", "grabbing");
      }
      function dragged(event: any) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }
      function dragended(event: any) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
        d3.select(event.sourceEvent.currentTarget).attr("cursor", "grab");
      }
      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }

    return () => {
      simulation.stop();
    };
  }, [graphNodes, graphEdges, dimensions]);

  const handleSaveEdgeData = () => {
    if (!selectedEdge) return;
    
    // Update the edge data in the store
    const newEdges = graphEdges.map(e => {
        // d3 modifies the source/target objects, so we check IDs
        const sId = (e.source as any).id || e.source;
        const tId = (e.target as any).id || e.target;
        const selSId = (selectedEdge.source as any).id || selectedEdge.source;
        const selTId = (selectedEdge.target as any).id || selectedEdge.target;

        if (sId === selSId && tId === selTId) {
            return { ...e, data: edgeData };
        }
        return e;
    });
    
    setGraphData(graphNodes, newEdges);
    
    // Here we would also notify the Supervisor Agent via IPC
    // window.electron?.send('supervisor-edge-override', { 
    //   source: (selectedEdge.source as any).id, 
    //   target: (selectedEdge.target as any).id, 
    //   data: edgeData 
    // });

    setSelectedEdge(null);
  };

  return (
    <div ref={containerRef} className="w-full h-full relative overflow-hidden pointer-events-auto" onClick={() => setSelectedEdge(null)}>
      <svg 
        ref={svgRef} 
        className="w-full h-full cursor-crosshair block" 
        style={{ touchAction: 'none' }}
        onClick={(e) => e.stopPropagation()}
      />
      
      {/* Empty State */}
      {graphNodes.length === 0 && (
         <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div className="text-center opacity-20">
               <div className="text-[10px] font-black uppercase tracking-[0.5em] text-slate-500">Awaiting Data</div>
            </div>
         </div>
      )}

      {/* Info Card Overlay */}
      <AnimatePresence>
        {hoveredNode && !selectedEdge && (
          <motion.div 
            initial={{ opacity: 0, y: 10, scale: 0.95 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 10, scale: 0.95 }}
            transition={{ duration: 0.2 }}
            className={cn(
              "absolute bg-black/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] z-50 pointer-events-none",
              deviceInfo.isMobile ? "bottom-4 left-4 right-4 p-4" : "bottom-8 left-8 right-8 p-5"
            )}
          >
             <div className="flex items-start justify-between mb-2">
                <h3 className="text-sm font-black text-white uppercase tracking-wider">{hoveredNode.title}</h3>
                <span className="text-[9px] font-mono text-slate-500 bg-white/5 px-1.5 py-0.5 rounded border border-white/5">{hoveredNode.id}</span>
             </div>
             <p className="text-[11px] text-slate-300 leading-relaxed font-medium">
                {hoveredNode.description || "No detailed metrics available for this node."}
             </p>
             <div className="mt-3 pt-3 border-t border-white/10 flex items-center gap-2">
                <div className="w-1.5 h-1.5 rounded-full bg-jb-accent animate-pulse" />
                <span className="text-[9px] font-black text-jb-accent uppercase tracking-widest">Active Node</span>
             </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Edge Editor Modal */}
      <AnimatePresence>
        {selectedEdge && (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            onClick={(e) => e.stopPropagation()}
            className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 bg-slate-900 border border-white/10 rounded-2xl shadow-2xl z-[60] overflow-hidden flex flex-col"
          >
            <div className="h-12 bg-white/5 border-b border-white/5 flex items-center justify-between px-4">
                <div className="flex items-center gap-2 text-slate-300">
                    <span className="text-[10px] font-bold uppercase tracking-wider">Edge Interceptor</span>
                </div>
                <button 
                    onClick={() => setSelectedEdge(null)}
                    className="p-2 hover:bg-white/10 rounded-lg text-slate-500 hover:text-white transition-all"
                >
                    <X size={14} />
                </button>
            </div>
            <div className="p-4 flex-1">
                <textarea 
                    value={edgeData}
                    onChange={(e) => setEdgeData(e.target.value)}
                    className="w-full h-40 bg-black/50 border border-white/10 rounded-xl p-3 text-xs font-mono text-slate-300 outline-none focus:border-jb-accent resize-none"
                    placeholder="Edge communication data..."
                />
            </div>
            <div className="p-4 pt-0">
                <button 
                    onClick={handleSaveEdgeData}
                    className="w-full py-2 bg-jb-accent hover:bg-blue-600 text-white rounded-xl text-xs font-bold uppercase tracking-wider transition-all flex items-center justify-center gap-2"
                >
                    <Save size={12} /> Override & Re-Feed
                </button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};


// ==========================================
// File: ./frontend/src/components/FileManager.jsx
// ==========================================
import React, { useState, useEffect } from 'react';
import { BASE_URL } from '../lib/config';

const FileManager = () => {
  const [files, setFiles] = useState([]);
  const [selectedFile, setSelectedFile] = useState(null);

  // 1. Fetch File List on Load
  useEffect(() => {
    fetchFiles();
  }, []);

  const fetchFiles = async () => {
    try {
      const response = await fetch(`${BASE_URL}/api/files/list`);
      const data = await response.json();
      setFiles(data);
    } catch (error) {
      console.error('Error fetching files:', error);
    }
  };

  // 2. Handle File Selection
  const onFileChange = (event) => {
    setSelectedFile(event.target.files[0]);
  };

  // 3. Upload Function
  const onFileUpload = async () => {
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append('file', selectedFile);

    try {
      await fetch(`${BASE_URL}/api/files/upload`, {
        method: 'POST',
        body: formData,
      });
      alert('File uploaded!');
      setSelectedFile(null);
      fetchFiles(); // Refresh list
    } catch (error) {
      console.error('Error uploading:', error);
    }
  };

  // 4. Download Function
  const downloadFile = (fileName) => {
     window.open(`${BASE_URL}/api/files/download/${fileName}`, '_blank');
  };

  return (
    <div style={{ padding: '20px', border: '1px solid #ccc', marginTop: '20px' }}>
      <h3>ðŸ“‚ File Manager</h3>
      
      {/* Upload Section */}
      <div style={{ marginBottom: '20px' }}>
        <input type="file" onChange={onFileChange} />
        <button onClick={onFileUpload} style={{ marginLeft: '10px' }}>
          Upload
        </button>
      </div>

      {/* File List */}
      <ul style={{ listStyleType: 'none', padding: 0 }}>
        {files.map((file, index) => (
          <li key={index} style={{ padding: '5px 0', borderBottom: '1px solid #eee' }}>
            {file.name} 
            <button 
                onClick={() => downloadFile(file.name)}
                style={{ marginLeft: '10px', fontSize: '0.8rem' }}
            >
                â¬‡ Download
            </button>
          </li>
        ))}
      </ul>
    </div>
  );
};

export default FileManager;



// ==========================================
// File: ./frontend/src/components/WaterfallArea.tsx
// ==========================================
import React, { useState } from 'react';
import { useAppStore } from '../store/useAppStore';
import { Send, Brain, Code, Cpu, Sparkles, Loader2, ChevronRight, ShieldCheck } from 'lucide-react';
import { parse } from 'marked';
import { cn } from '../lib/utils';
import { API_BASE_URL } from '../lib/config';
import { motion, AnimatePresence } from 'framer-motion';

export const WaterfallArea = () => {
  const { deviceInfo, globalProvider } = useAppStore();
  const [input, setInput] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [results, setResult] = useState<{ architect: string, reasoner: string, executor: string, review: string } | null>(null);

  const handleExecute = async () => {
    if (!input.trim() || isProcessing) return;
    setIsProcessing(true);
    setResult(null);

    try {
      const response = await fetch(`${API_BASE_URL}/waterfall`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ prompt: input, globalProvider })
      });
      
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errText}`);
      }
      
      const data = await response.json();
      setResult(data);
    } catch (error: any) {
      console.error('[Waterfall] Execution failed:', error);
      alert(`Waterfall Error: ${error.message}`);
    } finally {
      setIsProcessing(false);
    }
  };

  const Panel = ({ title, icon: Icon, content, color, delay }: any) => (
    <motion.div 
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
      className={cn(
        "flex-1 bg-black/40 backdrop-blur-3xl border border-white/5 rounded-[32px] overflow-hidden flex flex-col shadow-2xl transition-all duration-500",
        deviceInfo.isMobile ? "min-w-full" : "min-w-[350px]"
      )}
    >
      <div className="p-6 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className={cn("w-8 h-8 rounded-lg flex items-center justify-center border", color)}>
            <Icon size={16} />
          </div>
          <span className="text-[10px] font-black uppercase tracking-[0.3em] text-white">{title}</span>
        </div>
        <div className="text-[8px] font-mono text-slate-600">PROT_V1.4</div>
      </div>
      <div className="flex-1 overflow-y-auto p-6 md:p-8 scrollbar-thin">
        <div className="prose prose-invert prose-sm max-w-none prose-pre:bg-black/40" dangerouslySetInnerHTML={{ __html: parse(content || '') as string }} />
      </div>
    </motion.div>
  );

  return (
    <div className="flex flex-col h-full relative overflow-y-auto">
      {/* Header */}
      <div className={cn(
        "flex items-center border-b border-white/5 bg-gradient-to-b from-black/60 to-transparent transition-all duration-500",
        deviceInfo.isMobile ? "px-6 pt-28 pb-6 h-auto" : "px-12 h-24"
      )}>
        <div className="flex flex-col">
          <span className="text-[9px] font-black text-slate-500 uppercase tracking-[0.5em] mb-1">Developer Lab</span>
          <h2 className="text-xl md:text-2xl font-extrabold text-white tracking-tight italic">Neural Waterfall</h2>
        </div>
      </div>

      {/* Main Workspace */}
      <div className={cn(
        "flex-1 flex flex-col gap-8 transition-all duration-500",
        deviceInfo.isMobile ? "p-6" : "p-12"
      )}>
        
        {/* Input Bar */}
        <div className="max-w-4xl w-full mx-auto">
          <div className="vibrant-border rounded-full overflow-hidden shadow-2xl">
            <div className="bg-black/60 backdrop-blur-3xl p-1.5 px-6 flex items-center gap-4">
              <input 
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleExecute();
                  }
                }}
                placeholder="Architect a new feature..."
                className="flex-1 bg-transparent border-none outline-none text-sm font-semibold text-white placeholder:text-slate-800 py-3"
              />
              <button 
                type="button"
                onClick={() => handleExecute()}
                disabled={isProcessing || !input.trim()}
                className="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all disabled:opacity-10 shadow-xl shrink-0"
              >
                {isProcessing ? <Loader2 size={18} className="animate-spin" /> : <Sparkles size={18} />}
              </button>
            </div>
          </div>
        </div>

        {/* Results Grid - Responsive layout */}
        <div className={cn(
          "flex-1 flex gap-6 pb-6",
          deviceInfo.isMobile ? "flex-col overflow-y-visible" : "overflow-x-auto scrollbar-thin"
        )}>
          <AnimatePresence>
            {!results && isProcessing && (
               <div className="flex-1 flex items-center justify-center py-20">
                  <div className="flex flex-col items-center gap-6">
                     <div className="flex gap-2">
                        <motion.div animate={{ scale: [1, 1.5, 1], opacity: [0.3, 1, 0.3] }} transition={{ repeat: Infinity, duration: 1 }} className="w-3 h-3 bg-jb-accent rounded-full" />
                        <motion.div animate={{ scale: [1, 1.5, 1], opacity: [0.3, 1, 0.3] }} transition={{ repeat: Infinity, duration: 1, delay: 0.2 }} className="w-3 h-3 bg-jb-purple rounded-full" />
                        <motion.div animate={{ scale: [1, 1.5, 1], opacity: [0.3, 1, 0.3] }} transition={{ repeat: Infinity, duration: 1, delay: 0.4 }} className="w-3 h-3 bg-jb-orange rounded-full" />
                     </div>
                     <span className="text-[10px] font-black uppercase tracking-[0.5em] text-slate-500">Executing Pipeline...</span>
                  </div>
               </div>
            )}

            {results && (
              <>
                <Panel 
                  title="Architect" 
                  icon={Brain} 
                  content={results.architect} 
                  color="text-jb-accent border-jb-accent/20"
                  delay={0.1}
                />
                <Panel 
                  title="Reasoner" 
                  icon={Cpu} 
                  content={results.reasoner} 
                  color="text-jb-purple border-jb-purple/20"
                  delay={0.2}
                />
                <Panel 
                  title="Executor" 
                  icon={Code} 
                  content={results.executor} 
                  color="text-jb-orange border-jb-orange/20"
                  delay={0.3}
                />
                <Panel 
                  title="Senior Review" 
                  icon={ShieldCheck} 
                  content={results.review} 
                  color="text-green-500 border-green-500/20"
                  delay={0.4}
                />
              </>
            )}
          </AnimatePresence>
        </div>
      </div>
    </div>
  );
};


// ==========================================
// File: ./frontend/src/components/DebateArea.tsx
// ==========================================
import React, { useState } from 'react';
import { useAppStore } from '../store/useAppStore';
import { API_BASE_URL } from '../lib/config';
import { Swords, Bot, Sparkles, RefreshCw, AlertCircle } from 'lucide-react';
import { cn } from '../lib/utils';
import { parse } from 'marked';
import { motion, AnimatePresence } from 'framer-motion';

export const DebateArea = () => {
  const { deviceInfo } = useAppStore();
  const [isDebating, setIsDebating] = useState(false);
  const [leftHistory, setLeftHistory] = useState<any[]>([]);
  const [rightHistory, setRightHistory] = useState<any[]>([]);
  const [topic, setTopic] = useState("The future of Artificial Intelligence");
  const [error, setError] = useState<string | null>(null);

  const callModel = async (provider: string, model: string, history: any[], prompt: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
           provider,
           model,
           messages: [...history, { role: 'user', content: prompt }]
        })
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Agent failed.');
      return data.response;
    } catch (err: any) {
      throw new Error(err.message || 'Model unreachable.');
    }
  };

  const handleStartDebate = async () => {
     if (!topic.trim()) return;
     setIsDebating(true);
     setError(null);
     setLeftHistory([]);
     setRightHistory([]);

     try {
         // Round 1: Gemini Proposes
         const leftResponse = await callModel('gemini', 'gemini-1.5-flash', [], `Present a strong argument for: "${topic}". Be concise and provocative.`);
         setLeftHistory([{ agent: 'Gemini Pro', content: leftResponse }]);
         
         // Round 1: Ollama Rebuts
         const rightResponse = await callModel('ollama', 'qwen2.5:3b', [], `Critique this argument aggressively: "${leftResponse}". Defend the opposing view.`);
         setRightHistory([{ agent: 'Qwen 2.5', content: rightResponse }]);
         
         // Round 2: Gemini Counter-Rebuts
         const leftRebuttal = await callModel('gemini', 'gemini-1.5-flash', [], `Your argument was critiqued: "${rightResponse}". Counter this critique effectively.`);
         setLeftHistory(prev => [...prev, { agent: 'Gemini Pro', content: leftRebuttal }]);

     } catch (e: any) {
         console.error(e);
         setError(e.message);
     } finally {
         setIsDebating(false);
     }
  };

  return (
    <div className={cn(
      "flex flex-col h-full bg-jb-dark/50 backdrop-blur-3xl border-white/5 overflow-y-auto shadow-2xl transition-all duration-500",
      deviceInfo.isMobile ? "p-4 pt-28 pb-32" : "rounded-tl-2xl border-l border-t p-8"
    )}>
      
      <div className={cn(
        "flex mb-10 gap-6",
        deviceInfo.isMobile ? "flex-col items-start" : "items-center justify-between"
      )}>
        <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-jb-pink/20 rounded-2xl flex items-center justify-center border border-jb-pink/30 shrink-0">
                <Swords className="text-jb-pink" size={24} />
            </div>
            <div>
                <h2 className="text-xl md:text-2xl font-black text-white tracking-tight">Adversarial Debate Lab</h2>
                <p className="text-[9px] md:text-[11px] text-slate-500 font-bold uppercase tracking-widest">Cross-Model Dialectical Synthesis</p>
            </div>
        </div>

        <div className={cn(
          "flex gap-3 w-full",
          deviceInfo.isMobile ? "flex-col" : "md:w-auto"
        )}>
            <input 
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
              className={cn(
                "bg-white/5 border border-white/10 rounded-xl px-6 py-3 text-sm outline-none focus:border-jb-pink transition-all text-white placeholder:text-slate-600 font-medium",
                deviceInfo.isMobile ? "w-full" : "w-[400px]"
              )}
              placeholder="Enter debate topic..."
            />
            <button 
                onClick={handleStartDebate} 
                disabled={isDebating}
                className="bg-jb-pink text-white hover:bg-rose-600 px-8 py-3 rounded-xl font-black text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-20 shadow-xl"
            >
                {isDebating ? <RefreshCw className="animate-spin" size={16}/> : <Sparkles size={16}/>}
                {isDebating ? 'Simulating...' : 'Ignite Debate'}
            </button>
        </div>
      </div>

      {error && (
        <div className="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-sm flex items-center gap-3">
            <AlertCircle size={18} />
            <span className="font-bold">Error:</span> {error}
        </div>
      )}

      <div className={cn(
        "grid gap-8 pb-10",
        deviceInfo.isMobile ? "grid-cols-1" : "grid-cols-2"
      )}>
        
        {/* Gemini Column */}
        <div className="flex flex-col gap-4 bg-white/2 border border-white/5 rounded-[32px] p-6 overflow-hidden min-h-[300px]">
            <div className="flex items-center justify-between border-b border-white/5 pb-4">
                <div className="flex items-center gap-3 text-jb-accent font-black text-xs uppercase tracking-widest">
                    <Bot size={18} /> Gemini Pro
                </div>
                <div className="w-2 h-2 rounded-full bg-jb-accent animate-pulse" />
            </div>
            <div className="flex-1 space-y-6">
                <AnimatePresence>
                  {leftHistory.map((m, i) => (
                    <motion.div 
                      key={i} 
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="bg-jb-accent/5 border border-jb-accent/20 p-5 rounded-2xl text-sm text-slate-200 leading-relaxed shadow-lg"
                    >
                        <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: parse(m.content || '') as string }} />
                    </motion.div>
                  ))}
                </AnimatePresence>
            </div>
        </div>

        {/* Ollama Column */}
        <div className="flex flex-col gap-4 bg-white/2 border border-white/5 rounded-[32px] p-6 overflow-hidden min-h-[300px]">
            <div className="flex items-center justify-between border-b border-white/5 pb-4">
                <div className="flex items-center gap-3 text-jb-orange font-black text-xs uppercase tracking-widest">
                    <Bot size={18} /> Qwen 2.5
                </div>
                <div className="w-2 h-2 rounded-full bg-jb-orange animate-pulse" />
            </div>
             <div className="flex-1 space-y-6">
                <AnimatePresence>
                  {rightHistory.map((m, i) => (
                    <motion.div 
                      key={i} 
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="bg-jb-orange/5 border border-jb-orange/20 p-5 rounded-2xl text-sm text-slate-200 leading-relaxed shadow-lg"
                    >
                         <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: parse(m.content || '') as string }} />
                    </motion.div>
                  ))}
                </AnimatePresence>
            </div>
        </div>

      </div>
    </div>
  );
};


// ==========================================
// File: ./frontend/src/components/ChatInput.tsx
// ==========================================
import React, { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Send, Image as ImageIcon, Mic, MicOff, X, Loader2, Sparkles, Paperclip, FileText, ChevronUp, ChevronDown } from 'lucide-react';
import { useAppStore } from '../store/useAppStore';
import { useSpeechToText } from '../hooks/useSpeechToText';
import { cn } from '../lib/utils';

export const ChatInput = () => {
  const { sendMessage, generateImageAction, isProcessing, addMessage, deviceInfo } = useAppStore();
  const [input, setInput] = useState('');
  const [uploadMode, setUploadMode] = useState<'image' | 'file'>('image');
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [attachedFile, setAttachedFile] = useState<{ name: string; url: string; originalName: string; content?: string } | null>(null);
  const [isUploading, setIsUploading] = useState(false);

  const { isListening, transcript, startListening, stopListening, browserSupportsSpeechRecognition } = useSpeechToText();

  const imageInputRef = useRef<HTMLInputElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (transcript) {
      setInput(transcript);
    }
  }, [transcript]);

  const handleSend = async () => {
    if ((!input.trim() && !selectedImage && !attachedFile) || isProcessing) return;

    if (isListening) stopListening();

    let finalContent = input;
    if (attachedFile) {
      if (attachedFile.content) {
        finalContent += `\n\n[System: The user attached a file named "${attachedFile.originalName}". Here is the content:]\n\n${attachedFile.content}`;
      } else {
        finalContent += `\n\n[System: User attached file: "${attachedFile.originalName}" available at ${attachedFile.url}]`;
      }
    }

    await sendMessage(finalContent, selectedImage);
    setInput('');
    setSelectedImage(null);
    setAttachedFile(null);
  };

  const toggleListening = () => {
    if (isListening) {
      stopListening();
    } else {
      startListening();
    }
  };

  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setSelectedImage(reader.result as string);
      reader.readAsDataURL(file);
    }
    e.target.value = '';
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    const formData = new FormData();
    formData.append('file', file);

    try {
      const { BASE_URL } = await import('../lib/config');
      const response = await fetch(`${BASE_URL}/api/files/upload`, {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();
      
      if (data.filename) {
        setAttachedFile({
          name: data.filename,
          originalName: file.name,
          url: `${BASE_URL}/files/${data.filename}`,
          content: data.content
        });
      }
    } catch (error) {
      console.error('File upload failed:', error);
      addMessage({ role: 'assistant', content: 'Error: Could not upload file.' });
    } finally {
      setIsUploading(false);
      e.target.value = '';
    }
  };

  return (
    <div className={cn(
      "absolute bottom-0 left-0 right-0 z-20",
      deviceInfo.isMobile ? "p-4 pb-12" : "p-4"
    )}>
      <div className="max-w-4xl mx-auto">
        <AnimatePresence>
          {(selectedImage || attachedFile) && (
            <motion.div 
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 10 }}
              className="mb-3 flex items-center gap-3 px-2"
            >
              {selectedImage && (
                <div className="relative group">
                  <img src={selectedImage} className="h-16 w-16 object-cover rounded-xl border border-white/20 shadow-lg" />
                  <button onClick={() => setSelectedImage(null)} className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <X size={12} />
                  </button>
                </div>
              )}
              {attachedFile && (
                <div className="relative group bg-white/10 backdrop-blur-md border border-white/10 p-3 pr-8 rounded-xl flex items-center gap-3 shadow-lg">
                  <div className="p-2 bg-jb-accent/20 rounded-lg text-jb-accent">
                    <FileText size={20} />
                  </div>
                  <div className="flex flex-col">
                    <span className="text-xs font-bold text-white max-w-[150px] truncate">{attachedFile.originalName}</span>
                    <span className="text-[9px] font-mono text-slate-400">UPLOADED</span>
                  </div>
                  <button onClick={() => setAttachedFile(null)} className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <X size={12} />
                  </button>
                </div>
              )}
            </motion.div>
          )}
        </AnimatePresence>

        <motion.div 
          whileFocus-within={{ scale: 1.002, y: -1 }}
          className="vibrant-border rounded-[28px] relative group shadow-[0_20px_50px_rgba(0,0,0,0.5)]"
        >
          {/* Subtle Corner Accents */}
          <div className="absolute top-0 left-0 w-8 h-8 border-t border-l border-white/20 rounded-tl-[28px] pointer-events-none group-focus-within:border-jb-accent/40 z-20" />
          <div className="absolute bottom-0 right-0 w-8 h-8 border-b border-r border-white/20 rounded-br-[28px] pointer-events-none group-focus-within:border-jb-purple/40 z-20" />

          <div className={cn(
            "liquid-input backdrop-blur-3xl flex items-center gap-2 border border-white/10 relative z-10 rounded-[28px] overflow-hidden",
            deviceInfo.isMobile ? "p-1 px-3" : "p-1.5 px-6"
          )}>
            <div className="flex items-center gap-0.5 relative">
              <button 
                onClick={() => uploadMode === 'image' ? imageInputRef.current?.click() : fileInputRef.current?.click()}
                className={cn(
                  "text-slate-500 hover:text-jb-accent transition-all hover:bg-white/5 rounded-xl rounded-r-none group flex items-center justify-center",
                  deviceInfo.isMobile ? "p-2 w-10" : "p-3 w-12"
                )}
              >
                {isUploading ? <Loader2 size={18} className="animate-spin text-jb-accent" /> : (uploadMode === 'image' ? <ImageIcon size={deviceInfo.isMobile ? 16 : 18} /> : <Paperclip size={deviceInfo.isMobile ? 16 : 18} />)}
              </button>
              <button onClick={() => setUploadMode(prev => prev === 'image' ? 'file' : 'image')} className="p-1 h-full flex flex-col items-center justify-center text-slate-600 hover:text-white bg-white/5 hover:bg-white/10 rounded-r-xl border-l border-white/5 w-5">
                {uploadMode === 'image' ? <ChevronDown size={10} /> : <ChevronUp size={10} />}
              </button>
            </div>

            <div className="w-[1px] h-6 bg-white/5 mx-1" />

            <button 
              onClick={() => { generateImageAction(input); setInput(''); }} 
              disabled={!input.trim() || isProcessing} 
              className={cn(
                "text-slate-500 hover:text-jb-purple transition-all hover:bg-white/5 rounded-xl disabled:opacity-10 group",
                deviceInfo.isMobile ? "p-2" : "p-3"
              )}
            >
              <Sparkles size={deviceInfo.isMobile ? 16 : 18} />
            </button>

            <div className="flex-1 relative">
              <textarea 
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                placeholder={uploadMode === 'image' ? "Message..." : "Attach..."}
                className={cn(
                  "w-full bg-transparent border-none outline-none font-semibold text-white placeholder:text-slate-700 resize-none h-[44px] scrollbar-hide",
                  deviceInfo.isMobile ? "text-sm py-3 px-1" : "text-[15px] py-3 px-2"
                )}
                rows={1}
              />
              {!input && !deviceInfo.isMobile && (
                <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">
                  <span className="text-[8px] font-black text-slate-700 uppercase tracking-[0.2em] border border-white/5 px-1.5 py-0.5 rounded">System Ready</span>
                </div>
              )}
            </div>

            <div className="w-[1px] h-6 bg-white/5 mx-1" />

            <div className="flex items-center gap-2">
              {browserSupportsSpeechRecognition && (
                <button 
                  onClick={toggleListening}
                  className={cn(
                    "transition-all rounded-xl relative",
                    isListening ? "text-red-500 bg-red-500/10 shadow-[0_0_15px_rgba(239,68,68,0.2)]" : "text-slate-500 hover:text-white hover:bg-white/5",
                    deviceInfo.isMobile ? "p-2" : "p-3"
                  )}
                >
                  {isListening ? (
                    <>
                      <MicOff size={deviceInfo.isMobile ? 16 : 18} />
                      <span className="absolute -top-1 -right-1 flex h-2 w-2">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                      </span>
                    </>
                  ) : <Mic size={deviceInfo.isMobile ? 16 : 18} />}
                </button>
              )}
              <motion.button 
                whileHover={{ scale: 1.02, boxShadow: '0 0 15px rgba(60,113,247,0.3)' }}
                whileTap={{ scale: 0.98 }}
                onClick={handleSend}
                disabled={(!input.trim() && !selectedImage && !attachedFile) || isProcessing}
                className={cn(
                  "bg-white text-black rounded-2xl flex items-center justify-center disabled:opacity-5 transition-all shadow-xl font-bold group",
                  deviceInfo.isMobile ? "w-9 h-9" : "w-11 h-11"
                )}
              >
                <Send size={deviceInfo.isMobile ? 16 : 18} />
              </motion.button>
            </div>
          </div>
        </motion.div>
      </div>

      {/* Hidden Inputs */}
      <input 
        type="file" 
        ref={imageInputRef} 
        onChange={handleImageSelect} 
        accept="image/*" 
        className="hidden" 
      />
      <input 
        type="file" 
        ref={fileInputRef} 
        onChange={handleFileSelect} 
        className="hidden" 
      />
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/MessageItem.tsx
// ==========================================
import React from 'react';
import { motion } from 'framer-motion';
import { Download } from 'lucide-react';
import { parse } from 'marked';
import { cn } from '../lib/utils';
import { Message } from '../store/useAppStore';

interface MessageItemProps {
  message: Message;
  modelName: string;
  isUser: boolean;
  time: string;
  onDownloadImage: (url: string, filename: string) => void;
}

export const MessageItem: React.FC<MessageItemProps> = ({ 
  message, modelName, isUser, time, onDownloadImage 
}) => {
  return (
    <motion.div 
      initial={{ opacity: 0, y: 15 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4 }}
      className={cn("flex flex-col gap-3 max-w-4xl mx-auto w-full", isUser ? "items-end" : "items-start")}
    >
      <div className={cn(
        "group relative p-5 transition-all duration-500",
        isUser ? "chat-bubble-user rounded-tr-none" : "chat-bubble-ai rounded-tl-none",
        "sm:rounded-[40px] rounded-[24px]"
      )}>
        {message.image && (
          <div className="mb-6 relative group/img overflow-hidden rounded-2xl border border-white/10 shadow-2xl max-w-full">
             <img src={message.image} className="max-w-full w-auto" alt="User Upload" />
             <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 group-hover/img:opacity-100 transition-opacity" />
          </div>
        )}
        
        {message.isGeneratedImage && message.imageUrl && (
          <div className="mb-6 relative group/img overflow-hidden rounded-2xl border border-white/10 shadow-2xl bg-black/20 p-2 max-w-full">
            <img src={message.imageUrl} className="max-w-full w-auto rounded-xl" alt="Generated" />
            <button 
              onClick={() => onDownloadImage(message.imageUrl!, `image-${Date.now()}.png`)}
              className="absolute bottom-6 right-6 p-3 bg-black/60 backdrop-blur-xl text-white rounded-2xl opacity-0 group-hover/img:opacity-100 transition-all hover:bg-jb-purple hover:scale-110 shadow-2xl"
            >
              <Download size={18} />
            </button>
          </div>
        )}

        <div className="prose prose-invert prose-sm max-w-none font-medium" 
          dangerouslySetInnerHTML={{ 
            __html: parse(message.content.replace(/<graph_data>[\s\S]*?<\/graph_data>/g, '')) as string 
          }} 
        />
      </div>
      
      <div className={cn("flex items-center gap-4 px-6", isUser ? "flex-row-reverse" : "flex-row")}>
         <span className={cn(
           "text-[9px] font-black uppercase tracking-[0.25em] py-1 px-2.5 rounded-lg border",
           isUser ? "text-jb-accent border-jb-accent/30 bg-jb-accent/5" : "text-slate-400 border-white/10 bg-white/5"
         )}>
            {modelName}
         </span>
         <span className="text-[9px] font-bold text-slate-700 uppercase tracking-widest">{time}</span>
      </div>
    </motion.div>
  );
};



// ==========================================
// File: ./frontend/src/components/ChatArea.tsx
// ==========================================
import React, { Suspense, useEffect } from 'react';
import { useAppStore } from '../store/useAppStore';
import { useDevice } from '../hooks/useDevice';
import AuraBackground from './AuraBackground';
import { Navigation } from './Navigation';
import { ChatView } from './ChatView';
import { FloatingNotepad } from './FloatingNotepad';
import { X, Network, Loader2 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { cn } from '../lib/utils';

import { TitleBar } from './TitleBar';

// Lazy Load Heavy Components
const DebateArea = React.lazy(() => import('./DebateArea').then(m => ({ default: m.DebateArea })));
const CompareArea = React.lazy(() => import('./CompareArea').then(m => ({ default: m.CompareArea })));
const CollaborateArea = React.lazy(() => import('./CollaborateArea').then(m => ({ default: m.CollaborateArea })));
const WaterfallArea = React.lazy(() => import('./WaterfallArea').then(m => ({ default: m.WaterfallArea })));
const CodingArea = React.lazy(() => import('./CodingArea').then(m => ({ default: m.CodingArea })));
const KnowledgeMap = React.lazy(() => import('./KnowledgeMap').then(m => ({ default: m.KnowledgeMap })));
const SettingsModal = React.lazy(() => import('./SettingsModal').then(m => ({ default: m.SettingsModal })));

const LoadingFallback = () => (
  <div className="flex items-center justify-center w-full h-full text-jb-accent animate-pulse">
    <Loader2 size={32} className="animate-spin" />
  </div>
);

export const ChatArea = () => {
  const { currentMode, graphNodes, graphEdges, showKnowledgeMap, setShowKnowledgeMap, setDeviceInfo, deviceInfo, setSupervisorInsight, supervisorInsight } = useAppStore();
  const device = useDevice();

  useEffect(() => {
    // Only update if dimensions or device type actually changed
    if (
      device.isMobile !== deviceInfo.isMobile ||
      device.isTablet !== deviceInfo.isTablet ||
      device.windowSize.width !== deviceInfo.windowSize.width ||
      device.windowSize.height !== deviceInfo.windowSize.height
    ) {
      setDeviceInfo(device);
    }
  }, [device, setDeviceInfo, deviceInfo]);

  // Listen for Supervisor Nudges
  useEffect(() => {
    if (window.electron?.onSupervisorNudge) {
      const cleanup = window.electron.onSupervisorNudge((nudge: any) => {
        setSupervisorInsight(nudge.message);
        // Auto-clear after 10s
        setTimeout(() => setSupervisorInsight(null), 10000);
      });
      return cleanup;
    }
  }, []);

  const renderContent = () => {
    switch (currentMode) {
      case 'debate':
        return <DebateArea />;
      case 'compare':
        return <CompareArea />;
      case 'collaborate':
        return <CollaborateArea />;
      case 'waterfall':
        return <WaterfallArea />;
      case 'coding':
        return <CodingArea />;
      default:
        return <ChatView />;
    }
  };

  return (
    <AuraBackground>
      <div className="flex flex-col h-[100dvh] w-screen overflow-hidden font-sans">
        <TitleBar />
        <div className="flex flex-1 overflow-hidden relative">
          <Navigation />
          <AnimatePresence>
             <Suspense fallback={null}>
                <SettingsModal />
             </Suspense>
          </AnimatePresence>
  
          <div className="flex-1 flex h-full overflow-hidden relative">
             
             {/* Main Center Area */}
             <div className="flex-1 h-full flex flex-col border-r border-white/5 relative z-10">
                <Suspense fallback={<LoadingFallback />}>
                   {renderContent()}
                </Suspense>
                
                {!showKnowledgeMap && (
                   <motion.button
                     initial={{ opacity: 0, x: 20 }}
                     animate={{ opacity: 1, x: 0 }}
                     onClick={() => setShowKnowledgeMap(true)}
                     className="absolute top-6 right-6 z-50 p-3 bg-black/60 backdrop-blur-md border border-white/10 rounded-xl text-jb-accent hover:bg-white/5 transition-all shadow-xl group"
                     title="Open Knowledge Map"
                   >
                      <Network size={20} className="group-hover:rotate-180 transition-transform duration-700" />
                   </motion.button>
                )}

                {/* Supervisor Nudge Toast */}
                <AnimatePresence>
                  {supervisorInsight && (
                    <motion.div 
                      initial={{ opacity: 0, y: 50, x: "-50%" }}
                      animate={{ opacity: 1, y: 0, x: "-50%" }}
                      exit={{ opacity: 0, y: 20, x: "-50%" }}
                      className="absolute bottom-8 left-1/2 z-50 bg-jb-purple/10 border border-jb-purple/20 backdrop-blur-xl px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 max-w-lg"
                    >
                       <div className="w-8 h-8 rounded-full bg-jb-purple/20 flex items-center justify-center shrink-0">
                          <Network size={16} className="text-jb-purple" />
                       </div>
                       <div>
                          <p className="text-[10px] font-black uppercase tracking-widest text-jb-purple mb-1">Supervisor Insight</p>
                          <p className="text-xs text-white font-medium">{supervisorInsight}</p>
                       </div>
                       <button onClick={() => setSupervisorInsight(null)} className="ml-2 text-slate-400 hover:text-white"><X size={14} /></button>
                    </motion.div>
                  )}
                </AnimatePresence>
             </div>
  
             {/* Knowledge Map Panel */}
             <AnimatePresence>
               {showKnowledgeMap && (
                 <motion.div 
                   initial={{ x: deviceInfo.isMobile ? "100%" : 450, opacity: 0 }}
                   animate={{ x: 0, opacity: 1 }}
                   exit={{ x: deviceInfo.isMobile ? "100%" : 450, opacity: 0 }}
                   transition={{ type: "spring", stiffness: 300, damping: 30 }}
                   className={cn(
                     "h-full bg-slate-950/95 backdrop-blur-3xl flex flex-col relative z-[60] border-l border-white/5 shadow-2xl",
                     deviceInfo.isMobile ? "fixed inset-0 w-full" : "w-[450px]"
                   )}
                 >
                    <div className="h-16 flex items-center justify-between px-6 border-b border-white/5 bg-white/2">
                       <div className="flex items-center gap-2">
                          <Network size={14} className="text-jb-purple" />
                          <span className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Knowledge Map</span>
                       </div>
                       <button 
                         onClick={() => setShowKnowledgeMap(false)}
                         className="text-slate-600 hover:text-white transition-colors p-1 hover:bg-white/5 rounded-md"
                       >
                          <X size={14} />
                       </button>
                    </div>
                    
                    <div className="flex-1 flex flex-col relative overflow-hidden">
                       <div className="absolute inset-0 pointer-events-none">
                          {/* Neural Pulse Background */}
                          <motion.div 
                             animate={{ 
                                scale: [1, 1.2, 1],
                                opacity: [0.05, 0.1, 0.05]
                             }}
                             transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                             className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-jb-purple rounded-full blur-[120px]" 
                          />
                       </div>
  
                       {/* The Interactive Map */}
                       <div className="flex-1 relative z-10">
                          <Suspense fallback={<LoadingFallback />}>
                             <KnowledgeMap />
                          </Suspense>
                       </div>
  
                       {/* Stats Overlay */}
                       <div className="absolute bottom-0 left-0 right-0 p-8 pt-20 bg-gradient-to-t from-black/60 to-transparent pointer-events-none">
                          <div className="flex items-center justify-between text-[11px] font-black text-slate-500 uppercase tracking-[0.3em]">
                             <div className="flex flex-col gap-1">
                                <span className="text-jb-accent">{graphNodes.length.toString().padStart(2, '0')} Nodes</span>
                                <span className="opacity-40">Mapped</span>
                             </div>
                             <div className="flex flex-col gap-1 items-end text-right">
                                <span className="text-jb-orange">{graphEdges.length.toString().padStart(2, '0')} Edges</span>
                                <span className="opacity-40">Linked</span>
                             </div>
                          </div>
                       </div>
                    </div>
                 </motion.div>
               )}
             </AnimatePresence>
  
          </div>
        </div>
      </div>
      <FloatingNotepad />
    </AuraBackground>
  );
};



// ==========================================
// File: ./frontend/src/components/Navigation.tsx
// ==========================================
import React, { useState } from 'react';
import { useAppStore } from '../store/useAppStore';
import { 
  MessageSquare, Globe, Brain, Swords, GitCompare, 
  Users, FlaskConical, ScanEye, Search, BookOpen, LineChart, ChevronRight, Settings, Code, Menu, X as CloseIcon,
  ChevronsLeft, ChevronsRight, PanelLeftClose, PanelLeftOpen
} from 'lucide-react';
import { cn } from '../lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import { SystemStatus } from './SystemStatus';

export const Navigation = () => {
  const { currentMode, setCurrentMode, setSettingsOpen, deviceInfo } = useAppStore();
  const [isOpen, setIsOpen] = useState(false); // Mobile drawer state
  const [isCollapsed, setIsCollapsed] = useState(false); // Desktop sidebar collapse state

  const isMobile = deviceInfo.isMobile;

  const NavItem = ({ mode, icon: Icon, label, color }: any) => {
    const isActive = currentMode === mode;
    return (
      <motion.button
        whileHover={{ x: isCollapsed ? 0 : 4, backgroundColor: 'rgba(255, 255, 255, 0.05)' }}
        whileTap={{ scale: 0.98 }}
        onClick={() => {
          setCurrentMode(mode);
          if (isMobile) setIsOpen(false);
        }}
        className={cn(
          "w-full flex items-center transition-all duration-300 group relative overflow-hidden",
          isActive 
            ? "bg-white/5 text-white shadow-[inset_0_0_20px_rgba(255,255,255,0.02)]" 
            : "text-slate-500 hover:text-slate-200",
          isCollapsed ? "justify-center px-0 py-3 rounded-xl" : "justify-between px-4 py-3 rounded-2xl"
        )}
        title={isCollapsed ? label : undefined}
      >
        {isActive && !isCollapsed && (
          <motion.div 
            layoutId="navGlow"
            className="absolute left-0 top-0 bottom-0 w-[2px] bg-gradient-to-b from-transparent via-white/40 to-transparent"
          />
        )}
        
        <div className={cn("flex items-center relative z-10", isCollapsed ? "justify-center" : "gap-3")}>
          <Icon size={18} className={cn("transition-all duration-500", isActive ? (color || "text-jb-accent shadow-[0_0_10px_rgba(60,113,247,0.5)]") : "group-hover:text-slate-300")} />
          {!isCollapsed && (
             <span className={cn("font-bold text-[13px] tracking-tight transition-colors duration-300 whitespace-nowrap", isActive ? "text-white" : "font-semibold")}>{label}</span>
          )}
        </div>
        
        {isActive && !isCollapsed && (
          <motion.div layoutId="navIndicator" className="flex items-center relative z-10">
             <ChevronRight size={12} className="text-white/30" />
          </motion.div>
        )}
      </motion.button>
    );
  };

  const navContent = (
    <div className={cn(
      "h-full flex flex-col relative z-20 transition-all duration-300",
      isMobile ? "w-full" : (isCollapsed ? "w-20" : "w-72")
    )}>
      <div className={cn(
        "flex items-center justify-between",
        isCollapsed ? "p-4 flex-col gap-6" : "p-8 pb-10"
      )}>
        <div className={cn("flex items-center group cursor-pointer", isCollapsed ? "justify-center" : "gap-4")}>
           <motion.div 
             whileHover={{ scale: 1.1, rotate: -5 }}
             className={cn("relative flex items-center justify-center", isCollapsed ? "w-10 h-10" : "w-12 h-12")}
           >
              <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_15px_rgba(244,63,94,0.5)]">
                 <defs>
                    <linearGradient id="beakerFluid" x1="0%" y1="0%" x2="0%" y2="100%">
                       <stop offset="0%" stopColor="#FB923C" />
                       <stop offset="50%" stopColor="#F43F5E" />
                       <stop offset="100%" stopColor="#9D5BD2" />
                    </linearGradient>
                    <filter id="glow">
                       <feGaussianBlur stdDeviation="2" result="blur" />
                       <feComposite in="SourceGraphic" in2="blur" operator="over" />
                    </filter>
                 </defs>
                 <path d="M38 20 L38 45 L18 82 Q15 88 22 88 L78 88 Q85 88 82 82 L62 45 L62 20 Z" fill="none" stroke="white" strokeWidth="2" strokeOpacity="0.15" />
                 <motion.path 
                    d="M40 48 L25 80 Q23 83 27 83 L73 83 Q77 83 75 80 L60 48 Q58 45 50 45 Q42 45 40 48 Z" fill="url(#beakerFluid)" fillOpacity="0.9" filter="url(#glow)" />
                 <path d="M32 20 L68 20" stroke="white" strokeWidth="2" strokeOpacity="0.4" strokeLinecap="round" />
              </svg>
           </motion.div>
           {!isCollapsed && (
              <div className="flex flex-col">
                  <h1 className="text-[26px] font-[800] tracking-[-0.04em] text-white leading-none">Solvent</h1>
                  <span className="text-[9px] font-black text-slate-600 uppercase tracking-[0.45em] mt-1.5 ml-0.5 opacity-60">AI Studio</span>
              </div>
           )}
        </div>

        {/* Desktop Collapse Toggle */}
        {!isMobile && (
           <button 
              onClick={() => setIsCollapsed(!isCollapsed)}
              className={cn(
                 "p-1.5 rounded-lg text-slate-500 hover:text-white hover:bg-white/5 transition-colors",
                 isCollapsed ? "mt-2" : ""
              )}
              title={isCollapsed ? "Expand Sidebar" : "Collapse Sidebar"}
           >
              {isCollapsed ? <PanelLeftOpen size={16} /> : <PanelLeftClose size={16} />}
           </button>
        )}

        {isMobile && (
          <button onClick={() => setIsOpen(false)} className="p-2 text-slate-500 hover:text-white">
            <CloseIcon size={24} />
          </button>
        )}
      </div>

      <div className={cn("flex-1 overflow-y-auto scrollbar-hide space-y-10", isCollapsed ? "px-2 space-y-6" : "px-6")}>
        <div className="space-y-1.5">
          {!isCollapsed && <p className="px-4 text-[9px] font-black text-slate-600 uppercase tracking-[0.3em] mb-4 opacity-40">Modes</p>}
          <NavItem mode="chat" icon={MessageSquare} label="Chat" />
          <NavItem mode="vision" icon={ScanEye} label="Vision" color="text-jb-orange" />
          <NavItem mode="coding" icon={Code} label="Coding Suite" color="text-jb-accent" />
          <NavItem mode="deep_thought" icon={Brain} label="Thinking" color="text-jb-purple" />
          <NavItem mode="browser" icon={Globe} label="Web Search" color="text-jb-cyan" />
        </div>
        <div className="space-y-1.5">
           {!isCollapsed && <p className="px-4 text-[9px] font-black text-slate-600 uppercase tracking-[0.3em] mb-4 opacity-40">Model Lab</p>}
           <NavItem mode="compare" icon={GitCompare} label="Compare" />
           <NavItem mode="debate" icon={Swords} label="Debate" />
           <NavItem mode="collaborate" icon={Users} label="Multi-Agent" />
           <NavItem mode="waterfall" icon={FlaskConical} label="Waterfall Lab" color="text-jb-purple" />
        </div>
      </div>

      <div className={cn("p-8", isCollapsed ? "p-3" : "")}>
        {!isCollapsed ? (
           <SystemStatus />
        ) : (
           <div className="flex justify-center">
              <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_rgba(34,197,94,0.6)]" title="System Status: Healthy"/>
           </div>
        )}
        
        <div className={cn("mt-6", isCollapsed ? "mt-4" : "")}>
           <motion.button
             whileHover={{ backgroundColor: 'rgba(255, 255, 255, 0.05)', x: isCollapsed ? 0 : 4 }}
             whileTap={{ scale: 0.98 }}
             onClick={() => {
               setSettingsOpen(true);
               if (isMobile) setIsOpen(false);
             }}
             className={cn(
               "w-full flex items-center rounded-2xl text-slate-500 hover:text-white transition-all group",
               isCollapsed ? "justify-center py-3" : "gap-3 px-4 py-3"
             )}
             title="Settings"
           >
              <div className={cn("flex items-center justify-center transition-colors", isCollapsed ? "" : "w-8 h-8 rounded-lg bg-white/5 group-hover:bg-white/10")}>
                 <Settings size={16} />
              </div>
              {!isCollapsed && <span className="text-[13px] font-bold tracking-tight">Settings</span>}
           </motion.button>
        </div>
      </div>
    </div>
  );

  if (isMobile) {
    return (
      <>
        <button 
          onClick={() => setIsOpen(true)}
          className="fixed top-6 left-6 z-40 p-3 bg-black/60 backdrop-blur-md border border-white/10 rounded-xl text-white"
        >
          <Menu size={20} />
        </button>
        <AnimatePresence>
          {isOpen && (
            <>
              <motion.div 
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                onClick={() => setIsOpen(false)}
                className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50"
              />
              <motion.div 
                initial={{ x: -300 }}
                animate={{ x: 0 }}
                exit={{ x: -300 }}
                transition={{ type: "spring", stiffness: 300, damping: 30 }}
                className="fixed top-0 left-0 bottom-0 w-[85%] max-w-[320px] bg-slate-950 z-[60] border-r border-white/10 shadow-2xl"
              >
                {navContent}
              </motion.div>
            </>
          )}
        </AnimatePresence>
      </>
    );
  }

  return (
    <motion.div 
       className="h-full bg-black/40 backdrop-blur-3xl border-r border-white/5 flex flex-col relative z-20 overflow-hidden"
       animate={{ width: isCollapsed ? 80 : 288 }} // 288 = w-72, 80 = w-20
       transition={{ duration: 0.3, ease: "easeInOut" }}
    >
      {navContent}
    </motion.div>
  );
};


// ==========================================
// File: ./frontend/src/components/BentoGrid.tsx
// ==========================================
import React from 'react';

export const BentoGrid = ({ children }: { children: React.ReactNode }) => (
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
    {children}
  </div>
);

export const BentoItem = ({ children, title }: { children: React.ReactNode, title?: string }) => (
  <div className="bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-xl">
    {title && <h3 className="text-lg font-semibold mb-2">{title}</h3>}
    {children}
  </div>
);



// ==========================================
// File: ./frontend/src/components/SettingsModal.tsx
// ==========================================
import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Cpu, Cloud, Zap, Shield, Sliders, ChevronDown, MessageSquare, ScanEye, Brain, Globe, FlaskConical, CreditCard, ArrowUpRight } from 'lucide-react';
import { useAppStore } from '../store/useAppStore';
import { API_BASE_URL } from '../lib/config';
import { cn } from '../lib/utils';

export const SettingsModal = () => {
  const { 
    settingsOpen, setSettingsOpen, 
    modeConfigs, setModeConfig,
    temperature, setTemperature,
    maxTokens, setMaxTokens,
    globalProvider, setGlobalProvider,
    deviceInfo,
    auraMode, setAuraMode
  } = useAppStore();

  const [availableModels, setAvailableModels] = useState<{ollama: any[], gemini: string[], deepseek: string[]}>({ ollama: [], gemini: [], deepseek: [] });

  useEffect(() => {
    if (settingsOpen) {
      fetch(`${API_BASE_URL}/models`)
        .then(res => res.json())
        .then(data => setAvailableModels(data))
        .catch(err => console.error("Failed to fetch models", err));
    }
  }, [settingsOpen]);

  if (!settingsOpen) return null;

  const modes = [
    { id: 'chat', label: 'Chat', icon: MessageSquare },
    { id: 'vision', label: 'Vision', icon: ScanEye },
    { id: 'deep_thought', label: 'Thinking', icon: Brain },
    { id: 'browser', label: 'Web Search', icon: Globe },
    { id: 'waterfall', label: 'Waterfall', icon: FlaskConical },
  ];

  return (
    <div className={cn(
      "fixed inset-0 z-[100] flex items-center justify-center",
      deviceInfo.isMobile ? "p-0" : "p-6"
    )}>
      <motion.div 
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        onClick={() => setSettingsOpen(false)}
        className="absolute inset-0 bg-black/60 backdrop-blur-md"
      />
      
      <motion.div 
        initial={deviceInfo.isMobile ? { y: "100%" } : { scale: 0.9, opacity: 0, y: 20 }}
        animate={{ scale: 1, opacity: 1, y: 0 }}
        exit={deviceInfo.isMobile ? { y: "100%" } : { scale: 0.9, opacity: 0, y: 20 }}
        className={cn(
          "w-full bg-[#050508] border-white/10 shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500",
          deviceInfo.isMobile 
            ? "h-full rounded-t-[32px] mt-20" 
            : "max-w-3xl rounded-[32px] max-h-[90vh] border"
        )}
      >
        {/* Modal Header */}
        <div className={cn(
          "border-b border-white/5 flex items-center justify-between bg-white/[0.02] shrink-0",
          deviceInfo.isMobile ? "p-6" : "p-8"
        )}>
           <div className="flex items-center gap-4">
              <div className="w-10 h-10 rounded-xl bg-jb-accent/20 flex items-center justify-center border border-jb-accent/30 text-jb-accent shrink-0">
                 <Sliders size={20} />
              </div>
              <div>
                 <h2 className="text-lg md:text-xl font-black text-white tracking-tight">AI Configuration</h2>
                 <p className="text-[9px] md:text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mt-1">Laboratory Parameters</p>
              </div>
           </div>
           <button 
             onClick={() => setSettingsOpen(false)}
             className="p-2 hover:bg-white/5 rounded-xl text-slate-500 hover:text-white transition-all"
           >
              <X size={20} />
           </button>
        </div>

        <div className={cn(
          "flex-1 overflow-y-auto space-y-12 scrollbar-thin",
          deviceInfo.isMobile ? "p-6" : "p-8"
        )}>
           
           {/* Global Provider Selection */}
           <div className="space-y-6">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-1">Global System Architecture</h3>
              <div className={cn(
                "grid gap-4",
                deviceInfo.isMobile ? "grid-cols-1" : "grid-cols-3"
              )}>
                 {[
                   { id: 'cloud', label: 'Cloud Prime', icon: Cloud, desc: 'Gemini/DeepSeek' },
                   { id: 'local', label: 'Local Node', icon: Cpu, desc: 'Ollama Instance' },
                   { id: 'auto', label: 'Smart Hybrid', icon: Zap, desc: 'Router Control' },
                 ].map((p) => {
                    const active = (globalProvider || 'auto') === p.id;
                    return (
                       <button
                         key={p.id}
                         onClick={() => setGlobalProvider(p.id as any)}
                         className={cn(
                           "p-5 rounded-2xl border transition-all text-left group relative overflow-hidden",
                           active 
                             ? "bg-white/[0.04] border-white/20 shadow-xl" 
                             : "bg-transparent border-white/5 opacity-40 hover:opacity-100"
                         )}
                       >
                          {active && <div className="absolute top-0 right-0 w-12 h-12 bg-white/5 blur-xl rounded-full -mr-4 -mt-4" />}
                          <p.icon size={20} className={cn("mb-3", active ? "text-white" : "text-slate-500")} />
                          <h4 className="text-xs font-black text-white uppercase tracking-wider mb-1">{p.label}</h4>
                          <p className="text-[10px] text-slate-500 font-bold">{p.desc}</p>
                       </button>
                    );
                 })}
              </div>
           </div>

           {/* Mode Specific Config */}
           <div className="space-y-6">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-1">Mode Assignments</h3>
              <div className="grid grid-cols-1 gap-4">
                 {modes.map((mode) => {
                    const config = modeConfigs[mode.id] || { provider: 'auto', model: 'gemini-3-pro-preview' };
                    return (
                       <div key={mode.id} className="bg-white/[0.02] border border-white/5 rounded-2xl p-4 md:p-5 flex flex-col gap-4">
                          <div className={cn(
                            "flex items-center justify-between",
                            deviceInfo.isMobile ? "flex-col items-start gap-4" : ""
                          )}>
                             <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-slate-400">
                                   <mode.icon size={16} />
                                </div>
                                <span className="font-bold text-white text-sm">{mode.label}</span>
                             </div>
                             
                             <div className="flex bg-black/40 rounded-lg p-1 border border-white/5 w-full md:w-auto overflow-x-auto scrollbar-hide">
                                {['auto', 'gemini', 'deepseek', 'ollama'].map((p) => (
                                   <button
                                     key={p}
                                     onClick={() => setModeConfig(mode.id, { ...config, provider: p as any })}
                                     className={cn(
                                       "px-3 py-1 rounded-md text-[10px] font-black uppercase tracking-widest transition-all whitespace-nowrap",
                                       config.provider === p 
                                         ? "bg-white/10 text-white shadow-sm" 
                                         : "text-slate-600 hover:text-slate-400"
                                     )}
                                   >
                                      {p}
                                   </button>
                                ))}
                             </div>
                          </div>

                          {config.provider !== 'auto' && (
                             <div className="relative group">
                                <select 
                                  value={config.model}
                                  onChange={(e) => setModeConfig(mode.id, { ...config, model: e.target.value })}
                                  className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-2.5 text-xs font-bold text-slate-300 outline-none appearance-none focus:border-white/20 transition-all cursor-pointer"
                                >
                                   {config.provider === 'gemini' ? (
                                      (availableModels?.gemini || ['gemini-3-pro-preview', 'gemini-3-flash-preview', 'gemini-flash-latest', 'gemini-1.5-pro']).map(m => (
                                        <option key={m} value={m} className="bg-[#050508]">{m}</option>
                                      ))
                                   ) : config.provider === 'deepseek' ? (
                                      (availableModels?.deepseek || ['deepseek-chat', 'deepseek-coder']).map(m => (
                                        <option key={m} value={m} className="bg-[#050508]">{m}</option>
                                      ))
                                   ) : (
                                      (availableModels?.ollama || []).map((m: any) => (
                                        <option key={m.name} value={m.name} className="bg-[#050508]">{m.name}</option>
                                      ))
                                   )}
                                </select>
                                <ChevronDown size={14} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-600 pointer-events-none" />
                             </div>
                          )}
                       </div>
                    );
                 })}
              </div>
           </div>

           {/* Interface & Theme */}
           <div className="space-y-6">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-1">Interface & Theme</h3>
              <div className={cn(
                "bg-white/[0.02] border border-white/5 rounded-2xl p-5 flex items-center justify-between",
                deviceInfo.isMobile ? "flex-col gap-6" : ""
              )}>
                 <div className="flex items-center gap-4">
                    <div className="w-10 h-10 rounded-xl bg-jb-pink/20 flex items-center justify-center border border-jb-pink/30 text-jb-pink shrink-0">
                       <Zap size={20} />
                    </div>
                    <div>
                       <h4 className="text-xs font-black text-white uppercase tracking-wider mb-1">Aura Synthesis</h4>
                       <p className="text-[10px] text-slate-500 font-bold">
                          {auraMode === 'organic' ? 'Dynamic, adaptive resource scaling' : 
                           auraMode === 'static' ? 'Predictable, fixed resource allocation' : 
                           'Maximum performance / Minimum overhead'}
                       </p>
                    </div>
                 </div>
                 
                 <div className="flex bg-black/40 rounded-xl p-1 border border-white/5">
                    {[
                      { id: 'off', label: 'Off' },
                      { id: 'static', label: 'Static' },
                      { id: 'organic', label: 'Organic' },
                    ].map((opt) => (
                       <button
                         key={opt.id}
                         onClick={() => setAuraMode(opt.id as any)}
                         className={cn(
                           "px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all",
                           auraMode === opt.id 
                             ? "bg-white/10 text-white shadow-xl" 
                             : "text-slate-600 hover:text-slate-400"
                         )}
                       >
                          {opt.label}
                       </button>
                    ))}
                 </div>
              </div>
           </div>

           {/* Global Parameters */}
           <div className="space-y-8 pt-4 border-t border-white/5">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-1">Global Parameters</h3>
              <div className={cn(
                "grid gap-10",
                deviceInfo.isMobile ? "grid-cols-1" : "grid-cols-2"
              )}>
                 <div className="space-y-4">
                    <div className="flex justify-between items-center">
                       <label className="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] ml-1">Temperature</label>
                       <span className="text-xs font-mono text-jb-accent">{temperature}</span>
                    </div>
                    <input 
                      type="range" min="0" max="1" step="0.1" 
                      value={temperature}
                      onChange={(e) => setTemperature(parseFloat(e.target.value))}
                      className="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-jb-accent"
                    />
                 </div>
                 <div className="space-y-4">
                    <div className="flex justify-between items-center">
                       <label className="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] ml-1">Max Tokens</label>
                       <span className="text-xs font-mono text-jb-purple">{maxTokens}</span>
                    </div>
                    <input 
                      type="range" min="512" max="8192" step="512" 
                      value={maxTokens}
                      onChange={(e) => setMaxTokens(parseInt(e.target.value))}
                      className="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-jb-purple"
                    />
                 </div>
              </div>
           </div>

           {/* Billing & Limits */}
           <div className="space-y-6 pt-4 border-t border-white/5">
              <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-1">Billing & Limits</h3>
              <div className="bg-white/[0.02] border border-white/5 rounded-2xl p-5 flex items-center justify-between">
                 <div className="flex items-center gap-4">
                    <div className="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center border border-green-500/30 text-green-400 shrink-0">
                       <CreditCard size={20} />
                    </div>
                    <div>
                       <h4 className="text-xs font-black text-white uppercase tracking-wider mb-1">OpenRouter Free Tier</h4>
                       <p className="text-[10px] text-slate-500 font-bold">Limit: 20 reqs/min (Current: Free)</p>
                    </div>
                 </div>
                 
                 <a 
                   href="https://openrouter.ai/credits" 
                   target="_blank" 
                   rel="noreferrer"
                   className="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl transition-all group"
                 >
                    <span className="text-[10px] font-black uppercase tracking-widest">Top Up</span>
                    <ArrowUpRight size={12} className="group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" />
                 </a>
              </div>
           </div>

        </div>

        {/* Modal Footer */}
        <div className={cn(
          "bg-white/[0.02] border-t border-white/5 flex items-center justify-between shrink-0",
          deviceInfo.isMobile ? "p-6 flex-col gap-6" : "p-8"
        )}>
           <div className="flex items-center gap-2 text-[9px] font-black text-slate-600 uppercase tracking-widest">
              <Shield size={12} />
              <span>Configuration locked to local session</span>
           </div>
           <button 
             onClick={() => setSettingsOpen(false)}
             className={cn(
               "bg-white text-black rounded-xl font-bold text-xs hover:bg-slate-200 transition-all shadow-xl",
               deviceInfo.isMobile ? "w-full py-4" : "px-8 py-3"
             )}
           >
              Synchronize
           </button>
        </div>
      </motion.div>
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/CodingArea.tsx
// ==========================================
import React, { useState, useEffect, useRef } from 'react';
import { useAppStore } from '../store/useAppStore';
import { API_BASE_URL } from '../lib/config';
import { Code, Terminal, Play, Save, Copy, FileCode, Check, Loader2, Cpu, ChevronRight, Globe, RefreshCw, Layout, Sparkles, Bug, Zap, TestTube, Wand2 } from 'lucide-react';
import { cn } from '../lib/utils';
import { motion, AnimatePresence } from 'framer-motion';
import { WebContainer } from '@webcontainer/api';
import Editor from '@monaco-editor/react';

interface CodeFile {
  name: string;
  language: string;
  content: string;
}

export const CodingArea = () => {
  const { modeConfigs, selectedCloudModel, deviceInfo } = useAppStore();
  const [prompt, setPrompt] = useState("");
  const [isGenerating, setIsGenerating] = useState(false);
  const [activeFileIndex, setActiveFileIndex] = useState(0);
  const [files, setFiles] = useState<CodeFile[]>([
    { name: 'index.js', language: 'javascript', content: `const express = require('express');
const app = express();
const port = 3000;

app.get('/', (req, res) => {
  res.send('Hello from Solvent AI WebContainer!');
});

app.listen(port, () => {
  console.log("App listening at http://localhost:\${port}");
});` },
    { name: 'package.json', language: 'json', content: `{ 
  "name": "example-app",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "latest"
  }
}` }
  ]);
  const [streamedResponse, setStreamedResponse] = useState("");
  const [showPrompt, setShowPrompt] = useState(true);
  
  // WebContainer State
  const [webContainer, setWebContainer] = useState<WebContainer | null>(null);
  const [iframeUrl, setIframeUrl] = useState<string | null>(null);
  const [isBooting, setIsBooting] = useState(true);
  const [isRunning, setIsRunning] = useState(false);
  const [terminalOutput, setTerminalOutput] = useState<string[]>([]);
  const [showPreview, setShowPreview] = useState(false);
  const [iframeLoading, setIframeLoading] = useState(false);

  const config = modeConfigs['coding'] || { provider: 'auto', model: 'gemini-3-pro-preview' };

  useEffect(() => {
    if (deviceInfo.isMobile) {
      setShowPrompt(false);
    } else {
      setShowPrompt(true);
    }
  }, [deviceInfo.isMobile]);

  // 9. Document communication protocol
  // Protocol: Messages from the iframe should be JSON objects.
  // Example: { type: 'LOG', payload: '...' } or { type: 'ERROR', payload: '...' }
  // 4. Implement postMessage for iframe communication
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      // Basic security check: ensure we are receiving from a valid source if possible.
      // Since WebContainer URLs are dynamic/local, we log for now.
      console.log("[Parent] Received message:", event.data);
      if (event.data?.type === 'ERROR') {
         setTerminalOutput(prev => [...prev, `[App Error] ${event.data.payload}`]);
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  // Boot WebContainer
  useEffect(() => {
    async function boot() {
      try {
        const instance = await WebContainer.boot();
        setWebContainer(instance);
        setIsBooting(false);
        
        // 1. Listen for the container to say "I am listening on a port"
        instance.on('server-ready', (port, url) => {
          // 2. Set your iframe to that URL
          setIframeUrl(url);
          setIframeLoading(true);
          if (!deviceInfo.isMobile) setShowPreview(true);
        });
      } catch (error) {
        console.error("Failed to boot WebContainer:", error);
        setTerminalOutput(prev => [...prev, "Error: Failed to boot WebContainer enviroment."]);
        setIsBooting(false);
      }
    }
    boot();
  }, []);

  // Sync files to WebContainer
  useEffect(() => {
    if (!webContainer || files.length === 0) return;

    const fileTree = files.reduce((acc, file) => {
      acc[file.name] = {
        file: { contents: file.content }
      };
      return acc;
    }, {} as any);

    webContainer.mount(fileTree);
  }, [webContainer, files]);

  // Parse files from the LLM response
  useEffect(() => {
    if (!streamedResponse) return;

    const fileRegex = /```(\w+)?(?:\s+(?:filename=|title=)?([a-zA-Z0-9_./-]+))?\n([\s\S]*?)```/g;
    const newFiles: CodeFile[] = [];
    let match;

    while ((match = fileRegex.exec(streamedResponse)) !== null) {
      const language = match[1] || 'text';
      const name = match[2] || `untitled_${newFiles.length + 1}.${language === 'python' ? 'py' : language === 'javascript' ? 'js' : 'txt'}`;
      const content = match[3];
      newFiles.push({ name, language, content });
    }

    if (newFiles.length > 0) {
        setFiles(newFiles);
    }
  }, [streamedResponse]);

  const handleAIAction = async (action: 'refactor' | 'optimize' | 'bugs' | 'tests') => {
    if (isGenerating || files.length === 0) return;
    setIsGenerating(true);
    
    // Check if we are generating for a specific file or all
    const currentFile = files[activeFileIndex];
    const fileContext = `Filename: ${currentFile.name}\nLanguage: ${currentFile.language}\nContent:\n${currentFile.content}`;

    let promptPrefix = "";
    switch (action) {
        case 'refactor': 
            promptPrefix = "Refactor the following code to be more readable, maintainable, and idiomatic. Remove any redundancy."; 
            break;
        case 'optimize': 
            promptPrefix = "Analyze the following code for performance bottlenecks and optimize it. Explain your optimizations."; 
            break;
        case 'bugs': 
            promptPrefix = "Analyze the following code for potential bugs, security vulnerabilities, and logic errors. Fix them."; 
            break;
        case 'tests': 
            promptPrefix = "Generate comprehensive unit tests for the following code. Use the same language/framework conventions."; 
            break;
    }

    const systemPrompt = `
    [SYSTEM: SENIOR ENGINEER - ${action.toUpperCase()} SPECIALIST]
    ${promptPrefix}
    
    CRITICAL OUTPUT FORMAT:
    Return ONLY the code block(s) with the updated/new code. 
    Wrap files in:
    \`\`\`language filename=...
    ...
    \`\`\`
    If generating tests, create a new file (e.g., .test.js or _test.py).
    If refactoring, output the updated file with the SAME filename.
    `;

    try {
        const response = await fetch(`${API_BASE_URL}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                provider: 'gemini',
                model: selectedCloudModel,
                messages: [
                    { role: 'user', content: `${systemPrompt}\n\n${fileContext}` }
                ]
            })
        });

        const data = await response.json();
        setStreamedResponse(data.response); // This will trigger the useEffect to parse and update files
        
    } catch (error) {
        console.error("AI Action failed", error);
        setTerminalOutput(prev => [...prev, `Error: ${action} failed.`]);
    } finally {
        setIsGenerating(false);
    }
  };

  const handleGenerate = async () => {
    if (!prompt.trim() || isGenerating) return;
    setIsGenerating(true);
    if (deviceInfo.isMobile) setShowPrompt(false);
    setStreamedResponse("");
    // setFiles([]); // Optional: clear files or append/replace

    const systemPrompt = `
    [SYSTEM: CODING SUITE]
    You are an expert AI Software Engineer.
    Generate high-quality, production-ready code.
    Prefer Node.js/Express for web applications as they can be previewed instantly.
    
    CRITICAL OUTPUT FORMAT:
    You MUST wrap every file in a code block with its language and filename.
    Example:
    \
    \
    console.log("Hello");
    \
    `;

    try {
        const response = await fetch(`${API_BASE_URL}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                provider: 'gemini',
                model: selectedCloudModel,
                messages: [
                    { role: 'user', content: `${systemPrompt}\n\nRequest: ${prompt}` }
                ]
            })
        });

        const data = await response.json();
        setStreamedResponse(data.response);
        
    } catch (error) {
        console.error("Generation failed", error);
        setStreamedResponse("// Error: Generation failed.");
    } finally {
        setIsGenerating(false);
    }
  };

  const runCode = async () => {
    if (!webContainer || isRunning) return;
    setIsRunning(true);
    setTerminalOutput(["Starting container..."]);
    setIframeUrl(null);

    try {
        // Install dependencies if package.json exists
        if (files.some(f => f.name === 'package.json')) {
            setTerminalOutput(prev => [...prev, "> npm install"]);
            const installProcess = await webContainer.spawn('npm', ['install']);
            
            installProcess.output.pipeTo(new WritableStream({
                write(data) { setTerminalOutput(prev => [...prev, data]); }
            }));
            
            if ((await installProcess.exit) !== 0) {
                throw new Error("Installation failed");
            }
        }

        // Run start script or node file
        setTerminalOutput(prev => [...prev, "> npm start"]);
        const startProcess = await webContainer.spawn('npm', ['start']);
        
        startProcess.output.pipeTo(new WritableStream({
            write(data) { setTerminalOutput(prev => [...prev, data]); }
        }));

        // Note: 'server-ready' event will trigger iframe update
    } catch (error) {
        setTerminalOutput(prev => [...prev, `Error: ${error}`]);
        setIsRunning(false);
    }
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };

  return (
    <div className={cn(
      "flex h-full w-full bg-[#050508] text-slate-300 font-sans relative overflow-hidden transition-all duration-500",
      deviceInfo.isMobile ? "flex-col pt-24" : "flex-row"
    )}>
       
       {/* Sidebar: Prompt & Chat */}
       <AnimatePresence>
         {showPrompt && (
           <motion.div 
             initial={deviceInfo.isMobile ? { height: 0, opacity: 0 } : { width: 0, opacity: 0 }}
             animate={deviceInfo.isMobile ? { height: 'auto', opacity: 1 } : { width: 400, opacity: 1 }}
             exit={deviceInfo.isMobile ? { height: 0, opacity: 0 } : { width: 0, opacity: 0 }}
             className={cn(
               "flex flex-col border-white/10 bg-black/20 backdrop-blur-xl z-20 overflow-hidden",
               deviceInfo.isMobile ? "w-full border-b max-h-[50vh]" : "w-[400px] border-r"
             )}
           >
              <div className="p-6 border-b border-white/10 flex items-center justify-between bg-white/[0.02]">
                 <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl bg-jb-accent/20 flex items-center justify-center border border-jb-accent/30 text-jb-accent">
                       <Terminal size={20} />
                    </div>
                    <div>
                       <h2 className="text-sm font-black text-white uppercase tracking-wider">Solvent Coder</h2>
                    </div>
                 </div>
                 {deviceInfo.isMobile && (
                   <button onClick={() => setShowPrompt(false)} className="p-2 text-slate-500"><ChevronRight className="rotate-90" /></button>
                 )}
              </div>

              <div className="flex-1 overflow-y-auto p-6 scrollbar-thin">
                 {streamedResponse && (
                    <div className="prose prose-invert prose-sm max-w-none prose-pre:hidden text-[13px] leading-relaxed opacity-80">
                       {streamedResponse.split('```')[0]} 
                    </div>
                 )}
                 
                 {/* Terminal Output Log */}
                 {terminalOutput.length > 0 && (
                     <div className="mt-4 p-3 bg-black/50 rounded-lg border border-white/5 font-mono text-[10px] text-slate-400 max-h-40 overflow-auto">
                         {terminalOutput.map((line, i) => <div key={i}>{line}</div>)}
                     </div>
                 )}
              </div>

              <div className="p-6 border-t border-white/10 bg-[#08080a]">
                 <div className="relative">
                    <textarea 
                       value={prompt}
                       onChange={(e) => setPrompt(e.target.value)}
                       onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleGenerate())}
                       placeholder="Describe functionality..."
                       className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-jb-accent outline-none h-24 resize-none placeholder:text-slate-600 font-medium"
                    />
                    <button 
                       onClick={handleGenerate}
                       disabled={isGenerating || !prompt.trim()}
                       className="absolute bottom-3 right-3 p-2 bg-jb-accent text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 shadow-lg"
                    >
                       {isGenerating ? <Loader2 size={16} className="animate-spin" /> : <Play size={16} className="fill-current" />}
                    </button>
                 </div>
              </div>
           </motion.div>
         )}
       </AnimatePresence>

       {/* Main Area: Split View support */}
       <div className="flex-1 flex flex-col bg-[#030304] relative overflow-hidden">
          
          {/* File Tabs & Actions */}
          <div className="h-12 flex items-center bg-[#0a0a0c] border-b border-white/5 shrink-0 justify-between pr-4">
             <div className="flex items-center overflow-x-auto scrollbar-hide">
                {deviceInfo.isMobile && (
                    <button 
                        onClick={() => setShowPrompt(!showPrompt)}
                        className="h-full px-4 flex items-center gap-2 border-r border-white/5 bg-jb-accent/10 text-jb-accent"
                    >
                        <Terminal size={14} />
                    </button>
                )}
                {files.map((file, i) => (
                    <button 
                        key={i}
                        onClick={() => setActiveFileIndex(i)}
                        className={cn(
                            "h-full px-6 flex items-center gap-2 text-xs font-bold border-r border-white/5 transition-all min-w-[120px] whitespace-nowrap",
                            i === activeFileIndex 
                                ? "bg-[#1e1e24] text-white border-t-2 border-t-jb-accent" 
                                : "text-slate-500 hover:text-slate-300 hover:bg-white/5"
                        )}
                    >
                        <FileCode size={14} className={i === activeFileIndex ? "text-jb-accent" : "opacity-50"} />
                        {file.name}
                    </button>
                ))}
             </div>
             
             {/* Preview Toggle & Run */}
             <div className="flex items-center gap-2">
                 <button 
                     onClick={runCode}
                     disabled={!webContainer || isRunning || isBooting}
                     className="flex items-center gap-2 px-3 py-1.5 bg-green-500/10 text-green-500 hover:bg-green-500/20 rounded-md text-xs font-bold transition-all disabled:opacity-50"
                 >
                     {isBooting ? <Loader2 size={12} className="animate-spin" /> : <Play size={12} />}
                     {isBooting ? "Booting..." : isRunning ? "Running..." : "Run"}
                 </button>

                 <button 
                    onClick={() => setShowPreview(!showPreview)}
                    className={cn(
                        "flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all",
                        showPreview ? "bg-jb-accent/20 text-jb-accent" : "bg-white/5 text-slate-400 hover:text-white"
                    )}
                 >
                    <Globe size={12} />
                    Preview
                 </button>
             </div>
          </div>

          {/* AI Tools Toolbar (Compact) */}
          <div className="h-10 bg-[#0a0a0c] border-b border-white/5 flex items-center px-4 gap-1">
             <span className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mr-2 hidden md:inline">AI Tools</span>
             
             <div className="flex items-center gap-1">
                 <button onClick={() => handleAIAction('refactor')} disabled={isGenerating} className="p-1.5 hover:bg-white/10 rounded-md text-slate-400 hover:text-purple-400 transition-all" title="Refactor Code">
                    <Wand2 size={14} />
                 </button>
                 <button onClick={() => handleAIAction('optimize')} disabled={isGenerating} className="p-1.5 hover:bg-white/10 rounded-md text-slate-400 hover:text-yellow-400 transition-all" title="Optimize Performance">
                    <Zap size={14} />
                 </button>
                 <button onClick={() => handleAIAction('bugs')} disabled={isGenerating} className="p-1.5 hover:bg-white/10 rounded-md text-slate-400 hover:text-red-400 transition-all" title="Find Bugs">
                    <Bug size={14} />
                 </button>
                 <button onClick={() => handleAIAction('tests')} disabled={isGenerating} className="p-1.5 hover:bg-white/10 rounded-md text-slate-400 hover:text-green-400 transition-all" title="Generate Tests">
                    <TestTube size={14} />
                 </button>
             </div>
             
             <div className="flex-1" />
             
             {/* Mock Collab UI */}
             <div className="flex items-center gap-2 px-3 py-1 bg-blue-500/5 rounded-full border border-blue-500/10">
                <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                <span className="text-[10px] font-bold text-blue-500">Live Sync Active</span>
             </div>
          </div>

          {/* Editor & Preview Split */}
          <div className="flex-1 flex flex-row overflow-hidden relative">
             
             {/* Editor */}
             <div className={cn(
                 "flex-1 relative group transition-all duration-300",
                 showPreview && !deviceInfo.isMobile ? "w-1/2 border-r border-white/5" : "w-full"
             )}>
                {files.length > 0 ? (
                   <Editor
                     height="100%"
                     defaultLanguage={files[activeFileIndex]?.language || 'javascript'}
                     language={files[activeFileIndex]?.language || 'javascript'}
                     value={files[activeFileIndex]?.content}
                     theme="vs-dark"
                     options={{
                       minimap: { enabled: false },
                       fontSize: 14,
                       fontFamily: 'JetBrains Mono, monospace',
                       padding: { top: 20 },
                       scrollBeyondLastLine: false,
                       automaticLayout: true,
                       smoothScrolling: true,
                       cursorBlinking: "smooth",
                       cursorSmoothCaretAnimation: "on",
                     }}
                     onChange={(value) => {
                       const newFiles = [...files];
                       newFiles[activeFileIndex].content = value || "";
                       setFiles(newFiles);
                     }}
                     loading={<Loader2 className="animate-spin text-jb-accent" />}
                   />
                ) : (
                    <div className="absolute inset-0 flex flex-col items-center justify-center opacity-10">
                       <Cpu size={64} className="mb-4" />
                       <p className="font-black uppercase tracking-[0.3em] text-sm">Ready for Input</p>
                    </div>
                )}
             </div>

             {/* Preview Iframe */}
             <AnimatePresence>
                 {showPreview && (
                     <motion.div 
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: 20 }}
                        className={cn(
                            "bg-white relative",
                            deviceInfo.isMobile ? "absolute inset-0 z-10" : "w-1/2"
                        )}
                     >
                        {iframeUrl ? (
                            <div className="relative w-full h-full">
                                {/* 6. Add loading indicator while iframe content loads */}
                                {iframeLoading && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-white z-20">
                                        <Loader2 size={32} className="animate-spin text-jb-accent" />
                                    </div>
                                )}
                                {/* 3. Add error handling for iframe load failure (via onLoad) */}
                                {/* 5. Ensure iframe sandbox attributes are secure */}
                                {/* 7. Style iframe for responsive display */}
                                <iframe 
                                    src={iframeUrl} 
                                    className="w-full h-full border-none"
                                    title="App Preview"
                                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
                                    onLoad={() => setIframeLoading(false)}
                                />
                            </div>
                        ) : (
                            <div className="w-full h-full flex flex-col items-center justify-center text-slate-900 bg-slate-100 gap-3">
                                {isRunning ? (
                                    <>
                                        <Loader2 size={32} className="animate-spin text-jb-accent" />
                                        <p className="text-sm font-semibold">Starting application...</p>
                                    </>
                                ) : (
                                    <>
                                        <Layout size={48} className="text-slate-300" />
                                        <p className="text-sm font-semibold text-slate-500">Preview not active</p>
                                        <button onClick={runCode} className="text-xs text-blue-600 hover:underline">Click 'Run' to start</button>
                                    </>
                                )}
                            </div>
                        )}

                        {deviceInfo.isMobile && (
                            <button 
                                onClick={() => setShowPreview(false)}
                                className="absolute top-4 right-4 p-2 bg-black/50 text-white rounded-full backdrop-blur-md"
                            >
                                <ChevronRight size={20} />
                            </button>
                        )}
                     </motion.div>
                 )}
             </AnimatePresence>
          </div>

          {/* Status Bar */}
          <div className="h-8 bg-jb-accent/5 border-t border-white/5 flex items-center justify-between px-4 text-[9px] font-mono font-bold text-slate-500 shrink-0">
             <div className="flex items-center gap-4">
                <span className="flex items-center gap-1.5">
                   <div className={cn("w-1.5 h-1.5 rounded-full", isGenerating ? "bg-jb-accent animate-pulse" : "bg-emerald-500")} />
                   {isGenerating ? "GEN" : "IDLE"}
                </span>
                <span className="hidden md:inline">{files[activeFileIndex]?.language?.toUpperCase() || 'TEXT'}</span>
                {webContainer && <span className="text-green-500">CONTAINER READY</span>}
             </div>
             <div className="flex items-center gap-4">
                <span className="hidden md:inline">UTF-8</span>
                <span>{files[activeFileIndex]?.content.length || 0} CHS</span>
             </div>
          </div>

       </div>
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/FloatingNotepad.tsx
// ==========================================
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { StickyNote, Maximize2, ExternalLink, Save, X, Activity, Zap, Cpu, Terminal, Search, GripHorizontal } from 'lucide-react';
import { useAppStore } from '../store/useAppStore';
import { cn } from '../lib/utils';
import { motion } from 'framer-motion';
import { Rnd } from 'react-rnd';

export const FloatingNotepad = () => {
  const { activities, addActivity, supervisorInsight, setNotepadContent } = useAppStore();
  const [pipWindow, setPipWindow] = useState<any>(null);
  const [note, setNote] = useState("");
  const [isOpen, setIsOpen] = useState(true);
  const [activeTab, setActiveTab] = useState<'scratchpad' | 'supervisor'>('scratchpad');
  const [position, setPosition] = useState(() => {
    const saved = localStorage.getItem('solvent_notepad_pos');
    return saved ? JSON.parse(saved) : { x: window.innerWidth - 360, y: 100 };
  });
  const [size, setSize] = useState(() => {
     const saved = localStorage.getItem('solvent_notepad_size');
     return saved ? JSON.parse(saved) : { width: 340, height: 500 };
  });

  const lastWriteRef = React.useRef(""); // The "Safety Mirror"
  
  // Load notes on mount and sync with Electron
  useEffect(() => {
    const savedOpenState = localStorage.getItem('solvent_notepad_visible');
    if (savedOpenState === 'false') setIsOpen(false);

    // Initial Fetch from Main Process (Disk)
    if (window.electron?.getNotepad) {
      window.electron.getNotepad().then((content) => {
        if (content) {
          setNote(content);
          lastWriteRef.current = content; // Sync mirror on load
        }
      });

      // 1. WATCH: Listen for AI updates from Electron
      const cleanupNotes = window.electron.onNotepadUpdated((updatedContent) => {
        if (updatedContent !== note && updatedContent !== lastWriteRef.current) {
          setNote(updatedContent);
          lastWriteRef.current = updatedContent;
        }
      });

      // 2. WATCH: Listen for Supervisor Data
      const cleanupSupervisor = window.electron.onSupervisorData((data) => {
        addActivity(data);
      });

      return () => {
        cleanupNotes();
        cleanupSupervisor();
      };
    } else {
      const savedNote = localStorage.getItem('solvent_notepad_content');
      if (savedNote) setNote(savedNote);
    }
  }, []);

  // WRITE: Send user input to the AI's "Eyes"
  useEffect(() => {
    setNotepadContent(note);
    if (window.electron?.saveNotepad) {
      const debounceTimer = setTimeout(() => {
        if (note !== lastWriteRef.current) {
          lastWriteRef.current = note;
          window.electron?.saveNotepad(note);
        }
      }, 700);
      return () => clearTimeout(debounceTimer);
    } else {
      localStorage.setItem('solvent_notepad_content', note);
    }
  }, [note]);

  // Save visibility
  useEffect(() => {
    localStorage.setItem('solvent_notepad_visible', String(isOpen));
  }, [isOpen]);

  const saveConfig = (newPos: any, newSize: any) => {
     localStorage.setItem('solvent_notepad_pos', JSON.stringify(newPos));
     localStorage.setItem('solvent_notepad_size', JSON.stringify(newSize));
  };

  const togglePiP = async () => {
    if (pipWindow) {
      pipWindow.close();
      setPipWindow(null);
      return;
    }

    if (!('documentPictureInPicture' in window)) {
        alert("Document Picture-in-Picture is not supported in your browser (use Chrome 116+).");
        return;
    }

    try {
        // @ts-ignore
        const nw = await window.documentPictureInPicture.requestWindow({
            width: size.width,
            height: size.height,
        });

        // Copy styles for cohesion
        nw.document.body.style.backgroundColor = '#020617';
        nw.document.body.style.margin = '0';
        nw.document.body.style.fontFamily = 'JetBrains Mono, monospace'; // Enforce app font
        nw.document.title = "Solvent Overseer";

        setTimeout(() => {
            [...document.styleSheets].forEach((styleSheet) => {
                try {
                    const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                    const style = document.createElement('style');
                    style.textContent = cssRules;
                    nw.document.head.appendChild(style);
                } catch (e) { 
                    const link = document.createElement('link');
                    if (styleSheet.href) {
                        link.rel = 'stylesheet';
                        link.href = styleSheet.href;
                        nw.document.head.appendChild(link);
                    }
                }
            });
        }, 100);

        nw.addEventListener("pagehide", () => setPipWindow(null));
        setPipWindow(nw);
    } catch (err: any) {
        console.error("Failed to open PiP window", err);
        alert(`PiP Error: ${err.message || err}`);
    }
  };

  const ActivityIcon = ({ type }: { type: string }) => {
    switch (type) {
      case 'user_message': return <Activity size={12} className="text-blue-400" />;
      case 'web_search': return <Search size={12} className="text-cyan-400" />;
      case 'terminal': return <Terminal size={12} className="text-emerald-400" />;
      case 'llm_response': return <Cpu size={12} className="text-purple-400" />;
      default: return <Zap size={12} className="text-amber-400" />;
    }
  };

  const NotepadContent = (
    <div className="flex flex-col h-full bg-[#050508] text-slate-200 font-sans overflow-hidden border border-white/10">
      {/* Tabs */}
      <div className="flex bg-white/[0.02] border-b border-white/5 shrink-0 select-none">
        <button 
          onClick={() => setActiveTab('scratchpad')}
          className={cn(
            "flex-1 py-3 text-[9px] font-black uppercase tracking-[0.2em] flex items-center justify-center gap-2 transition-all hover:bg-white/5",
            activeTab === 'scratchpad' ? "text-jb-accent border-b border-jb-accent bg-white/5" : "text-slate-500 hover:text-slate-300"
          )}
        >
          <StickyNote size={12} /> Scratchpad
        </button>
        <button 
          onClick={() => setActiveTab('supervisor')}
          className={cn(
            "flex-1 py-3 text-[9px] font-black uppercase tracking-[0.2em] flex items-center justify-center gap-2 transition-all hover:bg-white/5",
            activeTab === 'supervisor' ? "text-jb-purple border-b border-jb-purple bg-white/5" : "text-slate-500 hover:text-slate-300"
          )}
        >
          <Activity size={12} /> Supervisor
        </button>
      </div>

      <div className="flex-1 overflow-hidden relative">
        {activeTab === 'scratchpad' ? (
          <div className="flex flex-col h-full">
            <div className="p-2 px-4 flex items-center justify-between border-b border-white/5 bg-white/[0.01]">
              <div className="text-[9px] text-slate-600 font-black uppercase tracking-widest flex items-center gap-1.5">
                  <Save size={10} className="text-jb-accent" /> Auto-Sync Active
              </div>
              <span className="text-[8px] font-mono text-slate-700">.solvent_notes.md</span>
            </div>
            <textarea
              className="flex-1 bg-transparent border-none outline-none resize-none text-[13px] font-mono leading-relaxed placeholder:text-slate-700 scrollbar-thin scrollbar-thumb-white/10 p-4 text-slate-300 selection:bg-jb-accent/30"
              placeholder="// Type notes here..."
              value={note}
              onChange={(e) => setNote(e.target.value)}
              spellCheck={false}
            />
          </div>
        ) : (
          <div className="flex flex-col h-full overflow-hidden">
            {/* Thought Stream Header */}
            <div className="p-4 bg-jb-purple/5 border-b border-jb-purple/10 shrink-0">
               <div className="flex items-center gap-2 mb-2">
                  <Cpu size={12} className="text-jb-purple animate-pulse" />
                  <span className="text-[10px] font-black uppercase tracking-wider text-jb-purple">Context Stream</span>
               </div>
               <p className="text-[10px] text-slate-400 font-medium leading-relaxed">
                  {supervisorInsight || "Awaiting system activity..."}
               </p>
            </div>

            {/* Reactive Feed */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-white/10">
               {activities.length === 0 ? (
                 <div className="h-full flex flex-col items-center justify-center opacity-20 text-center">
                    <Activity size={32} className="mb-2 text-slate-500" />
                    <p className="text-[9px] font-black uppercase tracking-widest text-slate-600">No signals detected</p>
                 </div>
               ) : (
                 activities.map((act, i) => (
                   <div key={i} className="flex gap-3 group">
                      <div className="flex flex-col items-center gap-1">
                         <div className="w-5 h-5 rounded-md bg-white/5 flex items-center justify-center border border-white/10 group-hover:border-white/20 transition-colors shrink-0">
                            <ActivityIcon type={act.type} />
                         </div>
                         {i < activities.length - 1 && <div className="w-px flex-1 bg-white/5" />}
                      </div>
                      <div className="pb-4 min-w-0">
                         <div className="flex items-center gap-2 mb-1">
                            <span className="text-[9px] font-black uppercase tracking-widest text-slate-500 truncate">{act.type.replace('_', ' ')}</span>
                            <span className="text-[8px] font-mono text-slate-700 shrink-0">{new Date(act.timestamp).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                         </div>
                         <p className="text-[11px] font-mono text-slate-400 line-clamp-3 group-hover:line-clamp-none transition-all cursor-text break-words">
                            {act.content || JSON.stringify(act.data)}
                         </p>
                      </div>
                   </div>
                 ))
               )}
            </div>
          </div>
        )}
      </div>
    </div>
  );

  if (!isOpen) {
    return (
        <button 
            onClick={() => setIsOpen(true)}
            className="fixed bottom-6 right-6 z-50 p-3 bg-jb-accent text-white rounded-xl shadow-2xl hover:bg-blue-600 transition-all hover:scale-105 group border border-white/10 hover:border-white/20"
            title="Open Notepad"
        >
            <StickyNote size={20} />
        </button>
    );
  }

  return (
    <>
        <Rnd
            size={{ width: size.width, height: size.height }}
            position={{ x: position.x, y: position.y }}
            onDragStop={(e, d) => {
                setPosition({ x: d.x, y: d.y });
                saveConfig({ x: d.x, y: d.y }, size);
            }}
            onResizeStop={(e, direction, ref, delta, position) => {
                setSize({ width: parseInt(ref.style.width), height: parseInt(ref.style.height) });
                setPosition(position);
                saveConfig(position, { width: parseInt(ref.style.width), height: parseInt(ref.style.height) });
            }}
            minWidth={300}
            minHeight={250}
            bounds="window"
            dragHandleClassName="notepad-drag-handle"
            className="z-[100]"
        >
            <div className="w-full h-full flex flex-col bg-black/80 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl overflow-hidden ring-1 ring-white/5 transition-all">
                {/* Drag Handle Header */}
                <div 
                    className="notepad-drag-handle h-9 bg-white/5 border-b border-white/5 flex items-center justify-between px-3 cursor-grab active:cursor-grabbing shrink-0 select-none"
                    onDoubleClick={() => setSize({ width: 340, height: 500 })} // Reset size on double click
                >
                    <div className="flex items-center gap-2 text-slate-400 group">
                        <GripHorizontal size={14} className="opacity-50 group-hover:opacity-100 transition-opacity" />
                        <span className="text-[10px] font-black uppercase tracking-widest group-hover:text-white transition-colors">Solvent OS</span>
                    </div>
                    <div className="flex items-center gap-1 app-no-drag" onMouseDown={(e) => e.stopPropagation()}>
                        <button 
                            onClick={togglePiP}
                            className={cn(
                                "p-1.5 hover:bg-white/10 rounded-md transition-all hover:scale-105",
                                pipWindow ? "text-jb-purple" : "text-slate-400 hover:text-white"
                            )}
                            title={pipWindow ? "Dock Window" : "Pop Out"}
                        >
                            {pipWindow ? <Maximize2 size={12} /> : <ExternalLink size={12} />}
                        </button>
                        <button 
                            onClick={() => setIsOpen(false)}
                            className="p-1.5 hover:bg-red-500/20 rounded-md text-slate-500 hover:text-red-400 transition-all"
                            title="Close"
                        >
                            <X size={12} />
                        </button>
                    </div>
                </div>

                {/* Content */}
                {!pipWindow ? (
                    <div className="flex-1 overflow-hidden">
                        {NotepadContent}
                    </div>
                ) : (
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-3 bg-black/20">
                        <div className="w-12 h-12 rounded-full bg-jb-purple/10 flex items-center justify-center border border-jb-purple/20 animate-pulse">
                            <ExternalLink size={20} className="text-jb-purple" />
                        </div>
                        <div>
                            <p className="text-[10px] font-black text-white uppercase tracking-widest">External Mode</p>
                            <p className="text-[10px] text-slate-500 mt-1">Notepad is active in another window.</p>
                        </div>
                        <button 
                            onClick={togglePiP}
                            className="text-[9px] font-bold text-jb-accent hover:text-white hover:underline uppercase tracking-wider"
                        >
                            Bring Back
                        </button>
                    </div>
                )}
            </div>
        </Rnd>
        
        {/* Portal for the PiP Window */}
        {pipWindow && createPortal(NotepadContent, pipWindow.document.body)}
    </>
  );
};


// ==========================================
// File: ./frontend/src/components/ChatHeader.tsx
// ==========================================
import React from 'react';
import { useAppStore } from '../store/useAppStore';
import { cn } from '../lib/utils';

export const ChatHeader = () => {
  const { currentMode, backend, selectedCloudModel, selectedLocalModel, deviceInfo } = useAppStore();
  
  const isMobile = deviceInfo.isMobile;

  return (
    <div className={cn(
      "absolute top-0 left-0 right-0 h-28 bg-gradient-to-b from-black/60 to-transparent z-10 flex items-center border-b border-white/5 backdrop-blur-2xl",
      isMobile ? "px-6 pl-20" : "px-12"
    )}>
      <div className={cn("flex items-center", isMobile ? "gap-4" : "gap-10")}>
        <div className="flex flex-col">
          <span className="text-[9px] font-black text-slate-500 uppercase tracking-[0.5em] mb-1.5 opacity-60">Mode</span>
          <span className="text-[12px] font-extrabold text-white uppercase tracking-[0.2em]">{currentMode}</span>
        </div>
        {!isMobile && <div className="h-8 w-[1px] bg-white/10" />}
        <div className="flex flex-col">
          <span className="text-[9px] font-black text-slate-500 uppercase tracking-[0.5em] mb-1.5 opacity-60">Model</span>
          <div className="flex items-center gap-3">
            <span className="text-[12px] font-extrabold text-jb-accent uppercase tracking-[0.2em]">{backend}</span>
            {!isMobile && (
              <span className="text-[10px] font-mono font-bold text-slate-600 bg-white/5 px-2 py-0.5 rounded border border-white/10 uppercase tracking-widest">
                {backend === 'gemini' ? selectedCloudModel : selectedLocalModel}
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/SystemStatus.tsx
// ==========================================
import React, { useEffect, useState } from 'react';
import { FlaskConical, Wifi, AlertTriangle, Cloud, Cpu, Zap, Activity, BarChart3 } from 'lucide-react';
import { API_BASE_URL } from '../lib/config';
import { fetchWithRetry } from '../lib/api-client';
import { useAppStore } from '../store/useAppStore';

interface ServiceStatus {
  ollama: 'online' | 'offline' | 'unknown';
  gemini: 'configured' | 'missing_key' | 'unknown';
  search: 'configured' | 'missing_key' | 'unknown';
}

export const SystemStatus = () => {
  const { setSettingsOpen } = useAppStore();
  const [status, setStatus] = useState<ServiceStatus>({
    ollama: 'unknown',
    gemini: 'unknown',
    search: 'unknown'
  });
  const [overall, setOverall] = useState<'healthy' | 'degraded'>('healthy');
  
  // Model Awareness State
  const [modelStatus, setModelStatus] = useState({ status: 'primary', model: 'Cloud' });
  const [usage, setUsage] = useState({ tokens: 0, cost: 0, requests: 0 });

  const checkHealth = async () => {
    try {
      const data = await fetchWithRetry(`${API_BASE_URL}/health/services`, { retries: 1 });
      setStatus(data.services);
      setOverall(data.status);
    } catch (e) {
      setOverall('degraded');
      setStatus({ ollama: 'offline', gemini: 'unknown', search: 'unknown' });
    }
  };

  useEffect(() => {
    checkHealth();
    const interval = setInterval(checkHealth, 30000); // Check every 30s
    
    // Model Manager Integration
    if (window.electron?.model) {
       window.electron.model.getUsage().then(setUsage);
       const unsub = window.electron.model.onStatusChange((s) => setModelStatus(s));
       
       const usageInterval = setInterval(() => {
          window.electron?.model.getUsage().then(setUsage);
       }, 5000);
       
       return () => {
         clearInterval(interval);
         clearInterval(usageInterval);
         unsub();
       };
    }
    
    return () => clearInterval(interval);
  }, []);

  const StatusDot = ({ status }: { status: string }) => {
    const color = status === 'online' || status === 'configured' ? 'bg-green-500' : 'bg-red-500';
    return (
      <div className={`w-1.5 h-1.5 rounded-full ${color} shadow-[0_0_10px_rgba(34,197,94,0.6)] ${status === 'online' ? 'animate-pulse' : ''}`} />
    );
  };

  // Determine Signal Visuals
  const isFallback = modelStatus.status === 'fallback';
  const isLocal = modelStatus.model.toLowerCase().includes('ollama') || modelStatus.model.toLowerCase().includes('local');
  
  const SignalIcon = isFallback ? Zap : (isLocal ? Cpu : Cloud);
  const signalColor = isFallback ? 'text-yellow-400' : (isLocal ? 'text-green-400' : 'text-blue-400');
  const signalText = isFallback ? 'Failover Active' : (isLocal ? 'Local Neural' : 'Cloud Prime');

  return (
    <div className="bg-white/[0.03] border border-white/5 rounded-[24px] p-5 backdrop-blur-md relative overflow-hidden group">
      <div className="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent" />
      
      {/* Model Awareness Header */}
      <div className="flex items-center justify-between mb-4 pb-4 border-b border-white/5">
        <div className="flex items-center gap-2">
          <SignalIcon size={14} className={`${signalColor} drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]`} />
          <div className="flex flex-col">
             <span className="text-[10px] font-black text-white uppercase tracking-widest">{signalText}</span>
             <span className="text-[8px] font-bold text-slate-500 uppercase tracking-widest">{isFallback ? 'Recovering...' : 'Optimal'}</span>
          </div>
        </div>
        <div className={`w-2 h-2 rounded-full ${isFallback ? 'bg-yellow-400 animate-ping' : (overall === 'healthy' ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]' : 'bg-red-500')}`} />
      </div>

      <div className="space-y-3">
        <div className="flex items-center justify-between">
            <span className="text-[11px] font-bold text-slate-400">Ollama</span>
            <div className="flex items-center gap-1.5">
                <span className={`text-[10px] font-black uppercase tracking-wider ${status.ollama === 'online' ? 'text-jb-orange' : 'text-red-400'}`}>
                    {status.ollama === 'online' ? 'Online' : 'Offline'}
                </span>
                <StatusDot status={status.ollama} />
            </div>
        </div>
        
        {/* Gemini Status - Clickable if Missing Key */}
        <div className="flex items-center justify-between group/item">
            <span className="text-[11px] font-bold text-slate-400">Gemini</span>
            <div className="flex items-center gap-1.5">
                {status.gemini === 'missing_key' ? (
                  <button 
                    onClick={() => setSettingsOpen(true)}
                    className="text-[10px] font-black uppercase tracking-wider text-red-400 hover:text-red-300 hover:underline decoration-red-400/50 underline-offset-2 transition-all cursor-pointer flex items-center gap-1"
                  >
                    Missing Key
                  </button>
                ) : (
                  <span className={`text-[10px] font-black uppercase tracking-wider ${status.gemini === 'configured' ? 'text-jb-accent' : 'text-red-400'}`}>
                      {status.gemini === 'configured' ? 'Ready' : 'Error'}
                  </span>
                )}
                <StatusDot status={status.gemini} />
            </div>
        </div>
      </div>

      {/* Usage Monitor */}
      <div className="mt-4 pt-4 border-t border-white/5 space-y-2">
         <div className="flex justify-between items-center text-[10px]">
            <div className="flex items-center gap-1.5 text-slate-400">
               <BarChart3 size={10} />
               <span className="font-bold">Daily Usage</span>
            </div>
            <span className="font-mono text-jb-accent">{usage.requests} / 50</span>
         </div>
         <div className="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
            <div 
               className={`h-full ${usage.requests > 40 ? 'bg-red-500' : 'bg-gradient-to-r from-jb-accent to-jb-purple'}`}
               style={{ width: `${Math.min((usage.requests / 50) * 100, 100)}%` }} 
            />
         </div>
         <div className="flex justify-between text-[8px] text-slate-600 font-bold uppercase tracking-wider">
            <span>{usage.tokens.toLocaleString()} toks</span>
            <span>${usage.cost.toFixed(4)}</span>
         </div>
      </div>
    </div>
  );
};



// ==========================================
// File: ./frontend/src/components/CollaborateArea.tsx
// ==========================================
import React, { useState, useEffect, useRef } from 'react';
import { useAppStore } from '../store/useAppStore';
import { API_BASE_URL } from '../lib/config';
import { Users, Bot, Zap, Play, Loader2, ArrowRight, AlertCircle, Settings2, X, Network } from 'lucide-react';
import { cn } from '../lib/utils';
import { parse } from 'marked';
import { motion, AnimatePresence } from 'framer-motion';
import { KnowledgeMap } from './KnowledgeMap';

export const CollaborateArea = () => {
  const { deviceInfo } = useAppStore();
  const [isRunning, setIsRunning] = useState(false);
  const [steps, setSteps] = useState<{ agent: string, content: string, color: string }[]>([]);
  const [task, setTask] = useState("");
  const [error, setError] = useState<string | null>(null);
  const scrollRef = useRef<HTMLDivElement>(null);

  // Configuration State
  const [showConfig, setShowConfig] = useState(false);
  const [leadModel, setLeadModel] = useState<string>('gemini-3-pro-preview');
  const [criticModel, setCriticModel] = useState<string>('qwen2.5:3b');
  const [turns, setTurns] = useState<number>(5);
  const [availableModels, setAvailableModels] = useState<{ollama: any[], gemini: string[], deepseek: string[]}>({ ollama: [], gemini: [], deepseek: [] });

  useEffect(() => {
    fetch(`${API_BASE_URL}/models`)
      .then(res => res.json())
      .then(data => {
         setAvailableModels(data);
         if (!data.gemini?.includes(leadModel)) setLeadModel(data.gemini?.[0] || 'gemini-3-flash-preview');
         if (data.ollama?.length > 0) {
            const hasQwen = data.ollama.find((m: any) => m.name.includes('qwen'));
            setCriticModel(hasQwen ? hasQwen.name : data.ollama[0].name);
         }
      })
      .catch(err => console.error("Failed to fetch models", err));
  }, []);

  useEffect(() => {
    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [steps]);

  const callModel = async (modelName: string, history: any[], prompt: string) => {
    let provider = 'ollama';
    if (modelName.includes('gemini')) provider = 'gemini';
    if (modelName.includes('deepseek') && !modelName.includes(':')) provider = 'deepseek';

    try {
      const response = await fetch(`${API_BASE_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
           provider,
           model: modelName,
           messages: [...history, { role: 'user', content: prompt }],
           temperature: 0.7 
        })
      });
      
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Agent failed to respond.');
      return data.response || 'No response generated.';
    } catch (err: any) {
      throw new Error(err.message || 'Connection lost.');
    }
  };

  const handleRun = async () => {
    if (!task.trim()) return;
    setIsRunning(true);
    setSteps([]);
    setError(null);
    setShowConfig(false);

    let lastResponse = "";

    try {
      for (let i = 1; i <= turns; i++) {
         const isLead = i % 2 !== 0;
         const agentName = isLead ? `Lead Architect (${leadModel})` : `Critic (${criticModel})`;
         const color = isLead ? 'text-jb-accent' : 'text-jb-orange';
         const activeModel = isLead ? leadModel : criticModel;

         let prompt = "";
         if (i === 1) {
            prompt = `Task: "${task}". You are the Lead Architect. Propose a comprehensive, high-level solution structure and key components.`;
         } else if (!isLead) {
            prompt = `Review the previous proposal: \n\n"${lastResponse}"\n\n Identify potential flaws, security risks, or optimizations. Be critical and constructive.`;
         } else {
            prompt = `Based on the critique: \n\n"${lastResponse}"\n\n Refine and optimize the solution. Address the specific concerns raised.`;
         }

         const response = await callModel(activeModel, [], prompt);
         setSteps(prev => [...prev, { agent: agentName, content: response, color }]);
         lastResponse = response;
      }
    } catch (e: any) {
      console.error(e);
      setError(e.message);
    } finally {
      setIsRunning(false);
    }
  };

  return (
    <div className={cn(
      "flex flex-col h-full bg-jb-dark/50 backdrop-blur-3xl border-white/5 overflow-y-auto shadow-2xl transition-all duration-500 relative",
      deviceInfo.isMobile ? "p-4 pt-28 pb-32" : "rounded-tl-2xl border-l border-t p-8"
    )}>
      
      {/* Config Panel Overlay */}
      <AnimatePresence>
         {showConfig && (
            <motion.div 
               initial={{ opacity: 0, y: -10 }} 
               animate={{ opacity: 1, y: 0 }}
               exit={{ opacity: 0, y: -10 }}
               className={cn(
                  "absolute z-20 bg-slate-900/95 backdrop-blur-2xl border border-white/10 rounded-2xl p-6 shadow-2xl transition-all",
                  deviceInfo.isMobile ? "inset-x-4 top-28" : "top-20 right-8 w-80"
               )}
            >
               <div className="flex justify-between items-center mb-4">
                  <h3 className="text-xs font-black text-white uppercase tracking-widest">Configuration</h3>
                  {deviceInfo.isMobile && (
                     <button onClick={() => setShowConfig(false)} className="text-slate-500"><X size={16}/></button>
                  )}
               </div>
               
               <div className="space-y-4">
                  <div>
                     <label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Lead Agent</label>
                     <select 
                        value={leadModel} 
                        onChange={(e) => setLeadModel(e.target.value)}
                        className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none"
                     >
                        <optgroup label="Gemini (Cloud)">
                           {availableModels.gemini?.map(m => <option key={m} value={m}>{m}</option>)}
                        </optgroup>
                        <optgroup label="Local (Ollama)">
                           {availableModels.ollama?.map((m: any) => <option key={m.name} value={m.name}>{m.name}</option>)}
                        </optgroup>
                     </select>
                  </div>

                  <div>
                     <label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Critic Agent</label>
                     <select 
                        value={criticModel} 
                        onChange={(e) => setCriticModel(e.target.value)}
                        className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none"
                     >
                        <optgroup label="Local (Ollama)">
                           {availableModels.ollama?.map((m: any) => <option key={m.name} value={m.name}>{m.name}</option>)}
                        </optgroup>
                        <optgroup label="Gemini (Cloud)">
                           {availableModels.gemini?.map(m => <option key={m} value={m}>{m}</option>)}
                        </optgroup>
                     </select>
                  </div>

                  <div>
                     <div className="flex justify-between">
                        <label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Interaction Turns</label>
                        <span className="text-xs font-mono text-jb-accent">{turns}</span>
                     </div>
                     <input 
                        type="range" min="2" max="10" step="1" 
                        value={turns} 
                        onChange={(e) => setTurns(parseInt(e.target.value))}
                        className="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-jb-purple"
                     />
                  </div>
               </div>
            </motion.div>
         )}
      </AnimatePresence>

      <div className={cn(
        "flex mb-10 gap-6",
        deviceInfo.isMobile ? "flex-col items-start" : "items-center justify-between"
      )}>
        <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-jb-purple/20 rounded-2xl flex items-center justify-center border border-jb-purple/30 shrink-0">
                <Users className="text-jb-purple" size={24} />
            </div>
            <div>
                <h2 className="text-xl md:text-2xl font-black text-white tracking-tight">Multi-Agent Collaboration</h2>
                <p className="text-[9px] md:text-[11px] text-slate-500 font-bold uppercase tracking-widest">Orchestrating Hierarchical Intelligence</p>
            </div>
        </div>

        <div className={cn(
          "flex gap-3 w-full",
          deviceInfo.isMobile ? "flex-wrap" : "md:w-auto"
        )}>
            <input 
              value={task}
              onChange={(e) => setTask(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleRun()}
              className={cn(
                "bg-white/5 border border-white/10 rounded-xl px-6 py-3 text-sm outline-none focus:border-jb-purple transition-all text-white placeholder:text-slate-600 font-medium",
                deviceInfo.isMobile ? "flex-1 min-w-[200px]" : "w-[350px]"
              )}
              placeholder="Define the mission..."
            />
            <div className="flex gap-2">
               <button 
                  onClick={() => setShowConfig(!showConfig)}
                  className={cn(
                     "p-3 rounded-xl transition-all border border-white/10 hover:bg-white/5",
                     showConfig ? "bg-white/10 text-white" : "text-slate-500"
                  )}
               >
                  <Settings2 size={20} />
               </button>
               <button 
                   onClick={handleRun} 
                   disabled={isRunning || !task.trim()}
                   className="bg-jb-purple text-white hover:bg-fuchsia-600 px-8 py-3 rounded-xl font-black text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-20 shadow-xl grow"
               >
                   {isRunning ? <Loader2 className="animate-spin" size={16}/> : <Play size={16}/>}
                   {isRunning ? 'Deploying' : 'Deploy'}
               </button>
            </div>
        </div>
      </div>

      <div className={cn(
        "flex-1 space-y-8 pb-10 scrollbar-hide",
        deviceInfo.isMobile ? "" : "pr-4"
      )} ref={scrollRef}>
        <AnimatePresence>
          {steps.map((step, i) => (
            <motion.div 
              key={i}
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              className={cn(
                "relative",
                deviceInfo.isMobile ? "pl-0" : "pl-10"
              )}
            >
               {!deviceInfo.isMobile && i < steps.length - 1 && (
                  <div className="absolute left-[19px] top-10 bottom-[-32px] w-px bg-white/5" />
               )}
               
               {!deviceInfo.isMobile && (
                 <div className="absolute left-0 top-1 w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center">
                    <span className="text-[10px] font-black text-slate-500">{i + 1}</span>
                 </div>
               )}

               <div className={cn(
                 "bg-white/2 border border-white/5 rounded-[32px] shadow-2xl",
                 deviceInfo.isMobile ? "p-6" : "p-8"
               )}>
                  <div className={cn("font-black text-xs uppercase tracking-[0.2em] mb-4 flex items-center gap-2", step.color)}>
                     <Bot size={14} /> {step.agent}
                  </div>
                  <div className="prose prose-invert prose-sm max-w-none text-slate-300 leading-relaxed" dangerouslySetInnerHTML={{ __html: parse(step.content || '') as string }} />
               </div>
            </motion.div>
          ))}
        </AnimatePresence>
        
        {error && (
            <div className={cn(
              "flex items-center gap-3 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-sm",
              deviceInfo.isMobile ? "" : "ml-10"
            )}>
                <AlertCircle size={18} />
                <span className="font-bold">Execution Error:</span> {error}
            </div>
        )}

        {isRunning && (
           <div className={cn(
             "flex items-center gap-4",
             deviceInfo.isMobile ? "" : "pl-10"
           )}>
              <div className="w-10 h-10 rounded-full bg-jb-purple/10 border border-jb-purple/20 flex items-center justify-center shrink-0">
                 <Loader2 size={16} className="text-jb-purple animate-spin" />
              </div>
              <span className="text-[10px] font-black uppercase tracking-[0.4em] text-slate-600 animate-pulse">Syncing Cognitive Nodes</span>
           </div>
        )}

        {!isRunning && steps.length === 0 && !error && (
          <div className="absolute inset-0 top-32 flex flex-col items-center justify-center pointer-events-none">
             <div className="absolute inset-0 opacity-30">
                <KnowledgeMap />
             </div>
             <div className="relative z-10 text-center space-y-4">
               <div className="bg-black/60 backdrop-blur-md px-6 py-4 rounded-2xl border border-white/10 shadow-2xl inline-block">
                 <Network size={48} className="mx-auto mb-4 text-slate-500" />
                 <p className="font-bold text-sm text-slate-300">Mission Map Active</p>
                 <p className="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Ready for Agent Deployment</p>
               </div>
             </div>
          </div>
        )}
      </div>
    </div>
  );
};


// ==========================================
// File: ./frontend/src/components/ChatView.tsx
// ==========================================
import React, { useEffect, useRef } from 'react';
import { useAppStore } from '../store/useAppStore';
import { AnimatePresence } from 'framer-motion';
import { ChatHeader } from './ChatHeader';
import { ChatInput } from './ChatInput';
import { MessageItem } from './MessageItem';
import { cn } from '../lib/utils';

export const ChatView = () => {
  const { messages, isProcessing, backend, selectedCloudModel, selectedLocalModel, deviceInfo } = useAppStore();
  const scrollRef = useRef<HTMLDivElement>(null);

  const isMobile = deviceInfo.isMobile;

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages, isProcessing]);

  const downloadImage = async (url: string, fileName: string) => {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = blobUrl;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(blobUrl);
    } catch (error) {
      console.error('Download failed:', error);
    }
  };

  const getTime = () => {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="flex flex-col h-full relative bg-transparent neural-scan overflow-hidden">
      <ChatHeader />

      {/* Messages */}
      <div className={cn(
        "flex-1 overflow-y-auto pt-44 pb-32 space-y-16 scrollbar-thin scroll-smooth",
        isMobile ? "p-6" : "p-12"
      )} ref={scrollRef}>
        {/* Invisible spacer to ensure first message is well below the header */}
        <div className="h-4 w-full shrink-0" />
        
        <AnimatePresence initial={false}>
          {messages.map((m, i) => (
            <MessageItem 
              key={i}
              message={m}
              isUser={m.role === 'user'}
              modelName={m.role === 'user' ? 'User' : (backend === 'gemini' ? selectedCloudModel : selectedLocalModel)}
              time={getTime()}
              onDownloadImage={downloadImage}
            />
          ))}
        </AnimatePresence>
        
        {isProcessing && (
           <div className="max-w-4xl mx-auto flex items-center gap-6 px-6">
              <span className="text-[10px] font-black uppercase tracking-[0.5em] text-slate-500 animate-pulse">Processing...</span>
           </div>
        )}
      </div>

      <ChatInput />
    </div>
  );
};


// ==========================================
// File: ./frontend/src/types/electron.d.ts
// ==========================================
export {};

declare global {
  interface Window {
    electron?: {
      platform: string;
      minimize: () => void;
      maximize: () => void;
      close: () => void;
      saveNotepad: (content: string) => void;
      getNotepad: () => Promise<string>;
      onNotepadUpdated: (callback: (content: string) => void) => () => void;
      // Supervisor
      reportActivity: (activity: any) => void;
      logAction: (action: any) => void;
      setMissionGoal: (goal: string) => void;
      getMissionContext: () => Promise<any>;
      onSupervisorNudge: (callback: (nudge: any) => void) => () => void;
      onSupervisorData: (callback: (data: any) => void) => () => void;
      model: {
        execute: (tier: string, messages: any[]) => Promise<any>;
        getPreference: (tier: string) => Promise<any>;
        setPreference: (tier: string, prefs: any) => Promise<void>;
        getUsage: () => Promise<any>;
        resetUsage: () => Promise<void>;
        onStatusChange: (callback: (status: { status: string, model: string }) => void) => () => void;
      };
    };
  }
}



// ==========================================
// File: ./frontend/src/main.tsx
// ==========================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ChatArea } from './components/ChatArea';
import './index.css';

console.log('âœ… React App Mounted Successfully');

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <div className="h-[100dvh] w-screen bg-slate-950">
      <ChatArea />
    </div>
  </React.StrictMode>,
);



// ==========================================
// File: ./frontend/src/store/useAppStore.test.ts
// ==========================================
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { useAppStore } from './useAppStore';

// Mock fetch
global.fetch = vi.fn();

describe('useAppStore', () => {
  beforeEach(() => {
    // Reset store state before each test if possible or just clear messages
    useAppStore.setState({
      messages: [],
      isProcessing: false,
    });
    vi.clearAllMocks();
  });

  it('should add a message', () => {
    const { addMessage } = useAppStore.getState();
    addMessage({ role: 'user', content: 'Hello' });
    expect(useAppStore.getState().messages).toHaveLength(1);
    expect(useAppStore.getState().messages[0].content).toBe('Hello');
  });

  it('should handle sendMessage success', async () => {
    (global.fetch as any).mockResolvedValue({
      ok: true,
      json: async () => ({ response: 'AI Response' }),
    });

    const { sendMessage } = useAppStore.getState();
    await sendMessage('Hello AI');

    const state = useAppStore.getState();
    expect(state.messages).toHaveLength(2); // User + Assistant
    expect(state.messages[1].content).toBe('AI Response');
    expect(state.isProcessing).toBe(false);
  });

  it('should handle sendMessage failure', async () => {
    (global.fetch as any).mockResolvedValue({
      ok: false,
      json: async () => ({ error: 'Service Unavailable' }),
    });

    const { sendMessage } = useAppStore.getState();
    await sendMessage('Hello AI');

    const state = useAppStore.getState();
    expect(state.messages).toHaveLength(2);
    expect(state.messages[1].content).toContain('Error: Service Unavailable');
  });
});



// ==========================================
// File: ./frontend/src/store/useAppStore.ts
// ==========================================
import { create } from 'zustand';

export interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
  image?: string | null;
  thinking?: string;
  isGeneratedImage?: boolean;
  imageUrl?: string;
}

export interface GraphNode {
  id: string;
  title: string;
  description?: string;
  mode?: string;
  x?: number;
  y?: number;
}

export interface GraphEdge {
  source: string;
  target: string;
  data?: string; // Raw text or JSON of communication
}

export interface DeviceInfo {
  isMobile: boolean;
  isTablet: boolean;
  isDesktop: boolean;
  windowSize: {
    width: number;
    height: number;
  };
}

interface AppState {
  messages: Message[];
  isProcessing: boolean;
  backend: 'gemini' | 'ollama' | 'deepseek' | 'openrouter';
  currentMode: 'chat' | 'browser' | 'deep_thought' | 'debate' | 'compare' | 'collaborate' | 'vision' | 'waterfall' | 'coding';
  smartRouterEnabled: boolean;
  selectedLocalModel: string;
  selectedCloudModel: string;
  selectedOpenRouterModel: string;
  modeConfigs: Record<string, { provider: 'gemini' | 'ollama' | 'deepseek' | 'openrouter' | 'auto', model: string }>;
  temperature: number;
  maxTokens: number;
  settingsOpen: boolean;
  auraMode: 'off' | 'static' | 'organic';
  notepadContent: string;
  globalProvider: 'cloud' | 'local' | 'auto';
  deviceInfo: DeviceInfo;
  
  // Graph State
  graphNodes: GraphNode[];
  graphEdges: GraphEdge[];
  showKnowledgeMap: boolean;
  supervisorInsight: string | null; // New state for nudges
  activities: any[]; // History of reported actions
  addGraphNode: (node: GraphNode) => void;
  addGraphEdge: (edge: GraphEdge) => void;
  setGraphData: (nodes: GraphNode[], edges: GraphEdge[]) => void;
  setShowKnowledgeMap: (show: boolean) => void;
  setSupervisorInsight: (insight: string | null) => void;
  addActivity: (activity: any) => void;
  setNotepadContent: (content: string) => void;

  addMessage: (message: Message) => void;
  updateLastMessage: (content: string) => void;
  setMessages: (messages: Message[]) => void;
  setIsProcessing: (isProcessing: boolean) => void;
  setBackend: (backend: 'gemini' | 'ollama' | 'deepseek' | 'openrouter') => void;
  setCurrentMode: (mode: any) => void;
  setSmartRouterEnabled: (enabled: boolean) => void;
  setSelectedLocalModel: (model: string) => void;
  setSelectedCloudModel: (model: string) => void;
  setSelectedOpenRouterModel: (model: string) => void;
  setTemperature: (temp: number) => void;
  setMaxTokens: (tokens: number) => void;
  setSettingsOpen: (open: boolean) => void;
  setAuraMode: (auraMode: 'off' | 'static' | 'organic') => void;
  setGlobalProvider: (provider: 'cloud' | 'local' | 'auto') => void;
  setModeConfig: (mode: string, config: { provider: 'gemini' | 'ollama' | 'deepseek' | 'openrouter' | 'auto', model: string }) => void;
  setDeviceInfo: (info: DeviceInfo) => void;
  
  // Actions
  sendMessage: (content: string, image?: string | null) => Promise<void>;
  generateImageAction: (prompt: string) => Promise<void>;
}

export const useAppStore = create<AppState>((set, get) => ({
  messages: [],
  isProcessing: false,
  backend: 'gemini',
  currentMode: 'chat',
  smartRouterEnabled: true,
  selectedLocalModel: 'qwen2.5:3b',
  selectedCloudModel: 'gemini-3-pro-preview',
  selectedOpenRouterModel: 'qwen/qwen-2.5-coder-32b-instruct:free',
  modeConfigs: {
    chat: { provider: 'auto', model: 'gemini-3-pro-preview' },
    vision: { provider: 'gemini', model: 'gemini-3-flash-preview' },
    deep_thought: { provider: 'auto', model: 'gemini-3-pro-preview' },
    browser: { provider: 'gemini', model: 'gemini-3-flash-preview' },
    waterfall: { provider: 'auto', model: 'gemini-3-pro-preview' },
    coding: { provider: 'auto', model: 'gemini-3-pro-preview' },
  },
  temperature: 0.7,
  maxTokens: 2048,
  settingsOpen: false,
  auraMode: 'off',
  notepadContent: "",
  globalProvider: 'auto',
  deviceInfo: {
    isMobile: false,
    isTablet: false,
    isDesktop: true,
    windowSize: { width: 0, height: 0 }
  },
  
  graphNodes: [],
  graphEdges: [],
  showKnowledgeMap: false,
  supervisorInsight: null,
  activities: [],

  addGraphNode: (node) => set((state) => ({
    graphNodes: [...state.graphNodes.filter(n => n.id !== node.id), node]
  })),
  addGraphEdge: (edge) => set((state) => ({
    graphEdges: [...state.graphEdges, edge]
  })),
  setGraphData: (nodes, edges) => set({ graphNodes: nodes, graphEdges: edges }),
  setShowKnowledgeMap: (show) => set({ showKnowledgeMap: show }),
  setSupervisorInsight: (insight) => set({ supervisorInsight: insight }),
  addActivity: (activity) => set((state) => ({ activities: [activity, ...state.activities].slice(0, 100) })),
  setNotepadContent: (content) => set({ notepadContent: content }),

  addMessage: (message) => set((state) => ({ messages: [...state.messages, message] })),
  updateLastMessage: (content) => set((state) => {
    const newMessages = [...state.messages];
    if (newMessages.length > 0) {
      newMessages[newMessages.length - 1].content += content;
    }
    return { messages: newMessages };
  }),
  setMessages: (messages) => set({ messages }),
  setIsProcessing: (isProcessing) => set({ isProcessing }),
  setBackend: (backend) => set({ backend }),
  setCurrentMode: (mode) => set({ currentMode: mode }),
  setSmartRouterEnabled: (enabled) => set({ smartRouterEnabled: enabled }),
  setSelectedLocalModel: (model) => set({ selectedLocalModel: model }),
  setSelectedCloudModel: (model) => set({ selectedCloudModel: model }),
  setSelectedOpenRouterModel: (model) => set({ selectedOpenRouterModel: model }),
  setTemperature: (temperature) => set({ temperature }),
  setMaxTokens: (maxTokens) => set({ maxTokens }),
  setSettingsOpen: (settingsOpen) => set({ settingsOpen }),
  setAuraMode: (auraMode) => set({ auraMode }),
  setGlobalProvider: (globalProvider) => set({ globalProvider }),
  setModeConfig: (mode, config) => set((state) => ({
    modeConfigs: { ...state.modeConfigs, [mode]: config }
  })),
  setDeviceInfo: (deviceInfo) => set({ deviceInfo }),
  sendMessage: async (content: string, image: string | null = null) => {
    const { 
      messages, addMessage, setIsProcessing, currentMode, 
      modeConfigs, selectedCloudModel, selectedLocalModel,
      globalProvider, temperature, maxTokens,
      graphNodes, graphEdges, setGraphData,
      deviceInfo, notepadContent
    } = get();

    if (get().isProcessing) return;

    // Config Resolution
    const config = modeConfigs[currentMode] || { provider: 'auto', model: selectedCloudModel };
    let provider = config.provider;
    let model = config.model;

    if (provider === 'auto') {
       if (globalProvider === 'local') {
          provider = 'ollama';
          model = selectedLocalModel;
       } else {
          provider = 'gemini';
          model = selectedCloudModel;
       }
    } else {
       if (globalProvider === 'local' && provider === 'gemini') {
          provider = 'ollama';
          model = selectedLocalModel;
       }
    }

    const smartRouter = config.provider === 'auto' && provider === 'gemini';
    const userMessage: Message = { role: 'user', content, image };
    
    addMessage(userMessage);
    setIsProcessing(true);

    // Log to Supervisor
    if (window.electron?.logAction) {
       window.electron.logAction({ type: 'user_message', content, mode: currentMode });
    }

    try {
      const { fetchWithRetry } = await import('../lib/api-client');
      const { API_BASE_URL } = await import('../lib/config');
      const data = await fetchWithRetry(`${API_BASE_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          provider,
          model,
          messages: [...messages, userMessage],
          image,
          mode: currentMode,
          smartRouter,
          temperature,
          maxTokens,
          deviceInfo,
          notepadContent
        }),
        retries: 3
      });
      
      if (!data.response) throw new Error('Invalid response from server.');

      let finalResponse = data.response;
      
      // Parse for Notepad Updates
      const notepadMatch = finalResponse.match(/<update_notepad>([\s\S]*?)<\/update_notepad>/);
      if (notepadMatch && notepadMatch[1]) {
         const newContent = notepadMatch[1].trim();
         get().setNotepadContent(newContent);
         // Clean the response for the UI
         finalResponse = finalResponse.replace(/<update_notepad>[\s\S]*?<\/update_notepad>/, '').trim();
      }

      addMessage({ role: 'assistant', content: finalResponse });

      const { parseGraphData } = await import('../lib/graph-parser');
      const newGraph = parseGraphData(data.response); // Use original for graph parser to be safe
      if (newGraph && newGraph.nodes) {
         const mergedNodes = [...graphNodes];
         newGraph.nodes.forEach((newNode: any) => {
            if (!mergedNodes.find(n => n.id === newNode.id)) {
               mergedNodes.push(newNode);
            }
         });
         const mergedEdges = [...graphEdges, ...(newGraph.edges || [])];
         setGraphData(mergedNodes, mergedEdges);
      }
    } catch (error: any) {
      const errorMessage = error.body?.error || error.message || 'Service unavailable.';
      const statusText = error.status ? ` [Status: ${error.status}]` : '';
      addMessage({ role: 'assistant', content: `Error: ${errorMessage}${statusText}` });
    } finally {
      setIsProcessing(false);
    }
  },

  generateImageAction: async (prompt: string) => {
    const { addMessage, setIsProcessing } = get();

    addMessage({ role: 'user', content: `Generate an image of: ${prompt}` });
    setIsProcessing(true);

    try {
      const { fetchWithRetry } = await import('../lib/api-client');
      const { API_BASE_URL } = await import('../lib/config');
      const data = await fetchWithRetry(`${API_BASE_URL}/generate-image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
        retries: 2
      });
      
      if (data.imageUrl) {
        addMessage({ 
          role: 'assistant', 
          content: `Here is the image I generated for: "${prompt}"`,
          isGeneratedImage: true,
          imageUrl: data.imageUrl
        });
      } else {
        throw new Error(data.error || 'Failed to generate image');
      }
    } catch (error: any) {
      const errorMessage = error.body?.error || error.message || 'Image generation failed.';
      const statusText = error.status ? ` [Status: ${error.status}]` : '';
      addMessage({ role: 'assistant', content: `Error: ${errorMessage}${statusText}` });
    } finally {
      setIsProcessing(false);
    }
  }
}));



// ==========================================
// File: ./frontend/vite.config.ts
// ==========================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  base: './',
  server: {
    host: true,
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        secure: false,
      },
      '/files': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        secure: false,
      },
      '/generated_images': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        secure: false,
      },
    },
    headers: {
      'Cross-Origin-Embedder-Policy': 'require-corp',
      'Cross-Origin-Opener-Policy': 'same-origin',
    },
  }
})



// ==========================================
// File: ./frontend/postcss.config.js
// ==========================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}



// ==========================================
// File: ./frontend/package.json
// ==========================================
{
  "name": "solvent-ai-frontend",
  "version": "1.0.0",
  "type": "module",
  "description": "",
  "scripts": {
    "dev": "vite --host",
    "test": "vitest run",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "desktop": "cd .. && npm run desktop"
  },
  "dependencies": {
    "@monaco-editor/react": "^4.7.0",
    "@types/d3": "^7.4.3",
    "@webcontainer/api": "^1.6.1",
    "clsx": "^2.1.1",
    "d3": "^7.9.0",
    "framer-motion": "^12.25.0",
    "lucide-react": "^0.378.0",
    "marked": "^12.0.2",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-rnd": "^10.5.2",
    "tailwind-merge": "^2.3.0",
    "zustand": "^4.5.2"
  },
  "devDependencies": {
    "@tailwindcss/typography": "^0.5.19",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@types/react": "^18.3.1",
    "@types/react-dom": "^18.3.1",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.23",
    "jsdom": "^27.4.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.4.5",
    "vite": "^7.3.1",
    "vitest": "^4.0.17"
  }
}



// ==========================================
// File: ./frontend/tsconfig.json
// ==========================================
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "exclude": ["src/**/*.test.ts", "src/**/*.test.tsx"]
}



// ==========================================
// File: ./frontend/index.html
// ==========================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: http://localhost:3001 ws://localhost:5173 http://localhost:5173 https://fonts.googleapis.com https://fonts.gstatic.com https://grainy-gradients.vercel.app;">
    <title>Solvent AI</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>



// ==========================================
// File: ./frontend/tailwind.config.js
// ==========================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        jb: {
          dark: '#020205',      // Deepest black for contrast
          panel: '#0A0B10',     
          hover: '#12141C',     
          border: '#1E202A',    
          text: '#C0C2C8',      
          accent: '#3C71F7',    // Electric Blue
          purple: '#9D5BD2',    // Deep Purple
          pink: '#F43F5E',      // Vibrant Rose/Pink
          orange: '#FB923C',    // Soft Neon Orange
          cyan: '#06B6D4',      
        }
      },
      fontFamily: {
        mono: ['JetBrains Mono', 'monospace'],
        sans: ['Plus Jakarta Sans', 'Inter', 'sans-serif'],
      },
      animation: {
        'blob': 'blob 25s infinite',
        'slow-spin': 'spin 40s linear infinite',
        'border-flow': 'border-flow 4s linear infinite',
      },
      keyframes: {
        blob: {
          '0%, 100%': { transform: 'translate(0px, 0px) scale(1)' },
          '33%': { transform: 'translate(60px, -80px) scale(1.15)' },
          '66%': { transform: 'translate(-40px, 40px) scale(0.9)' },
        },
        'border-flow': {
          '0%': { backgroundPosition: '0% 50%' },
          '100%': { backgroundPosition: '200% 50%' },
        }
      }
    },
  },
  plugins: [
    require('@tailwindcss/typography'),
  ],
}



// ==========================================
// File: ./package.json
// ==========================================
{
  "name": "solvent-ai-v1-production",
  "version": "1.0.0",
  "description": "Solvent AI Desktop Suite",
  "main": "electron/main.ts",
  "scripts": {
    "dev:frontend": "cd frontend && npm run dev",
    "dev:backend": "cd backend && npm run dev",
    "build:electron": "esbuild electron/preload.ts --outfile=electron/preload.js --bundle --platform=node --external:electron && esbuild electron/main.ts --outfile=electron/main.js --bundle --platform=node --external:electron",
    "desktop": "npm run build:electron && electron electron/main.js",
    "build:frontend": "cd frontend && npm run build"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "electron": "^39.2.7",
    "electron-builder": "^26.4.0",
    "esbuild": "^0.27.2",
    "tsx": "^4.21.0"
  },
  "dependencies": {
    "electron-store": "^11.0.2"
  }
}



// ==========================================
// File: ./README.md
// ==========================================
# Solvent AI

Solvent AI is a **smart, hierarchical AI assistant** designed to seamlessly switch between cloud-based reasoning (Gemini Pro/Vision) and local privacy-focused models (Ollama/Qwen).

## ðŸš€ Features

- **Smart Router:** Automatically routes queries between Gemini (Cloud) and Ollama (Local) based on complexity, availability, and user mode.
- **Deep Thought Mode:** Enforces a "Chain of Thought" reasoning process for complex queries.
- **Graph Extraction:** Visualizes relationships in your data by extracting knowledge graphs from AI responses.
- **Browser Mode:** Injects real-time search results (via Serper) into the context for up-to-date answers.
- **Vision Support:** Multimodal capabilities using Gemini Vision.

## ðŸ— Architecture

This project is structured as a monorepo:

- **`frontend/`**: React + TypeScript + Tailwind CSS application. Features a modern "Bento" UI and interactive graph visualization.
- **`backend/`**: Node.js + Express + TypeScript API. Handles API routing, prompt engineering, and service orchestration.

## ðŸ› ï¸ Tech Stack

- **Frontend:** React, Vite, Lucide React, Zustand (Store)
- **Backend:** Express, Zod (Validation), Dotenv
- **AI Services:** Google Gemini API, Ollama (Local), Serper.dev (Search)

## âš¡ Getting Started

### Prerequisites
- Node.js (v18+)
- Ollama (running locally)
- Google AI Studio API Key
- Serper API Key (optional, for web search)

### Installation

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/yourusername/solvent-ai.git
    cd solvent-ai
    ```

2.  **Setup Backend:**
    ```bash
    cd backend
    npm install
    # Create .env file with your API keys
    npm run dev
    ```

3.  **Setup Frontend:**
    ```bash
    cd frontend
    npm install
    npm run dev
    ```

## ðŸ“ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.



// ==========================================
// File: ./TODO.md
// ==========================================
# TODO: Gemini Image Generation Implementation

## Backend
- [x] Investigate current backend image generation logic (if any).
- [x] Install/Verify Gemini API dependencies.
- [x] Implement Gemini image generation service.
- [x] Create `generated_images` directory and ensure it's served.
- [x] Update API endpoint to use Gemini and save images locally.

## Frontend
- [x] Update image generation request logic.
- [x] Display generated image in the UI.
- [x] Add "Download" button for the generated image.

## Resilience & UX
- [x] Centralized .env validation (Backend)
- [x] Service Health Check Endpoint (/health/services)
- [x] System Status UI in Navigation

## Verification
- [x] Test end-to-end flow. (Verified with mock, real Gemini hit quota)
- [x] Verify image saving and retrieval. (Passed)


// ==========================================
// File: ./GEMINI.md
// ==========================================
# Project Context: Solvent AI

## Tech Stack
- **Backend:** Node.js, Express, TypeScript
- **Frontend:** React, TypeScript, Tailwind CSS (inferred from BentoGrid/Lucide)
- **AI:** Gemini Pro, Gemini Vision, Ollama (Local Fallback)
- **Services:** Serper API (Search)

## Architecture
- **Monorepo-style:** `backend/` and `frontend/` directories.
- **Smart Router:** Switches between Gemini and Ollama based on availability/cost.

## Workflow
@./VIBE.md



// ==========================================
// File: ./VIBE.md
// ==========================================
# Vibecode Workflow

## Role
- Act as a Senior Partner.
- Be hierarchical and additive in your context.
- Be autonomous: propose plans, implement them, and verify.

## Protocol
- **Prompt Optimization:** Internally refine and optimize the user's prompt for clarity and effectiveness before execution, then proceed immediately with the improved objective.
- **Checkpoint Review:** After reaching significant milestones, major code changes, or upon request, review the current codebase and suggest 1-3 architectural improvements or the next logical task.

## Style
- Use bold fonts for emphasis.
- Keep responses concise but impactful.
- Prioritize "Auto-Load" context awareness.


// ==========================================
// File: ./backend/src/routes/fileRoutes.ts
// ==========================================
import express, { Request, Response } from 'express';
import multer from 'multer';
import path from 'path';
import { fileService } from '../services/fileService';

const router = express.Router();

// --- Storage Config ---
const storage = multer.diskStorage({
  destination: async (req: Request, file: Express.Multer.File, cb: (error: Error | null, destination: string) => void) => {
    const uploadDir = fileService.getUploadDir();
    await fileService.ensureUploadDir();
    cb(null, uploadDir);
  },
  filename: (req: Request, file: Express.Multer.File, cb: (error: Error | null, filename: string) => void) => {
    const safeName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
    cb(null, Date.now() + '-' + safeName);
  }
});

const upload = multer({ 
  storage: storage,
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB limit
});

// --- ROUTES ---

// A. Upload & Read
router.post('/upload', upload.single('file'), async (req: Request, res: Response) => {
  try {
    if (!req.file) {
       res.status(400).json({ error: 'No file uploaded' });
       return;
    }

    const fullPath = path.join(req.file.destination, req.file.filename);
    const extractedText = await fileService.extractText(fullPath, req.file.mimetype, req.file.originalname);

    // Trim to 20k chars for response
    const previewText = extractedText.length > 0 ? extractedText.slice(0, 20000) : null;

    res.json({ 
        message: 'File uploaded & parsed', 
        filename: req.file.filename,
        url: `/files/${req.file.filename}`,
        content: previewText 
    });

  } catch (error: any) {
    console.error("Upload Error:", error);
    res.status(500).json({ error: error.message });
  }
});

// B. List Files
router.get('/list', async (req: Request, res: Response) => {
  try {
    const fileInfos = await fileService.listFiles();
    res.json(fileInfos);
  } catch (error) {
    res.status(500).json({ message: 'Error scanning files' });
  }
});

// C. Download
router.get('/download/:name', (req: Request, res: Response) => {
  const directoryPath = fileService.getUploadDir();
  const filePath = path.join(directoryPath, req.params.name);
  
  res.download(filePath, req.params.name, (err) => {
    if (err && !res.headersSent) {
      res.status(500).send({ message: "Download failed." });
    }
  });
});

// D. Delete
router.delete('/:name', async (req: Request, res: Response) => {
  try {
    await fileService.deleteFile(req.params.name);
    res.json({ message: 'File deleted' });
  } catch (error) {
    res.status(500).json({ message: 'Delete failed' });
  }
});

export default router;



// ==========================================
// File: ./backend/src/routes/aiRoutes.ts
// ==========================================
import { Router } from 'express';
import { AIController } from '../controllers/aiController';

const router = Router();

router.post('/chat', AIController.chat);
// router.post('/chat/stream', AIController.chatStream);
router.post('/compare', AIController.compare);
router.post('/generate-image', AIController.generateImage);
router.post('/waterfall', AIController.waterfall);
router.get('/models', AIController.listModels);
router.get('/health/services', AIController.checkHealth);

export default router;



// ==========================================
// File: ./backend/src/server.ts
// ==========================================
import { config } from './config'; // Removed .js for safety
import express from 'express';
import cors from 'cors';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// --- Import Routes ---
// We removed the .js extension here so it automatically finds fileRoutes.ts
import fileRoutes from './routes/fileRoutes'; 
import aiRoutes from './routes/aiRoutes';

// --- Fix for __dirname in ES Modules ---
// We are in CommonJS mode now due to tsconfig, so these are globals.
// const __filename = fileURLToPath(import.meta.url);
// const __dirname = path.dirname(__filename);

// --- Initialize App ---
const app = express();
const port = config.PORT || 3001;

// --- Middleware ---
app.use(cors());
app.use(express.json({ limit: '50mb' }));

// --- Directory Setup ---
// FIX 1: Go up one level (..) to reach the project root
const generatedImagesDir = path.join(__dirname, '../generated_images');
const uploadDir = path.join(__dirname, '../uploads'); 

// Ensure directories exist
if (!fs.existsSync(generatedImagesDir)) fs.mkdirSync(generatedImagesDir, { recursive: true });
if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir, { recursive: true });

// --- Static Files ---
app.use('/generated_images', express.static(generatedImagesDir));
// FIX 2: Now this matches where the route saves files
app.use('/files', express.static(uploadDir));

// --- API Routes ---
app.use('/api/v1', aiRoutes);
app.use('/api/files', fileRoutes);

// --- Health Check ---
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// --- Start Server ---
app.listen(port, '0.0.0.0', () => {
  console.log(`Server is running on http://0.0.0.0:${port}`);
});



// ==========================================
// File: ./backend/src/test-gemini.ts
// ==========================================
import { GeminiService } from './services/geminiService';

async function test() {
  console.log("Testing Gemini Service...");
  const service = new GeminiService();
  
  const models = ['gemini-3-pro-preview', 'gemini-2.0-flash', 'gemini-flash-latest'];

  for (const modelName of models) {
    console.log(`\nTesting model: ${modelName}`);
    try {
      const response = await service.generateChatCompletion(
        [{ role: 'user', content: 'Hello' }],
        modelName, 
        false
      );
      console.log(`Success (${modelName}):`, response);
      return; // Stop on first success
    } catch (error: any) {
      console.error(`Failed (${modelName}):`, error.message);
    }
  }
}

test();


// ==========================================
// File: ./backend/src/config.ts
// ==========================================
import { z } from 'zod';
import dotenv from 'dotenv';
import path from 'path';

// Load .env from project root
dotenv.config({ path: path.resolve(__dirname, '../../.env') });

const envSchema = z.object({
  PORT: z.string().transform(Number).default('3001'),
  GEMINI_API_KEY: z.string().min(1, "GEMINI_API_KEY is required"),
  // Optional keys
  SERPER_API_KEY: z.string().optional(),
  DEEPSEEK_API_KEY: z.string().optional(),
  OLLAMA_HOST: z.string().default('http://127.0.0.1:11434'),
  // Feature flags
  ENABLE_OLLAMA: z.string().transform(v => v === 'true').default('true'),
});

const parsedEnv = envSchema.safeParse(process.env);

if (!parsedEnv.success) {
  console.error('âŒ Invalid environment variables:', JSON.stringify(parsedEnv.error.format(), null, 2));
  process.exit(1);
}

export const config = parsedEnv.data;



// ==========================================
// File: ./backend/src/controllers/aiController.ts
// ==========================================
import { Request, Response } from 'express';
import { aiService } from '../services/aiService';
import { z } from 'zod';

const chatSchema = z.object({
  provider: z.enum(['gemini', 'ollama', 'deepseek', 'openrouter']),
  model: z.string(),
  mode: z.string().optional(),
  image: z.string().nullable().optional(),
  smartRouter: z.boolean().optional(),
  fallbackModel: z.string().optional(),
  messages: z.array(z.object({
    role: z.string(),
    content: z.string(),
    image: z.string().nullable().optional()
  })),
  temperature: : z.number().optional(),
  maxTokens: z.number().optional(),
  notepadContent: z.string().optional(),
  deviceInfo: z.object({
    isMobile: z.boolean(),
    isTablet: z.boolean(),
    isDesktop: z.boolean(),
    windowSize: z.object({
      width: z.number(),
      height: z.number()
    })
  }).optional()
});

const imageSchema = z.object({
  prompt: z.string(),
  model: z.string().optional()
});

export class AIController {
  
  static async checkHealth(req: Request, res: Response) {
    const models = await aiService.listAvailableModels();
    const status = models.ollama.length > 0 ? 'healthy' : 'degraded';
    res.json({ 
      status, 
      timestamp: new Date().toISOString(),
      services: {
        ollama: models.ollama.length > 0 ? 'online' : 'offline',
        gemini: 'configured',
        search: 'configured'
      }
    });
  }

  static async generateImage(req: Request, res: Response) {
    try {
      const { prompt, model } = imageSchema.parse(req.body);
      const result = await aiService.generateImage(prompt, model, req.get('host'), req.protocol);
      res.json(result);
    } catch (error: any) {
      res.status(500).json({ error: error.message || 'Failed to generate image' });
    }
  }

  static async chat(req: Request, res: Response) {
    try {
      const data = chatSchema.parse(req.body);
      const result = await aiService.processChat(data);
      res.json(result);
    } catch (error: any) {
      console.error('[AIController] Chat Error:', error);
      res.status(500).json({ error: error.message || 'Internal Server Error' });
    }
  }

  static async compare(req: Request, res: Response) {
    try {
      const result = await aiService.compareModels(req.body.messages);
      res.json(result);
    } catch (error) {
      res.status(500).json({ error: 'Comparison failed.' });
    }
  }

  static async listModels(req: Request, res: Response) {
    try {
      const result = await aiService.listAvailableModels();
      res.json(result);
    } catch (error: any) {
      res.status(500).json({ error: 'Failed to list models.' });
    }
  }

  static async waterfall(req: Request, res: Response) {
    try {
      const { prompt, globalProvider } = req.body;
      const result = await aiService.runWaterfall(prompt, globalProvider);
      res.json(result);
    } catch (error: any) {
      res.status(500).json({ error: error.message || 'Waterfall pipeline failed' });
    }
  }
}



// ==========================================
// File: ./backend/src/services/waterfallService.ts
// ==========================================
import { GeminiService } from './geminiService';
import { OllamaService } from './ollamaService';

export class WaterfallService {
  private geminiService: GeminiService;
  private ollamaService: OllamaService;

  constructor() {
    this.geminiService = new GeminiService();
    this.ollamaService = new OllamaService();
  }

  async runWaterfallPipeline(userPrompt: string, globalProvider: string = 'auto') {
    console.log('[Waterfall] Pipeline Initiated. Global Provider:', globalProvider);
    
    let architectResponse: string;

    if (globalProvider === 'local') {
      console.log('[Waterfall] Phase 1: Architect (Local: DeepSeek-R1)');
      const res = await this.ollamaService.generateChatCompletion('deepseek-r1:8b', [
        { 
          role: 'user', 
          content: `Act as an AI Project Lead. Analyze requirements and output a detailed LOGIC block.
          Requirements: ${userPrompt}
          Format: ### ðŸ§  LOGIC\n[Plan]`
        }
      ]);
      architectResponse = res.message.content;
    } else {
      console.log('[Waterfall] Phase 1: Architect (Cloud: Gemini)');
      const architectPrompt = [
        {
          role: 'user',
          content: `Act as an AI Project Lead. Analyze the following requirements and output a detailed LOGIC block for implementation.
          
          Requirements: ${userPrompt}
          
          Output format:
          ### ðŸ§  LOGIC
          [Your technical logic and step-by-step plan here]`
        }
      ];
      try {
        architectResponse = await this.geminiService.generateChatCompletion(architectPrompt, 'gemini-3-pro-preview', false);
      } catch (error: any) {
        console.warn(`[Waterfall] Phase 1: Gemini Failed (${error.message}). Falling back to Local (DeepSeek-R1).`);
        const res = await this.ollamaService.generateChatCompletion('deepseek-r1:8b', architectPrompt);
        architectResponse = res.message.content;
      }
    }
    
    // Extract Logic Block
    const logicMatch = architectResponse.match(/### ðŸ§  LOGIC([\s\S]*)/);
    const logicBlock = logicMatch ? logicMatch[1].trim() : architectResponse;

    console.log('[Waterfall] Phase 2: Reasoner (DeepSeek-R1)');
    const reasonerPrompt = `Refine this implementation logic into a step-by-step technical plan: 

 ${logicBlock}`;
    
    let refinedPlan;
    try {
        const reasonerResponse = await this.ollamaService.generateChatCompletion('deepseek-r1:8b', [
          { role: 'user', content: reasonerPrompt }
        ]);
        refinedPlan = reasonerResponse.message.content;
    } catch (error: any) {
        console.warn(`[Waterfall] Phase 2: Local Failed (${error.message}). Falling back to Cloud (Gemini).`);
        refinedPlan = await this.geminiService.generateChatCompletion([
            { role: 'user', content: `[SYSTEM: DEEP REASONING] You are acting as a reasoning engine. ${reasonerPrompt}` }
        ], 'gemini-3-pro-preview', false);
    }

    console.log('[Waterfall] Phase 3: Executor (Qwen-Coder)');
    const executorPrompt = `Based on this technical plan, generate the final production-ready code: 

 ${refinedPlan}`;
    
    let generatedCode;
    try {
        const executorResponse = await this.ollamaService.generateChatCompletion('qwen2.5-coder:7b', [
          { role: 'user', content: executorPrompt }
        ]);
        generatedCode = executorResponse.message.content;
    } catch (error: any) {
        console.warn(`[Waterfall] Phase 3: Local Failed (${error.message}). Falling back to Cloud (Gemini).`);
        generatedCode = await this.geminiService.generateChatCompletion([
            { role: 'user', content: `[SYSTEM: CODE GENERATION] You are an expert software architect. ${executorPrompt}` }
        ], 'gemini-3-pro-preview', false);
    }

    console.log('[Waterfall] Phase 4: Senior Review (Gemini)');
    const reviewPrompt = [
      {
        role: 'user',
        content: `Perform a Senior Architect Review on the following code. 
        Plan: ${refinedPlan}
        Code: ${generatedCode}
        
        Check for:
        1. Security vulnerabilities.
        2. Performance bottlenecks.
        3. Alignment with the original plan.
        
        Provide a concise diagnostic report.`
      }
    ];

    let reviewResponse;
    try {
        reviewResponse = await this.geminiService.generateChatCompletion(reviewPrompt, 'gemini-3-pro-preview', false);
    } catch (error: any) {
        console.warn(`[Waterfall] Phase 4: Gemini Failed (${error.message}). Falling back to Local (Qwen-Coder).`);
        const res = await this.ollamaService.generateChatCompletion('qwen2.5-coder:7b', reviewPrompt);
        reviewResponse = res.message.content;
    }

    return {
      architect: architectResponse,
      reasoner: refinedPlan,
      executor: generatedCode,
      review: reviewResponse
    };
  }
}



// ==========================================
// File: ./backend/src/services/fileService.ts
// ==========================================
import fs from 'fs/promises';
import path from 'path';
// Use require for pdf-parse to avoid TS type issues and call-signature errors in CJS
const pdf = require('pdf-parse');
import mammoth from 'mammoth';
import { fileURLToPath } from 'url';

// const __filename = fileURLToPath(import.meta.url);
// const __dirname = path.dirname(__filename);

export class FileService {
  private uploadDir: string;

  constructor() {
    this.uploadDir = path.join(__dirname, '../../uploads');
  }

  async ensureUploadDir() {
    try {
      await fs.access(this.uploadDir);
    } catch {
      await fs.mkdir(this.uploadDir, { recursive: true });
    }
  }

  getUploadDir() {
    return this.uploadDir;
  }

  async extractText(filePath: string, mimeType: string, originalName: string): Promise<string> {
    try {
      const ext = path.extname(originalName).toLowerCase();
      
      if (mimeType === 'application/pdf' || ext === '.pdf') {
        const dataBuffer = await fs.readFile(filePath);
        const data = await pdf(dataBuffer);
        return data.text;
      } 
      
      if (mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || ext === '.docx') {
        const result = await mammoth.extractRawText({ path: filePath });
        return result.value;
      }

      const codeExtensions = [
        '.txt', '.md', '.json', '.js', '.jsx', '.ts', '.tsx', 
        '.css', '.html', '.py', '.java', '.c', '.cpp', '.h', 
        '.sql', '.yaml', '.yml', '.xml', '.env', '.gitignore', 
        '.ini', '.conf', '.sh', '.bat'
      ];
      
      if (codeExtensions.includes(ext) || mimeType.startsWith('text/')) {
        return await fs.readFile(filePath, 'utf-8');
      }

      return "";
    } catch (error) {
      console.error("[FileService] Text extraction failed:", error);
      return "";
    }
  }

  async listFiles() {
    try {
      await this.ensureUploadDir();
      const files = await fs.readdir(this.uploadDir);
      
      const fileInfos = await Promise.all(files.map(async (file) => {
        const filePath = path.join(this.uploadDir, file);
        const stats = await fs.stat(filePath);
        return {
          name: file,
          size: stats.size,
          createdAt: stats.birthtime,
          url: `/files/${file}` // Relative URL, frontend can prepend base
        };
      }));

      return fileInfos.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
    } catch (error) {
      console.error("[FileService] Listing files failed:", error);
      throw error;
    }
  }

  async deleteFile(fileName: string) {
    const filePath = path.join(this.uploadDir, fileName);
    await fs.unlink(filePath);
  }
}

export const fileService = new FileService();



// ==========================================
// File: ./backend/src/services/searchService.ts
// ==========================================
import axios from 'axios';

export interface SearchResult {
  title: string;
  link: string;
  snippet: string;
  source: string;
}

export class SearchService {
  private apiKey: string;

  constructor() {
    this.apiKey = process.env.SERPER_API_KEY || '';
  }

  async search(query: string): Promise<SearchResult[]> {
    if (!this.apiKey) {
      console.warn('Serper API key not provided. Search will be skipped.');
      return [];
    }

    try {
      const response = await axios.post('https://google.serper.dev/search', {
        q: query,
        num: 5
      }, {
        headers: {
          'X-API-KEY': this.apiKey,
          'Content-Type': 'application/json'
        }
      });

      return (response.data.organic || []).map((item: any) => ({
        title: item.title,
        link: item.link,
        snippet: item.snippet,
        source: new URL(item.link).hostname
      }));
    } catch (error) {
      console.error('Search error:', error);
      return [];
    }
  }
}



// ==========================================
// File: ./backend/src/services/ollamaService.ts
// ==========================================
import ollama from 'ollama';

export class OllamaService {
  async generateChatCompletion(model: string, messages: any[], temperature: number = 0.7, maxTokens: number = 2048) {
    const response = await ollama.chat({
      model,
      messages: messages.map(m => {
        const msg: any = { role: m.role, content: m.content };
        if (m.image) {
          // Extract base64 from data URL
          const matches = m.image.match(/^data:(.+);base64,(.+)$/);
          if (matches) {
            msg.images = [matches[2]];
          }
        }
        return msg;
      }),
      stream: false,
      options: {
        temperature,
        num_predict: maxTokens
      }
    });
    return response;
  }

  async listModels() {
    return await ollama.list();
  }

  async *generateChatStream(model: string, messages: any[], temperature: number = 0.7, maxTokens: number = 2048) {
    const response = await ollama.chat({
      model,
      messages: messages.map(m => {
        const msg: any = { role: m.role, content: m.content };
        if (m.image) {
          // Extract base64 from data URL
          const matches = m.image.match(/^data:(.+);base64,(.+)$/);
          if (matches) {
            msg.images = [matches[2]];
          }
        }
        return msg;
      }),
      stream: true,
      options: {
        temperature,
        num_predict: maxTokens
      }
    });

    for await (const part of response) {
      yield part.message.content;
    }
  }
}


// ==========================================
// File: ./backend/src/services/geminiService.ts
// ==========================================
import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from '@google/generative-ai';
import dotenv from 'dotenv';
import path from 'path';

export class GeminiService {
  private genAI: GoogleGenerativeAI;

  constructor() {
    dotenv.config({ path: path.resolve(__dirname, '../../.env') });
    const apiKey = process.env.GEMINI_API_KEY || '';
    if (!apiKey) {
      console.error('[GeminiService] CRITICAL: GEMINI_API_KEY is not defined.');
    }
    this.genAI = new GoogleGenerativeAI(apiKey);
  }

  async generateChatCompletion(messages: any[], modelName: string, shouldSearch: boolean, temperature: number = 0.7, maxTokens: number = 2048) {
    const tools: any[] = [];
    if (shouldSearch) {
      tools.push({ googleSearch: {} });
    }

    const model = this.genAI.getGenerativeModel({ 
      model: modelName,
      tools,
      generationConfig: {
        temperature,
        maxOutputTokens: maxTokens,
      }
    });

    const history = messages.slice(0, -1).map(m => ({
      role: m.role === 'user' ? 'user' : 'model',
      parts: [{ text: m.content }]
    }));

    const chat = model.startChat({ history });
    const lastMessage = messages[messages.length - 1].content;
    const result = await chat.sendMessage(lastMessage);
    const response = await result.response;
    return response.text();
  }

  async *generateChatStream(messages: any[], modelName: string, shouldSearch: boolean, temperature: number = 0.7, maxTokens: number = 2048) {
    const tools: any[] = [];
    if (shouldSearch) {
      tools.push({ googleSearch: {} });
    }

    const model = this.genAI.getGenerativeModel({ 
      model: modelName,
      tools,
      generationConfig: {
        temperature,
        maxOutputTokens: maxTokens,
      }
    });

    const history = messages.slice(0, -1).map(m => ({
      role: m.role === 'user' ? 'user' : 'model',
      parts: [{ text: m.content }]
    }));

    const chat = model.startChat({ history });
    const lastMessage = messages[messages.length - 1].content;
    const result = await chat.sendMessageStream(lastMessage);

    for await (const chunk of result.stream) {
      yield chunk.text();
    }
  }

  async generateImage(prompt: string, modelName: string = 'gemini-3-flash-preview') {
    const model = this.genAI.getGenerativeModel({ model: modelName });
    const fullPrompt = `Generate an image based on this description: ${prompt}. Return ONLY the image.`;
    const result = await model.generateContent(fullPrompt);
    const response = await result.response;
    const parts = response.candidates?.[0]?.content?.parts;
    const imagePart = parts?.find(part => part.inlineData);
    
    if (imagePart && imagePart.inlineData) {
      return {
        base64: imagePart.inlineData.data,
        mimeType: imagePart.inlineData.mimeType
      };
    }
    throw new Error('No image was generated in the response.');
  }

  async generateVisionContent(prompt: string, imageParts: any[], modelName: string, temperature: number = 0.7, maxTokens: number = 2048) {
    const model = this.genAI.getGenerativeModel({ 
      model: modelName || 'gemini-1.5-flash',
      generationConfig: {
        temperature,
        maxOutputTokens: maxTokens,
      }
    });
    const result = await model.generateContent([prompt, ...imageParts]);
    const response = await result.response;
    return response.text();
  }
}


// ==========================================
// File: ./backend/src/services/openRouterService.ts
// ==========================================
import axios from 'axios';
import dotenv from 'dotenv';
import path from 'path';

export class OpenRouterService {
  private apiKey: string;
  private baseUrl: string = 'https://openrouter.ai/api/v1';

  constructor() {
    dotenv.config({ path: path.resolve(__dirname, '../../.env') });
    this.apiKey = process.env.OPENROUTER_API_KEY || '';
    if (!this.apiKey) {
      console.warn('[OpenRouterService] Warning: OPENROUTER_API_KEY is not defined.');
    }
  }

  async generateChatCompletion(
    messages: any[], 
    model: string = 'qwen/qwen-2.5-coder-32b-instruct:free', 
    temperature: number = 0.7, 
    maxTokens: number = 2048
  ) {
    if (!this.apiKey) {
      throw new Error('OpenRouter API Key missing');
    }

    try {
      const response = await axios.post(
        `${this.baseUrl}/chat/completions`,
        {
          model,
          messages,
          temperature,
          max_tokens: maxTokens,
        },
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'HTTP-Referer': 'https://github.com/solvent-ai', // Placeholder
            'X-Title': 'Solvent AI Desktop',
            'Content-Type': 'application/json',
          },
        }
      );

      return {
        content: response.data.choices[0].message.content,
        model: response.data.model,
        usage: response.data.usage
      };
    } catch (error: any) {
      console.error('[OpenRouter] API Request Failed:', error.response?.data || error.message);
      throw new Error(error.response?.data?.error?.message || 'OpenRouter API failed');
    }
  }
}



// ==========================================
// File: ./backend/src/services/aiService.ts
// ==========================================
import { GeminiService } from './geminiService';
import { OllamaService } from './ollamaService';
import { OpenRouterService } from './openRouterService';
import { SearchService } from './searchService';
import { DeepSeekService } from './deepseekService';
import { WaterfallService } from './waterfallService';
import { v4 as uuidv4 } from 'uuid';
import path from 'path';
import fs from 'fs/promises';
import { fileURLToPath } from 'url';

// const __filename = fileURLToPath(import.meta.url);
// const __dirname = path.dirname(__filename);

export class AIService {
  private geminiService = new GeminiService();
  private ollamaService = new OllamaService();
  private openRouterService = new OpenRouterService();
  private searchService = new SearchService();
  private deepseekService = new DeepSeekService();
  private waterfallService = new WaterfallService();

  async processChat(data: any) {
    const { provider, model, messages, image, mode, smartRouter, fallbackModel, temperature, maxTokens, deviceInfo, notepadContent } = data;
    const isSmartRouterEnabled = smartRouter !== false;
    let lastMessage = messages[messages.length - 1].content;

    // 1. Mode Pre-processing
    if (mode === 'browser' || mode === 'scholarly') {
      lastMessage = await this.enrichWithSearch(lastMessage, mode);
    } else if (mode === 'deep_thought') {
      lastMessage = `[SYSTEM: DEEP THOUGHT] Reasoning inside <thinking> tags.

User: ${lastMessage}`;
    } else if (mode === 'analysis') {
      lastMessage = `[SYSTEM: ANALYSIS] Provide knowledge graph <graph_data>{...}</graph_data>

User: ${lastMessage}`;
    }

    let globalFormatting = `[SYSTEM: FORMATTING] Use Bold for key concepts. Double space sections.

`;

    if (notepadContent) {
      globalFormatting += `[SYSTEM: NOTEPAD]
Current User Notes:
"""
${notepadContent}
"""
You can see these notes and use them for context. If you need to update or add to these notes, wrap the ENTIRE new content of the notepad in <update_notepad>...</update_notepad> tags at the end of your response.

`;
    }

    if (deviceInfo) {
      const deviceType = deviceInfo.isMobile ? 'Mobile' : (deviceInfo.isTablet ? 'Tablet' : 'Desktop');
      globalFormatting += `[SYSTEM: ENVIRONMENT] User is on ${deviceType} (${deviceInfo.windowSize.width}x${deviceInfo.windowSize.height}). Optimize output for this screen size.

`;
    }

    lastMessage = globalFormatting + lastMessage;
    const updatedMessages = [...messages];
    updatedMessages[updatedMessages.length - 1].content = lastMessage;

    // 2. Execution with Fallback Logic
    if (provider === 'gemini') {
      return this.handleGeminiChat(updatedMessages, model, image, mode, isSmartRouterEnabled, fallbackModel, temperature, maxTokens);
    } else if (provider === 'ollama') {
      const response = await this.ollamaService.generateChatCompletion(model, updatedMessages, temperature, maxTokens);
      return { response: response.message.content, model };
    } else if (provider === 'deepseek') {
      const response = await this.deepseekService.generateChatCompletion(updatedMessages, model, temperature, maxTokens);
      return { response, model };
    } else if (provider === 'openrouter') {
      const response = await this.openRouterService.generateChatCompletion(updatedMessages, model, temperature, maxTokens);
      return { response: response.content, model };
    }
    
    throw new Error(`Unsupported provider: ${provider}`);
  }

  private async enrichWithSearch(query: string, mode: string) {
    try {
      const results = await this.searchService.search(query);
      if (results.length === 0) return query;
      const context = results.map(r => `[${r.source}] ${r.title}: ${r.snippet}`).join('\n\n');
      const systemPrompt = mode === 'scholarly' ? "[SYSTEM: RESEARCH]" : "[SYSTEM: WEB]";
      return `${systemPrompt}\n\nContext:\n${context}\n\nQuery: ${query}`;
    } catch (e) {
      console.warn("Search enrichment failed:", e);
      return query;
    }
  }

  private async handleGeminiChat(messages: any[], model: string, image: any, mode: any, shouldSearch: boolean, fallbackModel: any, temp: any, maxTokens: any) {
    const GEMINI_CHAIN = ['gemini-3-pro-preview', 'gemini-3-flash-preview', 'gemini-2.0-flash', 'gemini-flash-latest'];
    const modelChain = GEMINI_CHAIN.includes(model) ? [model, ...GEMINI_CHAIN.filter(m => m !== model)] : [model, ...GEMINI_CHAIN];

    try {
      if (image || mode === 'vision') {
        const targetImage = image || messages.find(m => m.image)?.image;
        if (!targetImage) throw new Error('No image for vision mode.');
        const matches = targetImage.match(/^data:(.+);base64,(.+)$/);
        if (!matches) throw new Error('Invalid image format.');
        const response = await this.geminiService.generateVisionContent(messages[messages.length - 1].content, [{ inlineData: { data: matches[2], mimeType: matches[1] } }], model, temp, maxTokens);
        return { response, model };
      }

      for (const currentModel of modelChain) {
        try {
          const response = await this.geminiService.generateChatCompletion(messages, currentModel, shouldSearch, temp, maxTokens);
          return { response, model: currentModel };
        } catch (err) {
          console.warn(`Gemini ${currentModel} failed:`, err);
        }
      }
      throw new Error('Gemini chain exhausted.');
    } catch (e: any) {
      console.error("Gemini failed, initiating fallback protocols:", e.message);
      
      // 1. Try OpenRouter (Free Cloud Fallback)
      try {
        console.log("Attempting OpenRouter fallback (Qwen Coder)...");
        const orResponse = await this.openRouterService.generateChatCompletion(messages, 'qwen/qwen-2.5-coder-32b-instruct:free', temp, maxTokens);
        return { response: orResponse.content, model: orResponse.model, info: 'OpenRouter fallback engaged.' };
      } catch (orError: any) {
        console.warn("OpenRouter fallback failed:", orError.message);
        
        // 2. Try Local Ollama (Hardware Fallback)
        try {
           console.log("Attempting Local Ollama fallback...");
           const localModel = fallbackModel || (mode === 'vision' ? 'llama3.2-vision' : 'qwen2.5:3b');
           const response = await this.ollamaService.generateChatCompletion(localModel, messages, temp, maxTokens);
           return { response: response.message.content, model: localModel, info: 'Local fallback engaged.' };
        } catch (ollamaError: any) {
           throw new Error(`All providers exhausted. Gemini: ${e.message}, OpenRouter: ${orError.message}, Ollama: ${ollamaError.message}`);
        }
      }
    }
  }

  async generateImage(prompt: string, model?: string, host?: string, protocol?: string) {
    const result = await this.geminiService.generateImage(prompt, model || 'gemini-3-flash-preview');
    const fileName = `generated_${uuidv4()}.png`;
    const dir = path.join(__dirname, '../../generated_images');
    await fs.mkdir(dir, { recursive: true });
    await fs.writeFile(path.join(dir, fileName), Buffer.from(result.base64, 'base64'));
    return { imageUrl: `/generated_images/${fileName}`, fileName };
  }

  async compareModels(messages: any[]) {
    const [geminiRes, ollamaRes] = await Promise.allSettled([
      this.geminiService.generateChatCompletion(messages, 'gemini-3-flash-preview', false),
      this.ollamaService.generateChatCompletion('qwen2.5:3b', messages)
    ]);
    return {
      gemini: geminiRes.status === 'fulfilled' ? geminiRes.value : 'Gemini error.',
      ollama: ollamaRes.status === 'fulfilled' ? (ollamaRes.value as any).message.content : 'Ollama error.'
    };
  }

  async listAvailableModels() {
    let ollamaModels: any = { models: [] };
    try { ollamaModels = await this.ollamaService.listModels(); } catch (e) {}
    return {
      ollama: ollamaModels.models || [],
      gemini: ['gemini-3-pro-preview', 'gemini-3-flash-preview', 'gemini-flash-latest', 'gemini-1.5-pro'],
      deepseek: ['deepseek-chat', 'deepseek-coder'],
      openrouter: ['qwen/qwen-2.5-coder-32b-instruct:free', 'google/gemini-2.0-pro-exp-02-05:free', 'deepseek/deepseek-r1:free']
    };
  }

  async runWaterfall(prompt: string, globalProvider?: string) {
    return this.waterfallService.runWaterfallPipeline(prompt, globalProvider);
  }
}

export const aiService = new AIService();



// ==========================================
// File: ./backend/src/services/deepseekService.ts
// ==========================================
import axios from 'axios';
import dotenv from 'dotenv';

export class DeepSeekService {
  private apiKey: string;
  private baseUrl: string = 'https://api.deepseek.com';

  constructor() {
    dotenv.config({ path: '/home/kaust/solvent-ai/.env' });
    this.apiKey = process.env.DEEPSEEK_API_KEY || '';
  }

  async generateChatCompletion(messages: any[], model: string, temperature: number = 0.7, maxTokens: number = 2048) {
    if (!this.apiKey) {
      throw new Error('DeepSeek API key not provided.');
    }

    try {
      const response = await axios.post(`${this.baseUrl}/chat/completions`, {
        model: model || 'deepseek-chat',
        messages: messages.map(m => ({
          role: m.role,
          content: m.content
        })),
        temperature,
        max_tokens: maxTokens
      }, {
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
          'Content-Type': 'application/json'
        }
      });

      return response.data.choices[0].message.content;
    } catch (error: any) {
      console.error('DeepSeek Error:', error.response?.data || error.message);
      throw new Error(error.response?.data?.error?.message || 'DeepSeek API call failed');
    }
  }
}



// ==========================================
// File: ./backend/package.json
// ==========================================
{
  "name": "solvent-ai-backend",
  "version": "1.0.0",
  "description": "",
  "main": "dist/server.js",
  "scripts": {
    "start": "node dist/server.js",
    "dev": "tsx watch src/server.ts",
    "desktop": "cd .. && npm run desktop",
    "build": "tsc"
  },
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "axios": "^1.6.8",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "mammoth": "^1.11.0",
    "multer": "^2.0.2",
    "ollama": "^0.5.0",
    "pdf-parse": "^2.4.5",
    "uuid": "^13.0.0",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/multer": "^2.0.0",
    "@types/node": "^20.12.7",
    "@types/uuid": "^10.0.0",
    "ts-node-dev": "^2.0.0",
    "tsx": "^4.21.0",
    "typescript": "^5.4.5"
  }
}



// ==========================================
// File: ./backend/tsconfig.json
// ==========================================
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"]
}



// ==========================================
// File: ./electron/main.ts
// ==========================================
import { app, BrowserWindow, shell, ipcMain, session } from 'electron';
import path from 'path';
import fs from 'fs';
import { ModelManager } from './ModelManager';

// SILENCE SECURITY WARNINGS: 'unsafe-eval' is required by Vite in dev mode. 
// This disables the noisy console warning about it.
process.env.ELECTRON_DISABLE_SECURITY_WARNINGS = 'true';

// DISABLE GPU: This ensures Solvent runs on any machine, even old ones.
app.disableHardwareAcceleration();
// Force software rendering (Linux Fix)
app.commandLine.appendSwitch('disable-gpu');
app.commandLine.appendSwitch('disable-gpu-compositing');

async function createWindow() {
  // Clear cache to ensure fresh frontend code is loaded
  await session.defaultSession.clearCache();

  const mainWindow = new BrowserWindow({
    width: 1300,
    height: 900,
    frame: false, // Custom frame for all platforms
    titleBarStyle: 'hidden', // Standard hidden for custom controls
    backgroundColor: '#050508', // Matches your theme
    show: false, // Prevents white flash
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      // CRITICAL: This allows the PiP window to share the same JS context
      // @ts-ignore
      nativeWindowOpen: true, 
      devTools: true,
      contextIsolation: true,
      nodeIntegration: false
    },
  });

  // Window Controls
  ipcMain.on('window-minimize', () => mainWindow.minimize());
  ipcMain.on('window-maximize', () => {
    if (mainWindow.isMaximized()) {
      mainWindow.unmaximize();
    } else {
      mainWindow.maximize();
    }
  });
  ipcMain.on('window-close', () => mainWindow.close());

  // Handle links
  mainWindow.webContents.setWindowOpenHandler(({ url }) => {
    if (url.startsWith('https:')) {
      shell.openExternal(url);
      return { action: 'deny' };
    }
    // Allow the PiP window to open
    return { 
      action: 'allow',
      overrideBrowserWindowOptions: {
        alwaysOnTop: true,
        frame: false,
        backgroundColor: '#020617',
        webPreferences: {
          nodeIntegration: false,
          contextIsolation: true,
        }
      }
    };
  });

  // --- Notepad "Agentic Sync" Logic ---
  const NOTES_FILE = path.join(__dirname, '../../.solvent_notes.md');
  let notepadBuffer = "";

  // --- Supervisor "Context Engine" Logic ---
  let active_mission_context: any = {
    mission_id: Date.now(),
    goal: "User initiated session",
    actions: [],
    status: "idle"
  };
  const globalHistory: any[] = [];

  // 1. Listen for Actions from Renderer (The "Flight Recorder")
  ipcMain.on('report-activity', (event, activity) => {
    const entry = { ...activity, timestamp: Date.now() };
    globalHistory.push(entry);
    active_mission_context.actions.push(entry);
    
    // Broadcast to ALL windows (Main + PiP Supervisor Tab)
    BrowserWindow.getAllWindows().forEach(win => {
      win.webContents.send('supervisor-new-data', entry);
    });

    // "Reflection" Pattern: Check for discrepancy (Mock Logic)
    if (active_mission_context.actions.length % 5 === 0) {
       mainWindow.webContents.send('supervisor-nudge', {
          type: 'insight',
          message: "Supervisor: Analyzing progress... Logic flow looks consistent with mission goal."
       });
    }
  });

  ipcMain.on('log-action', (event, action) => {
    // Legacy support or internal alias
    ipcMain.emit('report-activity', event, action);
  });

  // 2. Allow Renderer to fetch context
  ipcMain.handle('get-mission-context', () => active_mission_context);

  // 3. Allow Renderer to set/reset mission
  ipcMain.on('set-mission-goal', (event, goal) => {
     active_mission_context = {
        mission_id: Date.now(),
        goal,
        actions: [],
        status: "active"
     };
  });

  // --- Model Manager Handlers ---
  ipcMain.handle('model:execute', async (_, tier, messages) => {
    return await ModelManager.execute(tier, messages);
  });
  ipcMain.handle('model:get-preference', (_, tier) => ModelManager.getPreference(tier));
  ipcMain.handle('model:set-preference', (_, tier, prefs) => ModelManager.setPreference(tier, prefs));
  ipcMain.handle('model:get-usage', () => ModelManager.getUsage());
  ipcMain.handle('model:reset-usage', () => ModelManager.resetUsage());

  // 1. Load initial state (Notepad)
  try {
    if (fs.existsSync(NOTES_FILE)) {
      notepadBuffer = fs.readFileSync(NOTES_FILE, 'utf-8');
    } else {
      fs.writeFileSync(NOTES_FILE, "");
    }
  } catch (e) {
    console.error("Failed to load notes:", e);
  }

  // 2. Handle updates from UI (Ghostwriter Step 1)
  ipcMain.on('sync-notepad-to-disk', (event, content) => {
    notepadBuffer = content;
    try {
      fs.writeFileSync(NOTES_FILE, content);
    } catch (e) {
      console.error("Failed to save notes:", e);
    }
  });

  // 3. Handle initial fetch from UI
  ipcMain.handle('get-notepad', () => notepadBuffer);

  // 4. Watch for external changes (Ghostwriter Step 2)
  let fsWait = false;
  fs.watch(NOTES_FILE, (eventType, filename) => {
    if (filename && eventType === 'change') {
      if (fsWait) return;
      fsWait = true;
      setTimeout(() => { fsWait = false; }, 100);

      try {
        const newContent = fs.readFileSync(NOTES_FILE, 'utf-8');
        if (newContent !== notepadBuffer) {
          notepadBuffer = newContent;
          // Push the update to ALL windows (Main + PiP)
          BrowserWindow.getAllWindows().forEach(win => {
            win.webContents.send('ai-updated-notepad', notepadBuffer);
          });
        }
      } catch (e) {
        console.error("Failed to sync external note changes:", e);
      }
    }
  });

  // Open DevTools for debugging
  mainWindow.webContents.openDevTools();

  // Robust loading: Retry connection until Vite is ready (fixes black screen on slow start)
  const loadWithRetry = (window: BrowserWindow, url: string) => {
    window.loadURL(url).catch((e) => {
      console.log(`Connection failed (${e.code}), retrying in 1s...`);
      setTimeout(() => loadWithRetry(window, url), 1000);
    });
  };

  loadWithRetry(mainWindow, 'http://localhost:5173');
  // fallback for production: mainWindow.loadFile(path.join(__dirname, '../frontend/dist/index.html'));

  mainWindow.once('ready-to-show', () => {
    mainWindow.maximize();
    mainWindow.show();
  });
}

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') app.quit();
});

app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) createWindow();
});



// ==========================================
// File: ./electron/ModelManager.ts
// ==========================================
import Store from 'electron-store';
import { net, BrowserWindow } from 'electron';

const store = new Store();

// Helper to calculate cost (rough estimation)
const calculateCost = (model: string, tokens: number) => {
  // Mock pricing logic
  if (model.includes('free') || model.includes('ollama')) return 0;
  if (model.includes('gpt-4') || model.includes('opus')) return (tokens / 1000) * 0.03;
  return (tokens / 1000) * 0.001; // Default cheap
};

const API = {
  call: async (modelStr: string, messages: any[]) => {
    // Parse provider/model from string "provider/model"
    let provider = 'gemini';
    let modelName = modelStr;

    if (modelStr.includes('/')) {
      [provider, modelName] = modelStr.split('/');
    } else if (modelStr.startsWith('gpt') || modelStr.startsWith('o1')) {
        provider = 'openrouter'; // Assume openrouter for openai models if not specified
    }

    // Adjust provider for backend compatibility
    if (provider === 'local') provider = 'ollama';

    const payload = {
      provider,
      model: modelName,
      messages,
      smartRouter: false // We are doing the routing here
    };

    // Use built-in fetch (Node 18+)
    const response = await fetch('http://localhost:3001/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const error: any = new Error(`API Error: ${response.statusText}`);
        error.status = response.status;
        // Try to parse body for more info
        try {
            const errBody = await response.json();
            if (errBody.error) error.message = errBody.error;
        } catch (e) {}
        throw error;
    }

    const data = await response.json();
    
    // Track usage (Mocking token count if not provided)
    const usage = (data.usage?.totalTokens || 100);
    ModelManager.trackUsage(modelStr, usage);

    return data;
  }
};

export const ModelManager = {
  // 1. Persistent Storage for Preferences
  getPreference: (tier: 'planner' | 'executor') => {
    return store.get(`model_prefs.${tier}`, {
      primary: tier === 'planner' ? 'openrouter/anthropic/claude-3-opus' : 'openrouter/google/gemini-2.0-flash-exp:free',
      fallback: 'ollama/llama3',
      autoShift: true
    }) as any;
  },

  setPreference: (tier: 'planner' | 'executor', prefs: any) => {
    store.set(`model_prefs.${tier}`, prefs);
  },

  // 2. The Execution Engine with Built-in Fallback
  execute: async (tier: 'planner' | 'executor', messages: any[]) => {
    const pref = ModelManager.getPreference(tier);
    
    try {
      // Primary Attempt
      console.log(`[ModelManager] Executing ${tier} with primary: ${pref.primary}`);
      const result = await API.call(pref.primary, messages);
      // Broadcast success (primary)
      BrowserWindow.getAllWindows().forEach(w => w.webContents.send('model-status', { status: 'primary', model: pref.primary }));
      return result;
    } catch (err: any) {
      if (pref.autoShift && ModelManager.isRecoverable(err)) {
        console.warn(`[ModelManager] Primary ${pref.primary} failed. Shifting to ${pref.fallback}`);
        // Broadcast failover
        BrowserWindow.getAllWindows().forEach(w => w.webContents.send('model-status', { status: 'fallback', model: pref.fallback }));
        return await API.call(pref.fallback, messages);
      }
      throw err;
    }
  },

  isRecoverable: (err: any) => {
    // 429 = Rate Limit, 503 = Service Down
    return [429, 503, 504].includes(err.status) || err.code === 'ECONNREFUSED';
  },

  // 3. Usage Tracking
  trackUsage: (model: string, tokens: number) => {
      const current = store.get('usage', { tokens: 0, cost: 0, requests: 0 }) as any;
      const cost = calculateCost(model, tokens);
      
      store.set('usage', {
          tokens: current.tokens + tokens,
          cost: current.cost + cost,
          requests: current.requests + 1
      });
  },

  getUsage: () => {
      return store.get('usage', { tokens: 0, cost: 0, requests: 0 });
  },
  
  // Reset usage (e.g. for "Top Up" simulation or daily reset)
  resetUsage: () => {
      store.set('usage', { tokens: 0, cost: 0, requests: 0 });
  }
};



// ==========================================
// File: ./electron/preload.ts
// ==========================================
import { contextBridge, ipcRenderer } from 'electron';

contextBridge.exposeInMainWorld('electron', {
  platform: process.platform,
  minimize: () => ipcRenderer.send('window-minimize'),
  maximize: () => ipcRenderer.send('window-maximize'),
  close: () => ipcRenderer.send('window-close'),
  // Notepad Agentic Sync
  saveNotepad: (content: string) => ipcRenderer.send('sync-notepad-to-disk', content),
  getNotepad: () => ipcRenderer.invoke('get-notepad'),
  onNotepadUpdated: (callback: (content: string) => void) => {
    const subscription = (_event: any, content: string) => callback(content);
    ipcRenderer.on('ai-updated-notepad', subscription);
    // Return a cleanup function
    return () => ipcRenderer.removeListener('ai-updated-notepad', subscription);
  },
  // Supervisor Agent
  reportActivity: (activity: any) => ipcRenderer.send('report-activity', activity),
  logAction: (action: any) => ipcRenderer.send('report-activity', action),
  setMissionGoal: (goal: string) => ipcRenderer.send('set-mission-goal', goal),
  getMissionContext: () => ipcRenderer.invoke('get-mission-context'),
  onSupervisorNudge: (callback: (nudge: any) => void) => {
    const subscription = (_event: any, nudge: any) => callback(nudge);
    ipcRenderer.on('supervisor-nudge', subscription);
    return () => ipcRenderer.removeListener('supervisor-nudge', subscription);
  },
  onSupervisorData: (callback: (data: any) => void) => {
    const subscription = (_event: any, data: any) => callback(data);
    ipcRenderer.on('supervisor-new-data', subscription);
    return () => ipcRenderer.removeListener('supervisor-new-data', subscription);
  },
  // Model Manager
  model: {
    execute: (tier: string, messages: any[]) => ipcRenderer.invoke('model:execute', tier, messages),
    getPreference: (tier: string) => ipcRenderer.invoke('model:get-preference', tier),
    setPreference: (tier: string, prefs: any) => ipcRenderer.invoke('model:set-preference', tier, prefs),
    getUsage: () => ipcRenderer.invoke('model:get-usage'),
    resetUsage: () => ipcRenderer.invoke('model:reset-usage'),
    onStatusChange: (callback: (status: any) => void) => {
        const subscription = (_event: any, status: any) => callback(status);
        ipcRenderer.on('model-status', subscription);
        return () => ipcRenderer.removeListener('model-status', subscription);
    }
  }
});



